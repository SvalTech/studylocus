(function(){const N=document.createElement("link").relList;if(N&&N.supports&&N.supports("modulepreload"))return;for(const q of document.querySelectorAll('link[rel="modulepreload"]'))o(q);new MutationObserver(q=>{for(const O of q)if(O.type==="childList")for(const ne of O.addedNodes)ne.tagName==="LINK"&&ne.rel==="modulepreload"&&o(ne)}).observe(document,{childList:!0,subtree:!0});function U(q){const O={};return q.integrity&&(O.integrity=q.integrity),q.referrerPolicy&&(O.referrerPolicy=q.referrerPolicy),q.crossOrigin==="use-credentials"?O.credentials="include":q.crossOrigin==="anonymous"?O.credentials="omit":O.credentials="same-origin",O}function o(q){if(q.ep)return;q.ep=!0;const O=U(q);fetch(q.href,O)}})();console.log("Kyu nahi ho rahi padhai?");function to(k,N){let U;return function(...o){clearTimeout(U),U=setTimeout(()=>k.apply(this,o),N)}}const oo={apiKey:"AIzaSyAO9ya8gHtVbMfxcnAAJrz6FdYWvIRqgBY",authDomain:"studydashboard-2a3eb.firebaseapp.com",projectId:"studydashboard-2a3eb",storageBucket:"studydashboard-2a3eb.firebasestorage.app",messagingSenderId:"79210973277",appId:"1:79210973277:web:cc0a5fa86729fd6d3f65b4",measurementId:"G-TE7Z0SR8L1",databaseURL:"https://studydashboard-2a3eb-default-rtdb.asia-southeast1.firebasedatabase.app"};firebase.initializeApp(oo);const we=firebase.auth(),Ne=firebase.firestore(),Tt=firebase.database();document.getElementById("online-users-badge");const kt=document.getElementById("online-count-text"),so=Tt.ref("connections");Tt.ref(".info/connected");function no(k){if(!k)return;const N=Date.now(),U=firebase.database().ref("connections").child(k.uid).child(N);firebase.database().ref(".info/connected").on("value",o=>{o.val()===!0&&(U.onDisconnect().remove(),U.set({joined:firebase.database.ServerValue.TIMESTAMP,name:k.displayName||"User"}))})}so.on("value",k=>{const N=Object.keys(k.val()||{}).length;window.innerWidth<640?kt.textContent=`${N} Active`:kt.textContent=`${N} Studying`});let P=null,Ct=null,se=null;document.addEventListener("DOMContentLoaded",()=>{const k={tests:"jeePartTests_v2",layout:"jeeDashboardLayout_v3",customCards:"jeeCustomCards_v3",settings:"jeeDashboardSettings_v3",mobileAlertDismissed:"jeeMobileAlertDismissed_v1",cardProps:"jeeCardProps_v2",pomodoroState:"jeePomodoroState_v1",timeLoggerState:"jeeTimeLoggerState_v1",studyLogs:"jeeStudyLogs_v1"},N={JEE:{January:{2026:"2026-01-21",2027:"2027-01-21",2028:"2028-01-21"},April:{2026:"2026-04-05",2027:"2027-04-05",2028:"2028-04-05"}},JEE_ADVANCED:{2026:"2026-05-17",2027:"2027-05-23",2028:"2028-05-21"},NEET:{2026:"2026-05-03",2027:"2027-05-02",2028:"2028-05-07"}},U=JSON.parse(localStorage.getItem(k.settings)),o={tests:JSON.parse(localStorage.getItem(k.tests))||{},customCards:JSON.parse(localStorage.getItem(k.customCards))||[{id:"default-todo",type:"todo",title:"My Tasks",content:[]},{id:"default-line-graph",type:"line-graph",title:"Mock Test Progress",content:[{name:"Test 1",marks:120,subjects:{chemistry:40,physics:60,maths:20},maxMarks:300},{name:"Test 2",marks:145,subjects:{chemistry:50,physics:70,maths:25},maxMarks:300},{name:"Test 3",marks:160,subjects:{chemistry:50,physics:80,maths:30},maxMarks:300}]},{id:"default-note",type:"note",title:"Welcome!",content:"Welcome to your new dashboard! You can drag, resize, and delete these cards. Add your own from the top right customise button. Best of luck in your journey! You can delete this card now."},{id:"default-study-logger",type:"time-logger",title:"Study Log",content:[]}],layout:JSON.parse(localStorage.getItem(k.layout))||["countdown","graph","default-todo","default-study-logger","default-note","default-line-graph","tests","quote","time"],settings:{theme:"default",font:"'Inter', sans-serif",bgUrl:"",examType:"JEE",examYear:"2026",jeeSession:"April",jeeShiftDate:"",youtubeTintEnabled:!0,youtubeBlurEnabled:!1,focusShieldEnabled:!1,ricedModeEnabled:!1,tickingSoundEnabled:!1,userSubjects:[],customExamName:"",customExamDate:"",streamlinedModeEnabled:!1,...U},cardProps:JSON.parse(localStorage.getItem(k.cardProps))||{graph:{colspan:2},"default-line-graph":{colspan:1},"default-study-logger":{colspan:1}},pomodoroState:JSON.parse(localStorage.getItem(k.pomodoroState))||{},timeLoggerState:JSON.parse(localStorage.getItem(k.timeLoggerState))||{},studyLogs:JSON.parse(localStorage.getItem(k.studyLogs))||{},chartInstances:{},activeTimer:{cardId:null,type:null,unfocusedTime:0,unfocusedStart:0},save(e){localStorage.setItem(k[e],JSON.stringify(this[e])),P&&(G("Saving..."),pe())},saveSettings(){localStorage.setItem(k.settings,JSON.stringify(this.settings)),P&&(G("Saving..."),pe())}},q=[{text:"The secret of getting ahead is getting started.",author:"Mark Twain"},{text:"Itâ€™s not whether you get knocked down, itâ€™s whether you get up.",author:"Vince Lombardi"},{text:"Success is the sum of small efforts, repeated day in and day out.",author:"Robert Collier"},{text:"The expert in anything was once a beginner.",author:"Helen Hayes"},{text:"Believe you can and you're halfway there.",author:"Theodore Roosevelt"},{text:"The difference between ordinary and extraordinary is that little extra.",author:"Jimmy Johnson"},{text:"A person who never made a mistake never tried anything new.",author:"Albert Einstein"},{text:"The harder I work, the luckier I get.",author:"Samuel Goldwyn"},{text:"Success is not final, failure is not fatal: it is the courage to continue that counts.",author:"Winston Churchill"},{text:"Strive for progress, not perfection.",author:"Unknown"},{text:"Genius is one percent inspiration and ninety-nine percent perspiration.",author:"Thomas A. Edison"},{text:"It does not matter how slowly you go as long as you do not stop.",author:"Confucius"},{text:"Doubt kills more dreams than failure ever will.",author:"Suzy Kassem"},{text:"Push yourself, because no one else is going to do it for you.",author:"Unknown"},{text:"If you want to shine like a sun, first burn like a sun.",author:"A. P. J. Abdul Kalam"},{text:"The important thing is not to stop questioning. Curiosity has its own reason for existing.",author:"Albert Einstein"},{text:"We are what we repeatedly do. Excellence, then, is not an act, but a habit.",author:"Aristotle"},{text:"The chapters you study today will decide the chapters of your life tomorrow.",author:"Unknown"},{text:"Your toughest competition is the person you were yesterday.",author:"Unknown"},{text:"Rank is just a number. Knowledge and skill are the real assets.",author:"Unknown"},{text:"Dream is not that which you see while sleeping it is something that does not let you sleep.",author:"A. P. J. Abdul Kalam"},{text:"Focus on the process, not the outcome. The right process will lead to the right outcome.",author:"Unknown"}],O=[{text:"Kyu nahi ho rahi padhai?",author:"Alakh Pandey"},{text:"System phaad denge!",author:"A wise man"},{text:"Physics is not a subject, it's an emotion.",author:"Alakh Pandey"},{text:"Aag laga denge!",author:"Revolutionaries"},{text:"Mehnat karta hu bhai",author:"Basava Reddy"}],ne=[{text:"Chaitanya is a noob ðŸ¤“",author:"Everyone"},{text:"I love Organic Chemistry ðŸ¤“",author:"Chaitanya (probably)"},{text:"Isomerism is my favorite topic ðŸ¤“",author:"Definitely Chaitanya"},{text:"Just like us guys ðŸ¤“",author:"Chaitanya the moron"}],l={body:document.body,mainTitle:document.getElementById("main-title"),mainTitleRiced:document.getElementById("main-title-riced"),dashboardGrid:document.getElementById("dashboard-grid"),authContainer:document.getElementById("auth-container"),authContainerRiced:document.getElementById("auth-container-riced"),syncStatusToast:document.getElementById("sync-status-toast"),modals:{addCard:document.getElementById("add-card-modal"),customize:document.getElementById("customize-modal"),info:document.getElementById("info-modal"),confirm:document.getElementById("confirm-modal")},buttons:{addCard:document.querySelectorAll(".add-card-btn"),cancelAddCard:document.getElementById("cancel-add-card"),customize:document.querySelectorAll(".customize-btn"),closeCustomize:document.getElementById("close-customize"),closeCustomizeIcon:document.getElementById("close-customize-icon-btn"),removeBg:document.getElementById("remove-bg-btn"),closeAlert:document.getElementById("close-alert-btn"),resetDashboard:document.getElementById("reset-dashboard-btn"),info:document.querySelectorAll(".info-btn"),closeInfo:document.getElementById("close-info-modal"),exportData:document.getElementById("export-data-btn"),importData:document.getElementById("import-data-btn"),confirmOk:document.getElementById("confirm-ok-btn"),confirmCancel:document.getElementById("confirm-cancel-btn"),zenModeBtn:document.querySelectorAll(".zen-mode-btn"),exitZenBtn:document.getElementById("exit-zen-btn"),godModeClose:document.getElementById("god-mode-close-btn"),addminutesformOpen:document.getElementById("toggle-manual-form")},forms:{newCard:document.getElementById("new-card-form")},inputs:{cardType:document.getElementById("new-card-type"),cardContent:document.getElementById("new-card-content"),theme:document.getElementById("theme-select"),font:document.getElementById("font-select"),bgUrl:document.getElementById("bg-image-url"),examType:document.getElementById("exam-type-select"),examYear:document.getElementById("exam-year-select"),importFile:document.getElementById("import-file-input"),youtubeTintToggle:document.getElementById("youtube-tint-toggle"),youtubeBlurToggle:document.getElementById("youtube-blur-toggle"),focusShieldToggle:document.getElementById("focus-shield-toggle"),ricedModeToggle:document.getElementById("riced-mode-toggle"),jeeSession:document.getElementById("jee-session-select"),jeeShift:document.getElementById("jee-shift-input"),jeeContainer:document.getElementById("jee-details-container"),customContainer:document.getElementById("custom-exam-container"),customName:document.getElementById("custom-exam-name"),customDate:document.getElementById("custom-exam-date"),tickingSoundToggle:document.getElementById("ticking-sound-toggle"),streamlinedModeToggle:document.getElementById("streamlined-mode-toggle")},mobileAlert:document.getElementById("mobile-alert"),confirmTitle:document.getElementById("confirm-title"),confirmMessage:document.getElementById("confirm-message"),godModePanel:document.getElementById("god-mode-panel")};l.buttons.addCard.forEach(e=>e.disabled=!0),l.dashboardGrid.style.pointerEvents="none",l.dashboardGrid.style.opacity="0.5";let Q=new Date,A=null,W=null,Oe=null;we.onAuthStateChanged(e=>{e?(P=e,Re(e),me()):(P=null,ge(),me())});const Lt=()=>{const e=new firebase.auth.GoogleAuthProvider;we.signInWithPopup(e).catch(t=>{console.error("Authentication Error:",t)})},It=()=>{se&&(se(),se=null),l.dashboardGrid.innerHTML="",sessionStorage.removeItem("cloud_data_loaded"),we.signOut()},me=()=>{l.buttons.addCard.forEach(e=>e.disabled=!1),l.dashboardGrid.style.pointerEvents="auto",l.dashboardGrid.style.opacity="1"},ge=()=>{const e=[l.authContainer,l.authContainerRiced],t='<svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>',s='<svg class="w-4 h-4" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M47.532 24.552c0-1.566-.14-3.084-.404-4.548H24.5v8.58h12.944c-.566 2.76-2.213 5.108-4.72 6.708v5.524h7.112c4.162-3.832 6.596-9.42 6.596-16.264z" fill="#4285F4"/><path d="M24.5 48c6.48 0 11.944-2.14 15.928-5.788l-7.112-5.524c-2.14 1.44-4.884 2.292-7.816 2.292-6.004 0-11.084-4.04-12.9-9.492H4.42v5.7c3.48 6.912 10.32 11.532 18.08 11.532l2 .28z" fill="#34A853"/><path d="M11.6 28.98c-.34-.996-.54-2.052-.54-3.144s.2-2.148.54-3.144V16.992H4.42C2.852 20.04 2 23.436 2 27.024c0 3.588.852 6.984 2.42 10.032l7.18-5.7v-.376z" fill="#FBBC05"/><path d="M24.5 9.8c3.516 0 6.66 1.212 9.128 3.54l6.32-6.32C36.44.88 30.98 0 24.5 0 16.74 0 9.9 4.62 6.42 11.532l7.18 5.7c1.816-5.452 6.896-9.432 12.9-9.432z" fill="#EA4335"/></svg>';e.forEach(n=>{if(n)if(P){const a=`
                    <div class="relative group" id="user-menu-container">
                        <button id="user-menu-button" title="User Menu" class="flex items-center justify-center rounded-full transition-transform active:scale-95 focus:outline-none">
                            <img src="${P.photoURL}" alt="User" class="w-8 h-8 rounded-full object-cover border border-transparent group-hover:border-[var(--border-color)] opacity-90 group-hover:opacity-100 transition-all" />
                        </button>

                        <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-56 origin-top-right transform transition-all duration-200 scale-95 opacity-0 invisible z-50">
                            <div class="card p-0 overflow-hidden shadow-xl ring-1 ring-black/5 backdrop-blur-xl">
                                
                                <div class="px-4 py-3 border-b border-[var(--border-color)] bg-white/5">
                                    <p class="text-sm font-semibold text-[var(--text-primary)] truncate">${P.displayName}</p>
                                    <p class="text-xs text-[var(--text-secondary)] truncate font-mono opacity-75">${P.email}</p>
                                </div>

                                <div class="p-1">
                                    <button id="sign-out-btn" class="w-full text-left flex items-center gap-2 px-3 py-2 text-xs font-medium text-[var(--text-secondary)] rounded hover:bg-white/10 hover:text-red-400 transition-colors">
                                        ${t}
                                        <span>Sign Out</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;n.innerHTML=a;const r=n.querySelector("#user-menu-button"),i=n.querySelector("#user-menu-dropdown"),d=n.querySelector("#sign-out-btn"),c=u=>{if(u.stopPropagation(),i.classList.contains("invisible")){i.classList.remove("invisible","opacity-0","scale-95"),i.classList.add("opacity-100","scale-100");const g=i.getBoundingClientRect(),v=window.innerWidth;if(g.right>v){const p=g.right-v+10;i.style.right=`${p}px`}else i.style.right="0px"}else i.classList.add("invisible","opacity-0","scale-95"),i.classList.remove("opacity-100","scale-100"),i.style.right=""};r.addEventListener("click",c),d.addEventListener("click",It),document.addEventListener("click",u=>{n.contains(u.target)||(i.classList.add("invisible","opacity-0","scale-95"),i.classList.remove("opacity-100","scale-100"))})}else{const a=`
                    <button id="sign-in-btn" class="flex items-center gap-2 px-3 py-1.5 rounded-md border border-[var(--border-color)] bg-transparent hover:bg-white/5 text-[var(--text-primary)] transition-all text-xs font-medium">
                        ${s}
                        <span class="opacity-90">Sign In</span>
                    </button>
                `;n.innerHTML=a,n.querySelector("#sign-in-btn").addEventListener("click",Lt)}})},pe=to(()=>{if(!P)return;console.log("Debounced save triggered..."),G("Saving...");const e=Ne.collection("users").doc(P.uid),t={};for(const s in k){const n=localStorage.getItem(k[s]);n&&(t[s]=JSON.parse(n))}e.set(t).then(()=>{console.log("Save successful."),G("All changes saved")}).catch(s=>{console.error("Firestore save error:",s),G("Sync Error")})},2e3),Mt=async e=>{const t={};for(const s in k){const n=k[s],a=localStorage.getItem(n);if(a)try{t[s]=JSON.parse(a)}catch{console.warn(`Failed to parse ${s} during migration.`)}}try{await e.set(t),console.log("Local data successfully migrated to cloud."),G("Data Migrated")}catch(s){console.error("Error migrating data to cloud:",s),G("Migration Failed")}},Re=async e=>{ge();const t=Ne.collection("users").doc(e.uid);try{(await t.get()).exists||(console.log("New user detected. Migrating local data to cloud..."),await Mt(t))}catch(s){console.error("Error checking user doc:",s)}se&&se(),se=t.onSnapshot(s=>{if(s.metadata.hasPendingWrites)return;const n=s.data();if(n){let a=!1;for(const r in k)if(n[r]){const i=JSON.stringify(o[r]),d=JSON.stringify(n[r]);i!==d&&(o[r]=n[r],localStorage.setItem(k[r],d),a=!0)}a&&(console.log("Cloud data merged. Re-rendering..."),F(),C(),G("Dashboard Updated"))}},s=>{console.error("Firestore snapshot error: ",s),P&&G("Sync Error")})},G=e=>{const t=l.syncStatusToast;clearTimeout(Ct),t.textContent=e,t.classList.add("show"),e!=="Saving..."&&e!=="Syncing..."&&(Ct=setTimeout(()=>{t.classList.remove("show")},2e3))};let J=null,ae=null;l.buttons.confirmCancel.addEventListener("click",()=>{typeof ae=="function"&&ae(),l.modals.confirm.classList.add("hidden"),J=null,ae=null}),l.buttons.confirmOk.addEventListener("click",()=>{typeof J=="function"&&J(),l.modals.confirm.classList.add("hidden"),J=null,ae=null}),we.onAuthStateChanged(e=>{e?(P=e,Re(e),no(e),me()):(P=null,ge(),me())});const He=document.getElementById("add-subject-btn");He&&He.addEventListener("click",Ye);const Fe=document.getElementById("new-subject-input");Fe&&Fe.addEventListener("keypress",e=>{e.key==="Enter"&&Ye()});const Ge=document.getElementById("subject-manager-list");Ge&&Ge.addEventListener("click",e=>{if(e.target.classList.contains("delete-subject-btn")){const t=parseInt(e.target.dataset.index);Dt(t)}}),l.buttons.customize.forEach(e=>e.addEventListener("click",()=>{he()}));function fe(e,t,s="Are you sure?"){l.confirmTitle.textContent=s,l.confirmMessage.textContent=e,J=t,l.modals.confirm.classList.remove("hidden")}const R=e=>{const t=e.getFullYear(),s=(e.getMonth()+1).toString().padStart(2,"0"),n=e.getDate().toString().padStart(2,"0");return`${t}-${s}-${n}`};function ze(){if(o.layout&&(o.layout=[...new Set(o.layout)]),o.customCards){const n=[],a=new Set;o.customCards.forEach(r=>{a.has(r.id)||(a.add(r.id),n.push(r))}),o.customCards=n}const e=o.customCards.filter(n=>n.type==="daily-tasks");if(e.length===0){const n={id:`custom-${Date.now()}-daily`,type:"daily-tasks",title:"Daily Schedule",content:{}};o.customCards.push(n),o.layout.push(n.id),console.log("Auto-created missing Daily Tasks card.")}else if(e.length>1){const n=e.slice(1).map(a=>a.id);o.customCards=o.customCards.filter(a=>!n.includes(a.id)),o.layout=o.layout.filter(a=>!n.includes(a)),console.warn("Removed duplicate Daily Tasks cards to prevent conflicts:",n)}const t=new Set(o.customCards.map(n=>n.id)),s=["countdown","time","graph","tests","quote"];o.layout=o.layout.filter(n=>t.has(n)||s.includes(n)),o.save("layout"),o.save("customCards")}const Ue=()=>{const{examType:e,examYear:t,jeeSession:s,jeeShiftDate:n,customExamDate:a}=o.settings;if(e==="Custom")return a?new Date(a+"T00:00:00"):new Date;if(e==="JEE"&&n)return new Date(n+"T00:00:00");if(e==="JEE"){const i=N.JEE[s]?.[t]||`${t}-01-01`;return new Date(i+"T00:00:00")}if(e==="JEE Advanced"){const i=N.JEE_ADVANCED?.[t]||`${t}-05-17`;return new Date(i+"T00:00:00")}const r=N.NEET[t]||`${t}-05-01`;return new Date(r+"T00:00:00")},Ee=e=>{const t=Math.floor(e/3600).toString().padStart(2,"0"),s=Math.floor(e%3600/60).toString().padStart(2,"0"),n=Math.floor(e%60).toString().padStart(2,"0");return`${t}:${s}:${n}`},re=e=>{const t=Math.floor(e/3600),s=Math.floor(e%3600/60);let n="";return t>0&&(n+=`${t}h `),(s>0||t>0)&&(n+=`${s}m`),n===""&&(n=e%60+"s"),n.trim()};function Je(){document.visibilityState==="visible"&&A&&A.close()}function ie(){if(!A||!W)return;const e=document.querySelector(`[data-card-id="${W}"] .timer-display`),t=A.document.getElementById("pip-timer");e&&t&&(t.textContent=e.textContent)}function le(){if(!A||!W)return;const e=o.timeLoggerState[W];if(!e)return;const t=A.document.getElementById("pip-start-pause-btn"),s=A.document.getElementById("pip-log-btn");t&&(t.textContent=e.isRunning?"Pause":"Start"),s&&(s.disabled=e.accumulatedTime<60)}const y={countdown:{templateId:"countdown-template",isDefault:!0,render:e=>{const t=Ue()-new Date,s=e.querySelector("#countdown-timer");if(t<=0){s&&(s.innerHTML=`
                            <div class="flex flex-col items-center justify-center h-full py-4">
                                <span class="text-4xl md:text-6xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-white to-[var(--accent-color)] drop-shadow-2xl animate-pulse select-none">
                                    IT'S TIME
                                </span>
                                
                                <div class="flex items-center gap-2 mt-2 opacity-80">
                                    <div class="h-[1px] w-8 bg-[var(--border-color)]"></div>
                                    <span class="text-xs md:text-sm text-[var(--text-secondary)] tracking-[0.3em] uppercase">
                                        So it begins ðŸ¥³ good luck!
                                    </span>
                                    <div class="h-[1px] w-8 bg-[var(--border-color)]"></div>
                                </div>
                            </div>
                        `);return}e.querySelector('[data-value="days"]')||s&&(s.innerHTML=`
                            <div><div data-value="days" class="font-bold">00</div><div class="text-xs sm:text-sm text-secondary">Days</div></div>
                            <div><div data-value="hours" class="font-bold">00</div><div class="text-xs sm:text-sm text-secondary">Hours</div></div>
                            <div><div data-value="minutes" class="font-bold">00</div><div class="text-xs sm:text-sm text-secondary">Minutes</div></div>
                        `),e.querySelector('[data-value="days"]').innerText=Math.floor(t/(1e3*60*60*24)).toString().padStart(2,"0"),e.querySelector('[data-value="hours"]').innerText=Math.floor(t/(1e3*60*60)%24).toString().padStart(2,"0"),e.querySelector('[data-value="minutes"]').innerText=Math.floor(t/(1e3*60)%60).toString().padStart(2,"0")}},time:{templateId:"time-template",isDefault:!0,render:e=>{const t=new Date;e.querySelector('[data-value="time"]').textContent=t.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0}),e.querySelector('[data-value="date"]').textContent=t.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}},graph:{templateId:"graph-template",isDefault:!0,render:e=>{const t=e.querySelector("#contribution-graph");t.innerHTML="";const s=document.createDocumentFragment(),n=new Date;n.setHours(0,0,0,0);const a=n.getTime(),r=new Date().getFullYear();let i=new Date(`${r}-01-01T00:00:00`);const d=Ue();d.setHours(0,0,0,0);const c=d.getTime();for(;i<=d;){const u=document.createElement("div"),m=document.createElement("span"),g=R(i),v=i.getTime();u.className="day",u.dataset.date=g,m.className="tooltip";let p="day-future",h=`<strong class="text-accent">${i.toDateString()}</strong>`;if(v<a?p="day-past":v===a&&(p="day-today",h+="<br/><span class='text-xs text-gray-400'>(Today)</span>"),o.tests[g]){p="day-part-test";const S=o.tests[g].split("|").map(L=>`â€¢ ${L.trim()}`).join("<br/>"),w=Math.ceil((v-a)/(1e3*60*60*24)),M=w>0?`${w} days left`:w<0?"Completed":"Today";h+=`<div class="mt-1 pt-1 border-t border-gray-700">${S}</div>`,h+=`<div class="text-[10px] text-gray-500 mt-1 italic">${M}</div>`}v===c&&(p="day-exam",h+="<br/>ðŸš¨ <strong>EXAM DAY</strong> ðŸš¨"),u.classList.add(p),m.innerHTML=h,u.appendChild(m),s.appendChild(u),i.setDate(i.getDate()+1)}t.appendChild(s)}},tests:{templateId:"tests-template",isDefault:!0,render:e=>{const t=e.querySelector("#test-list");t.innerHTML="";const s=Object.keys(o.tests).sort();s.length!==0?s.forEach(n=>{const a=document.createElement("li");a.className="flex justify-between items-center bg-gray-800 p-2 rounded-md",a.innerHTML=`<div class="flex flex-col"><span class="font-semibold text-sm">${o.tests[n]}</span><span class="text-xs text-secondary">${new Date(n+"T00:00:00").toDateString()}</span></div><button data-date="${n}" class="delete-test-btn text-red-500 hover:text-red-400 font-semibold text-xs">Delete</button>`,t.appendChild(a)}):t.innerHTML='<li class="text-secondary px-2 text-sm">No tests scheduled.</li>'}},quote:{templateId:"quote-template",isDefault:!0,render:e=>{let t=q;o.settings.theme==="alakh-pandey"&&(t=O),o.settings.theme==="chaitanya-noob"&&(t=ne);const{text:s,author:n}=t[Math.floor(Math.random()*t.length)];e.querySelector("#quote").textContent=`"${s}"`,e.querySelector("#author").textContent=`- ${n}`}},note:{templateId:"note-card-template",render:(e,t)=>{e.querySelector(".card-content").textContent=t.content}},todo:{templateId:"todo-card-template",render:(e,t)=>{const s=e.querySelector(".todo-list"),n=e.querySelector(".progress-bar"),a=e.querySelector(".progress-text");if(s.innerHTML="",new Sortable(s,{animation:150,ghostClass:"sortable-ghost",delay:100,delayOnTouchOnly:!0,onEnd:r=>{const i=t.content.splice(r.oldIndex,1)[0];t.content.splice(r.newIndex,0,i),o.save("customCards")}}),Array.isArray(t.content)){let r=0,i=0;t.content.length===0?s.innerHTML='<li class="text-secondary text-xs text-center py-6 opacity-60">No active tasks. Time to focus.</li>':t.content.forEach((c,u)=>{c.priority||(c.priority="medium"),c.status||(c.status=c.completed?"done":"todo"),c.subtasks||(c.subtasks=[]),r++,c.status==="done"&&i++;const g={high:{color:"text-red-300",bg:"bg-red-500/20",border:"border-red-500/20",label:"High"},medium:{color:"text-amber-200",bg:"bg-amber-500/20",border:"border-amber-500/20",label:"Medium"},low:{color:"text-blue-200",bg:"bg-blue-500/20",border:"border-blue-500/20",label:"Low"}}[c.priority],v={todo:'<div class="w-4 h-4 rounded-full border-[1.5px] border-gray-400 hover:border-white transition-colors"></div>',"in-progress":'<div class="w-4 h-4 rounded-full border-[1.5px] border-amber-400 flex items-center justify-center"><div class="w-1.5 h-1.5 bg-amber-400 rounded-full animate-pulse"></div></div>',done:'<div class="w-4 h-4 rounded-full bg-[var(--accent-color)] border border-[var(--accent-color)] flex items-center justify-center text-white"><svg width="10" height="8" viewBox="0 0 12 10" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5L4 8L11 1"/></svg></div>'},p=document.createElement("li");p.className="group mb-2 rounded-xl bg-white/5 hover:bg-white/10 transition-all overflow-hidden relative cursor-grab active:cursor-grabbing",p.dataset.index=u;const h=c.subtasks.map((M,L)=>`
                                <div class="flex items-center gap-3 py-1.5 pl-2 group/sub relative">
                                    <div class="absolute left-[-6px] top-1/2 w-2 h-px bg-gray-700"></div>
                                    <button class="toggle-subtask-btn w-3.5 h-3.5 flex-shrink-0 border border-gray-500 rounded flex items-center justify-center transition-colors ${M.completed?"bg-gray-500 border-gray-500":"hover:border-gray-300"}" data-sub-index="${L}">
                                        ${M.completed?'<svg class="w-2.5 h-2.5 text-white" viewBox="0 0 12 10" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 5L4 8L11 1"/></svg>':""}
                                    </button>
                                    <span class="text-xs ${M.completed?"line-through text-gray-500":"text-gray-300"} flex-grow break-all font-medium">${M.text}</span>
                                    <button class="delete-subtask-btn text-gray-500 hover:text-red-400 opacity-0 group-hover/sub:opacity-100 px-1.5 transition-opacity text-lg leading-none" data-sub-index="${L}">Ã—</button>
                                </div>
                            `).join("");p.innerHTML=`
                                <div class="flex items-start gap-3 p-3.5">
                                    <button class="status-btn mt-0.5 flex-shrink-0 transform active:scale-95 transition-transform" 
                                            data-tooltip="${c.status==="todo"?"Start Task":c.status==="in-progress"?"Complete":"Reset"}">
                                        ${v[c.status]}
                                    </button>
                                    
                                    <div class="flex-grow min-w-0 flex flex-col toggle-expand-btn cursor-pointer">
                                        <div class="flex items-center justify-between gap-2 pr-12">
                                            <span id="todo-text-${u}" class="text-sm font-semibold leading-tight transition-colors ${c.status==="done"?"line-through text-gray-500 decoration-gray-500":"text-gray-100 group-hover:text-white"}">
                                                ${c.text}
                                            </span>
                                        </div>
                                        
                                        <div class="flex items-center gap-2 mt-2">
                                            <button class="priority-btn text-[10px] font-bold tracking-wide px-2 py-0.5 rounded-full border ${g.border} ${g.color} ${g.bg} hover:brightness-125 transition-all uppercase"
                                                    data-tooltip="Priority: ${g.label}">
                                                ${g.label}
                                            </button>
                                            
                                            ${c.subtasks.length>0?`
                                                <span class="text-[10px] text-gray-400 font-medium flex items-center gap-1 bg-white/5 px-2 py-0.5 rounded-full">
                                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
                                                    ${c.subtasks.filter(M=>M.completed).length}/${c.subtasks.length}
                                                </span>
                                            `:""}
                                        </div>
                                    </div>

                                    <div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-black/40 rounded-lg backdrop-blur-sm shadow-sm">
                                        <button class="edit-todo-item text-gray-400 hover:text-blue-400 p-1.5 transition-colors" title="Edit">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                        </button>
                                        <button class="delete-todo-item text-gray-400 hover:text-red-400 p-1.5 transition-colors" title="Delete">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="subtasks-section ${c.expanded?"block":"hidden"} pl-10 pr-4 pb-3 border-t border-white/5 bg-black/20">
                                    <div class="space-y-0.5 mt-2">
                                        ${h}
                                    </div>
                                    <form class="add-subtask-form flex gap-2 mt-2 items-center opacity-70 hover:opacity-100 transition-opacity">
                                        <span class="text-gray-500 text-lg leading-none">+</span>
                                        <input type="text" placeholder="Add step..." class="bg-transparent border-none text-xs w-full focus:outline-none focus:placeholder-gray-400 placeholder-gray-600 text-gray-300 py-1 font-medium">
                                    </form>
                                </div>
                            `;const S=p.querySelector(".edit-todo-item"),w=p.querySelector(`#todo-text-${u}`);S.addEventListener("click",M=>{M.stopPropagation();const L=c.text,b=document.createElement("input");b.type="text",b.value=L,b.className="bg-transparent text-white text-sm font-semibold border-b border-accent-color focus:outline-none w-full",b.addEventListener("click",T=>T.stopPropagation()),b.addEventListener("dblclick",T=>T.stopPropagation()),w.replaceWith(b),b.focus();const x=()=>{const T=b.value.trim();T&&(c.text=T,o.save("customCards")),y.todo.render(e,t)};b.addEventListener("keydown",T=>{T.key==="Enter"?x():T.key==="Escape"&&y.todo.render(e,t)}),b.addEventListener("blur",x)}),s.appendChild(p)});const d=r>0?Math.round(i/r*100):0;n.style.width=`${d}%`,a.className="progress-text text-[10px] text-gray-400 font-bold",a.textContent=`${d}%`}}},"line-graph":{templateId:"line-graph-card-template",render:(e,t)=>{const s=e.querySelector(".marks-list");s.innerHTML="";let n=0,a=0,r=0,i=0;[...t.content].reverse().forEach((f,E)=>{const H=t.content.length-1-E,j=f.total??f.marks;n+=j,a++,j>r&&(r=j),E===0&&(i=j);const I=f.subjects||{},V=I.physics||0,Xt=I.chemistry||0,eo=I.maths||0,Ae=t.targetScore||0,Et=Ae>0?j>=Ae:!0,Pe=document.createElement("li");Pe.className="group flex flex-col bg-white/5 hover:bg-white/10 border border-transparent hover:border-gray-600 rounded-lg p-2 transition-all",Pe.innerHTML=`
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-sm text-white">${f.name}</span>
                                ${Et&&Ae>0?'<span class="text-[9px] bg-green-500/20 text-green-400 px-1.5 rounded">Hit</span>':""}
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold ${Et?"text-white":"text-yellow-500"}">${j}</span>
                                <span class="text-[10px] text-secondary">/${f.maxMarks}</span>
                                <button data-index="${H}" class="delete-mark-item opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-500 transition-opacity p-1 ml-1" aria-label="Delete">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex gap-1.5 mt-1">
                            <span class="subject-pill phy" title="Physics">P: ${V}</span>
                            <span class="subject-pill chem" title="Chemistry">C: ${Xt}</span>
                            <span class="subject-pill math" title="Maths">M: ${eo}</span>
                        </div>
                    `,s.appendChild(Pe)});const c=a>0?(n/a).toFixed(0):0;e.querySelector(".mean-score-display").textContent=c,e.querySelector(".max-score-display").textContent=r;const u=e.querySelector(".trend-display");if(a>0){const f=i-c;f>0?u.innerHTML=`<span class="text-green-400 flex items-center justify-center gap-1">â–² ${Math.abs(f).toFixed(0)}</span>`:f<0?u.innerHTML=`<span class="text-red-400 flex items-center justify-center gap-1">â–¼ ${Math.abs(f).toFixed(0)}</span>`:u.innerHTML='<span class="text-gray-400">~</span>'}else u.innerHTML="-";const m=e.querySelector(".toggle-add-marks-form"),g=e.querySelector(".add-marks-form"),v=m.cloneNode(!0);m.parentNode.replaceChild(v,m),v.addEventListener("click",()=>{g.classList.toggle("hidden");const f=g.classList.contains("hidden");v.innerHTML=f?'<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add Test Score':'<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> Cancel'});const p=e.querySelector(".target-score-input");p.value=t.targetScore||"";const h=p.cloneNode(!0);p.parentNode.replaceChild(h,p),h.addEventListener("change",f=>{const E=parseFloat(f.target.value);t.targetScore=isNaN(E)?0:E,o.save("customCards"),y["line-graph"].render(e,t)});const S=e.querySelector(".marks-chart").getContext("2d");o.chartInstances[t.id]&&o.chartInstances[t.id].destroy();const w=getComputedStyle(document.documentElement),M=f=>{const E=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(f);return E?`${parseInt(E[1],16)}, ${parseInt(E[2],16)}, ${parseInt(E[3],16)}`:"56, 189, 248"},L=w.getPropertyValue("--accent-color").trim()||"#3b82f6",b=M(L),x=(f,E)=>{const H=f.createLinearGradient(0,0,0,300);return H.addColorStop(0,`rgba(${E}, 0.4)`),H.addColorStop(1,`rgba(${E}, 0)`),H},T={total:{color:L,rgb:b},physics:{color:"#60a5fa",rgb:"96, 165, 250"},chemistry:{color:"#34d399",rgb:"52, 211, 153"},maths:{color:"#fb923c",rgb:"251, 146, 60"}},B=["total","physics","chemistry","maths"].map(f=>{const E=T[f],H=f!=="total";return{label:f.charAt(0).toUpperCase()+f.slice(1),data:t.content.map(j=>f==="total"?j.total??j.marks:j.subjects?j.subjects[f]:0),borderColor:E.color,backgroundColor:x(S,E.rgb),fill:f==="total",tension:.4,pointRadius:4,pointBackgroundColor:"#18181b",pointBorderColor:E.color,pointBorderWidth:2,pointHoverRadius:6,pointHoverBackgroundColor:E.color,pointHoverBorderColor:"#fff",borderWidth:2,hidden:H}});t.targetScore&&t.targetScore>0&&B.push({label:"Target",data:new Array(t.content.length).fill(t.targetScore),borderColor:"#ef4444",borderDash:[5,5],pointRadius:0,borderWidth:1,fill:!1});const Y=t.content.length>0?Math.max(...t.content.map(f=>f.maxMarks||300)):300,$=new Chart(S,{type:"line",data:{labels:t.content.map(f=>f.name),datasets:B},options:{animation:{duration:0},responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(24, 24, 27, 0.95)",titleColor:"#fff",bodyColor:"#9ca3af",borderColor:"rgba(255,255,255,0.1)",borderWidth:1,padding:10,displayColors:!0,callbacks:{label:function(f){return` ${f.dataset.label}: ${f.raw}`}}}},scales:{y:{beginAtZero:!0,max:Y,grid:{color:"rgba(255, 255, 255, 0.05)",drawBorder:!1},ticks:{color:"#6b7280",font:{size:10}}},x:{grid:{display:!1},ticks:{color:"#6b7280",font:{size:10}}}}}});o.chartInstances[t.id]=$;const ee=e.querySelector(".chart-toggles"),D=ee.cloneNode(!0);ee.parentNode.replaceChild(D,ee),D.addEventListener("click",f=>{if(f.target.tagName==="BUTTON"){const E=f.target.dataset.subject,H=$.data.datasets.findIndex(j=>j.label.toLowerCase().includes(E==="maths"?"math":E));if(H>-1){const j=$.getDatasetMeta(H);j.hidden=j.hidden===null?!$.data.datasets[H].hidden:null,$.update();const I=f.target;$.isDatasetVisible(H)?E==="total"?(I.style.backgroundColor="var(--accent-color)",I.style.color="white",I.style.borderColor="var(--accent-color)"):E==="physics"?(I.style.backgroundColor="rgba(59, 130, 246, 0.2)",I.style.color="#60a5fa",I.style.borderColor="#60a5fa"):E==="chemistry"?(I.style.backgroundColor="rgba(16, 185, 129, 0.2)",I.style.color="#34d399",I.style.borderColor="#34d399"):E==="maths"&&(I.style.backgroundColor="rgba(249, 115, 22, 0.2)",I.style.color="#fb923c",I.style.borderColor="#fb923c"):(I.style.backgroundColor="rgba(31, 41, 55, 0.5)",I.style.color="var(--text-secondary)",I.style.borderColor="#4b5563")}}})}},pomodoro:{templateId:"pomodoro-card-template",render:(e,t)=>{const s=o.pomodoroState[t.id]||{mode:"pomodoro",time:1500,isRunning:!1,intervalId:null,durations:{pomodoro:25,shortBreak:5,longBreak:15}};o.pomodoroState[t.id]=s;const n=Math.floor(s.time/60).toString().padStart(2,"0"),a=(s.time%60).toString().padStart(2,"0");e.querySelector(".timer-display").textContent=`${n}:${a}`,e.querySelectorAll(".pomodoro-btn").forEach(r=>{r.classList.toggle("active",r.dataset.mode===s.mode)}),e.querySelector(".start-pause-btn").textContent=s.isRunning?"PAUSE":"START",e.querySelector('[data-mode="pomodoro"].pomodoro-duration-input').value=s.durations.pomodoro,e.querySelector('[data-mode="shortBreak"].pomodoro-duration-input').value=s.durations.shortBreak,e.querySelector('[data-mode="longBreak"].pomodoro-duration-input').value=s.durations.longBreak}},youtube:{templateId:"youtube-card-template",render:(e,t)=>{const s=e.querySelector(".youtube-container"),n=t.content;let a="";if(n)try{const r=new URL(n);r.hostname.includes("youtu.be")?a=r.pathname.slice(1):a=r.searchParams.get("v")}catch{console.error("Invalid YouTube URL")}if(!a){s.innerHTML='<div class="flex items-center justify-center h-full text-xs text-gray-500">Invalid URL</div>';return}s.querySelector("iframe")||(s.innerHTML=`
            <div class="relative w-full h-full cursor-pointer group bg-black" onclick="this.innerHTML='<iframe class=\\'w-full h-full\\' src=\\'https://www.youtube.com/embed/${a}?autoplay=1\\' frameborder=\\'0\\' allow=\\'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\\' allowfullscreen></iframe>'">
                <img src="https://img.youtube.com/vi/${a}/hqdefault.jpg" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" alt="Video thumbnail">
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="none"><path d="M8 5v14l11-7z"/></svg>
                    </div>
                </div>
            </div>
        `,s.classList.toggle("tint-disabled",!o.settings.youtubeTintEnabled),s.classList.toggle("blurred",o.settings.youtubeBlurEnabled))}},analytics:{templateId:"analytics-card-template",render:(e,t)=>{const s=m=>{const g=[],v=[];let p=0;for(let h=m-1;h>=0;h--){const S=new Date;S.setDate(S.getDate()-h);const w=S.getFullYear(),M=(S.getMonth()+1).toString().padStart(2,"0"),L=S.getDate().toString().padStart(2,"0"),b=`${w}-${M}-${L}`,x=m===7?S.toLocaleDateString("en-US",{weekday:"short"}):S.toLocaleDateString("en-US",{day:"numeric",month:"short"});g.push(x);let T=0;o.studyLogs[b]&&Object.values(o.studyLogs[b]).forEach(B=>T+=B),v.push(T/3600),p+=T}return{labels:g,dataPoints:v,totalSecondsRange:p}},n=e.querySelector(".analytics-chart").getContext("2d"),a=e.querySelectorAll(".range-btn"),r=getComputedStyle(document.documentElement),i=r.getPropertyValue("--accent-color").trim()||"#3b82f6",d=r.getPropertyValue("--text-secondary").trim()||"#8b949e",c=r.getPropertyValue("--border-color").trim()||"#30363d",u=m=>{const{labels:g,dataPoints:v,totalSecondsRange:p}=s(m),h=Math.floor(p/3600),S=Math.floor(p%3600/60),w=h>0?`${h}h ${S}m`:`${S}m`,M=(p/3600/m).toFixed(2),L=e.querySelector(".statistics-summary");L&&(L.innerHTML=`

                                    <span class="mr-4">Total: <strong style="color:${i}">${w}</strong></span>

                                    <span>Average: <strong>${M}h/day</strong></span>

                                `),o.chartInstances[t.id]&&o.chartInstances[t.id].destroy(),o.chartInstances[t.id]=new Chart(n,{type:"bar",data:{labels:g,datasets:[{label:"Hours",data:v,backgroundColor:i,hoverBackgroundColor:i,borderRadius:4,barPercentage:.6}]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:0},plugins:{legend:{display:!1},tooltip:{callbacks:{label:b=>{const x=b.raw;return x>0&&x<1?` ${Math.round(x*60)} mins`:` ${x.toFixed(2)} hrs`}}}},scales:{y:{beginAtZero:!0,grid:{color:c,drawBorder:!1},border:{display:!1},ticks:{color:d,callback:b=>(b%1===0?b:b.toFixed(1))+"h"}},x:{grid:{display:!1,drawBorder:!1},ticks:{color:d}}}}}),a.forEach(b=>{parseInt(b.dataset.range)===m?(b.style.backgroundColor=i,b.style.borderColor=i,b.style.color="#fff"):(b.style.backgroundColor="transparent",b.style.borderColor=c,b.style.color=d)})};u(7),a.forEach(m=>{m.addEventListener("click",g=>{const v=parseInt(g.target.dataset.range);u(v)})})}},"daily-tasks":{templateId:"daily-tasks-template",render:(e,t)=>{(!t.content||Array.isArray(t.content))&&(t.content={});const s=e.querySelector(".daily-date-selector");s.value||(s.value=e.dataset.selectedDate||new Date().toISOString().split("T")[0]),e.dataset.selectedDate=s.value;const n=s.value,a=t.content[n]||[],r=e.querySelector(".daily-task-list"),i=e.querySelector(".progress-bar"),d=e.querySelector(".progress-text");r.innerHTML="",new Sortable(r,{animation:150,ghostClass:"sortable-ghost",delay:100,delayOnTouchOnly:!0,onEnd:g=>{const v=a.splice(g.oldIndex,1)[0];a.splice(g.newIndex,0,v),o.save("customCards")}});let c=0,u=0;a.length===0?r.innerHTML=`<li class="text-secondary text-xs text-center py-8 opacity-50 flex flex-col items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span>No plans for ${new Date(n).toLocaleDateString(void 0,{weekday:"short",month:"short",day:"numeric"})}</span>
                    </li>`:a.forEach((g,v)=>{g.priority||(g.priority="medium"),g.status||(g.status=g.completed?"done":"todo"),g.subtasks||(g.subtasks=[]),c++,g.status==="done"&&u++;const h={high:{color:"text-red-300",bg:"bg-red-500/20",border:"border-red-500/20",label:"High"},medium:{color:"text-amber-200",bg:"bg-amber-500/20",border:"border-amber-500/20",label:"Medium"},low:{color:"text-blue-200",bg:"bg-blue-500/20",border:"border-blue-500/20",label:"Low"}}[g.priority],S={todo:'<div class="w-4 h-4 rounded-full border-[1.5px] border-gray-400 hover:border-white transition-colors"></div>',"in-progress":'<div class="w-4 h-4 rounded-full border-[1.5px] border-amber-400 flex items-center justify-center"><div class="w-1.5 h-1.5 bg-amber-400 rounded-full animate-pulse"></div></div>',done:'<div class="w-4 h-4 rounded-full bg-[var(--accent-color)] border border-[var(--accent-color)] flex items-center justify-center text-white"><svg width="10" height="8" viewBox="0 0 12 10" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5L4 8L11 1"/></svg></div>'},w=document.createElement("li");w.className="group mb-2 rounded-xl bg-white/5 hover:bg-white/10 transition-all overflow-hidden relative cursor-grab active:cursor-grabbing",w.dataset.index=v;const M=g.subtasks.map((x,T)=>`
                            <div class="flex items-center gap-3 py-1.5 pl-2 group/sub relative">
                                <div class="absolute left-[-6px] top-1/2 w-2 h-px bg-gray-700"></div>
                                <button class="toggle-subtask-btn w-3.5 h-3.5 flex-shrink-0 border border-gray-500 rounded flex items-center justify-center transition-colors ${x.completed?"bg-gray-500 border-gray-500":"hover:border-gray-300"}" data-sub-index="${T}">
                                    ${x.completed?'<svg class="w-2.5 h-2.5 text-white" viewBox="0 0 12 10" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 5L4 8L11 1"/></svg>':""}
                                </button>
                                <span class="text-xs ${x.completed?"line-through text-gray-500":"text-gray-300"} flex-grow break-all font-medium">${x.text}</span>
                                <button class="delete-subtask-btn text-gray-500 hover:text-red-400 opacity-0 group-hover/sub:opacity-100 px-1.5 transition-opacity text-lg leading-none" data-sub-index="${T}">Ã—</button>
                            </div>
                        `).join("");w.innerHTML=`
                            <div class="flex items-start gap-3 p-3.5">
                                <button class="status-btn mt-0.5 flex-shrink-0 transform active:scale-95 transition-transform">
                                    ${S[g.status]}
                                </button>
                                
                                <div class="flex-grow min-w-0 flex flex-col toggle-expand-btn cursor-pointer">
                                    <div class="flex items-center justify-between gap-2 pr-12">
                                        <span id="daily-text-${v}" class="text-sm font-semibold leading-tight transition-colors ${g.status==="done"?"line-through text-gray-500 decoration-gray-500":"text-gray-100 group-hover:text-white"}">
                                            ${g.text}
                                        </span>
                                    </div>
                                    
                                    <div class="flex items-center gap-2 mt-2">
                                        <button class="priority-btn text-[10px] font-bold tracking-wide px-2 py-0.5 rounded-full border ${h.border} ${h.color} ${h.bg} hover:brightness-125 transition-all uppercase">
                                            ${h.label}
                                        </button>
                                        ${g.subtasks.length>0?`
                                            <span class="text-[10px] text-gray-400 font-medium flex items-center gap-1 bg-white/5 px-2 py-0.5 rounded-full">
                                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
                                                ${g.subtasks.filter(x=>x.completed).length}/${g.subtasks.length}
                                            </span>
                                        `:""}
                                    </div>
                                </div>

                                <div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-black/40 rounded-lg backdrop-blur-sm shadow-sm">
                                    <button class="edit-daily-task text-gray-400 hover:text-blue-400 p-1.5 transition-colors" title="Edit">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                    </button>
                                    <button class="delete-daily-task text-gray-400 hover:text-red-400 p-1.5 transition-colors" title="Delete">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="subtasks-section ${g.expanded?"block":"hidden"} pl-10 pr-4 pb-3 border-t border-white/5 bg-black/20">
                                <div class="space-y-0.5 mt-2">
                                    ${M}
                                </div>
                                <form class="add-subtask-form flex gap-2 mt-2 items-center opacity-70 hover:opacity-100 transition-opacity">
                                    <span class="text-gray-500 text-lg leading-none">+</span>
                                    <input type="text" placeholder="Add step..." class="bg-transparent border-none text-xs w-full focus:outline-none focus:placeholder-gray-400 placeholder-gray-600 text-gray-300 py-1 font-medium">
                                </form>
                            </div>
                        `;const L=w.querySelector(".edit-daily-task"),b=w.querySelector(`#daily-text-${v}`);L.addEventListener("click",x=>{x.stopPropagation();const T=g.text,B=document.createElement("input");B.type="text",B.value=T,B.className="bg-transparent text-white text-sm font-semibold border-b border-accent-color focus:outline-none w-full",B.addEventListener("click",$=>$.stopPropagation()),B.addEventListener("dblclick",$=>$.stopPropagation()),b.replaceWith(B),B.focus();const Y=()=>{const $=B.value.trim();$&&(g.text=$,o.save("customCards")),y["daily-tasks"].render(e,t)};B.addEventListener("keydown",$=>{$.key==="Enter"&&Y(),$.key==="Escape"&&y["daily-tasks"].render(e,t)}),B.addEventListener("blur",Y)}),r.appendChild(w)});const m=c>0?Math.round(u/c*100):0;i.style.width=`${m}%`,d.textContent=`${m}%`}},ambient:{templateId:"ambient-card-template",render:(e,t)=>{if(!window.ambientSounds){window.ambientSounds={pink:new Tone.Noise("pink").toDestination(),brown:new Tone.Noise("brown").toDestination(),white:new Tone.Noise("white").toDestination()};const i=new Tone.Filter(1500,"lowpass").toDestination();window.ambientSounds.white.disconnect().connect(i),Object.values(window.ambientSounds).forEach(d=>{d.volume.value=-1/0,d.start()})}(!t.content||typeof t.content!="object"||Array.isArray(t.content))&&(t.content={pink:-60,brown:-60,white:-60,isGlobalPaused:!0});const s=e.querySelector(".ambient-toggle-btn"),n=s.querySelector(".play-icon"),a=s.querySelector(".pause-icon"),r=i=>{i?(n.classList.remove("hidden"),a.classList.add("hidden"),s.title="Play All"):(n.classList.add("hidden"),a.classList.remove("hidden"),s.title="Pause All")};r(t.content.isGlobalPaused),s.onclick=()=>{const i=!t.content.isGlobalPaused;t.content.isGlobalPaused=i,i?Object.values(window.ambientSounds).forEach(d=>d.volume.rampTo(-1/0,.5)):(Tone.context.state!=="running"&&Tone.start(),e.querySelectorAll(".ambient-slider").forEach(d=>{const c=d.dataset.type,u=parseInt(d.value);u>-59&&window.ambientSounds[c].volume.rampTo(u,.5)})),r(i),o.save("customCards")},e.querySelectorAll(".ambient-slider").forEach(i=>{const d=i.dataset.type;i.setAttribute("draggable","false"),i.addEventListener("dragstart",u=>{u.preventDefault(),u.stopPropagation()}),i.addEventListener("mousedown",u=>{u.stopPropagation()});const c=t.content[d]||-60;if(i.value=c,!t.content.isGlobalPaused){const u=window.ambientSounds[d].volume.value,m=parseInt(c)<=-59?-1/0:parseInt(c);u<m&&m>-60&&window.ambientSounds[d].volume.rampTo(m,.1)}i.oninput=u=>{const m=parseInt(u.target.value);t.content[d]=m,t.content.isGlobalPaused&&m>-59&&(t.content.isGlobalPaused=!1,r(!1)),Tone.context.state!=="running"&&Tone.start(),t.content.isGlobalPaused||(m<=-59?window.ambientSounds[d].volume.rampTo(-1/0,.1):window.ambientSounds[d].volume.rampTo(m,.1))},i.onchange=u=>{o.save("customCards")}})}},"time-logger":{templateId:"time-logger-card-template",render:(e,t)=>{const s=o.timeLoggerState[t.id]||{isRunning:!1,accumulatedTime:0,currentSubject:"Physics",intervalId:null},n=s.isRunning&&s.intervalId!==null;o.timeLoggerState[t.id]=s,e.querySelector(".timer-display").textContent=Ee(s.accumulatedTime);const a=e.querySelector(".start-pause-btn");a.textContent=n?"PAUSE":"START",a.classList.toggle("bg-red-500/20",n);const r=e.querySelector(".subject-select"),i=[...new Set(["Physics","Chemistry","Maths",...o.settings.userSubjects||[]])];r.innerHTML=i.map(p=>`<option value="${p}">${p}</option>`).join("")+'<option value="add_new">Add New Subject...</option>',r.value=s.currentSubject;const d=e.querySelector(".manual-subject-select");d&&(d.innerHTML=i.map(p=>`<option value="${p}">${p}</option>`).join(""));const c=e.querySelector(".study-log-list"),u=e.querySelector(".total-study-time");c.innerHTML="";const m=R(new Date),g=o.studyLogs[m]||{},v=Object.values(g).reduce((p,h)=>p+h,0);u&&(u.textContent=`Total: ${re(v)}`),Object.keys(g).length===0?c.innerHTML='<li class="text-secondary px-2 text-sm opacity-50">No sessions logged today.</li>':Object.entries(g).forEach(([p,h])=>{const S=document.createElement("li");S.className="flex justify-between items-center group/log",S.innerHTML=`
                    <span>${p}</span>
                    <div class="flex items-center gap-2">
                        <span class="font-semibold text-[var(--accent-color)]">${re(h)}</span>
                        <button data-subject="${p}" class="delete-log-item text-gray-500 hover:text-red-400 opacity-0 group-hover/log:opacity-100 transition-opacity">Ã—</button>
                    </div>`,c.appendChild(S)})}}};function C(){Object.values(o.chartInstances).forEach(s=>s.destroy()),o.chartInstances={},l.dashboardGrid.innerHTML="";const e=o.customCards.map(s=>s.id);Array.isArray(o.layout)||(o.layout=["countdown","graph","default-todo","default-study-logger","default-note","default-line-graph","tests","quote","time"]);const t=o.layout.length;o.layout=o.layout.filter(s=>y[s]?.isDefault||e.includes(s)),o.layout.length,o.customCards.forEach(s=>{o.layout.includes(s.id)||o.layout.push(s.id)}),ze(),o.save("layout"),o.layout.forEach(s=>{const n=o.customCards.find(i=>i.id===s),a=n?n.type:s,r=y[a];if(r){const i=document.getElementById(r.templateId).content.cloneNode(!0),d=i.querySelector(".card");d.dataset.cardId=s;const c=o.cardProps[s]||{colspan:a==="graph"||a==="line-graph"||a==="youtube"||a==="time-logger"?2:1};if(o.cardProps[s]=c,c.colspan===2&&d.classList.add("md:col-span-2"),n)d.querySelector(".card-title").textContent=n.title;else if(o.settings.theme==="chaitanya-noob"){const u=d.querySelector("h2");u&&(u.textContent+=" ðŸ¤“")}l.dashboardGrid.appendChild(i)}}),l.dashboardGrid.querySelectorAll(".card").forEach((s,n)=>{const a=s.dataset.cardId,r=o.customCards.find(c=>c.id===a),i=r?r.type:a,d=y[i];d&&d.render&&d.render(s,r)})}function ke(){const e=o.settings.youtubeTintEnabled,t=o.settings.youtubeBlurEnabled;l.inputs.youtubeTintToggle&&(l.inputs.youtubeTintToggle.checked=e),l.inputs.youtubeBlurToggle&&(l.inputs.youtubeBlurToggle.checked=t),document.querySelectorAll('[data-card-type="youtube"] .youtube-container').forEach(s=>{s.classList.toggle("tint-disabled",!e),s.classList.toggle("blurred",t)})}function F(){document.documentElement.dataset.theme=o.settings.theme;const e=["cyberpunk","god-mode"].includes(o.settings.theme)?o.settings.theme:"";document.documentElement.dataset.subTheme=e,l.body.style.fontFamily=o.settings.font,o.settings.theme==="alakh-pandey"?l.body.style.backgroundImage="url(https://i.imgflip.com/8otyfs.jpg)":o.settings.theme==="chaitanya-noob"?l.body.style.backgroundImage="url(https://i.ibb.co/pv4BYhMs/Whats-App-Image-2025-08-06-at-16-12-41-4f47e159.jpg)":o.settings.theme==="god-mode"?l.body.style.backgroundImage="url('https://i.pinimg.com/originals/c5/9a/d2/c59ad2bd4ad2fbacd04017debc679ddb.gif')":l.body.style.backgroundImage=o.settings.bgUrl?`url(${o.settings.bgUrl})`:"none";const t=o.settings.jeeSession||"April",s=o.settings.examYear||"2026";l.inputs.jeeSession&&l.inputs.jeeSession.options.length===0&&["January","April"].forEach(c=>{const u=document.createElement("option");u.value=c,u.textContent=c,l.inputs.jeeSession.appendChild(u)}),l.inputs.jeeSession.value=t;const n=N.JEE[t]?.[s]||"";l.inputs.customName.value=o.settings.customExamName||"",l.inputs.customDate.value=o.settings.customExamDate||"",l.inputs.jeeShift.value=o.settings.jeeShiftDate||n,o.settings.examType==="JEE"?(l.inputs.jeeContainer.classList.remove("hidden"),l.inputs.customContainer.classList.add("hidden")):o.settings.examType==="Custom"?(l.inputs.jeeContainer.classList.add("hidden"),l.inputs.customContainer.classList.remove("hidden")):(l.inputs.jeeContainer.classList.add("hidden"),l.inputs.customContainer.classList.add("hidden"));const{examType:a,examYear:r,customExamName:i}=o.settings;let d;a==="Custom"?d=i||"My Exam":d=`${a} ${r}`,l.mainTitle.textContent=d,l.mainTitleRiced.textContent=d,l.inputs.tickingSoundToggle.checked=o.settings.tickingSoundEnabled,l.inputs.theme.value=o.settings.theme,l.inputs.font.value=o.settings.font,l.inputs.bgUrl.value=o.settings.bgUrl,l.inputs.examType.value=o.settings.examType,l.inputs.examYear.value=o.settings.examYear,l.inputs.focusShieldToggle.checked=o.settings.focusShieldEnabled,ke(),o.settings.ricedModeEnabled=!1,document.documentElement.dataset.ricedMode="false",l.inputs.ricedModeToggle&&(l.inputs.ricedModeToggle.checked=!1),o.settings.streamlinedModeEnabled=!1,document.documentElement.dataset.streamlinedMode="false",l.inputs.streamlinedModeToggle&&(l.inputs.streamlinedModeToggle.checked=!1),o.saveSettings()}l.dashboardGrid.addEventListener("click",e=>{const t=e.target.closest(".card");if(!t)return;const s=t.dataset.cardId;if(s==="quote"){if((e.target.closest(".refresh-quote-btn")||e.target.closest("#quote-card-content"))&&y.quote.render){const r=e.target.closest(".refresh-quote-btn");r&&(r.querySelector("svg").style.transition="transform 0.5s",r.querySelector("svg").style.transform="rotate(180deg)",setTimeout(()=>r.querySelector("svg").style.transform="rotate(0deg)",500)),y.quote.render(t)}if(e.target.closest(".copy-quote-btn")){const r=t.querySelector("#quote").textContent,i=t.querySelector("#author").textContent,d=`${r} ${i}`;navigator.clipboard.writeText(d).then(()=>{const c=e.target.closest(".copy-quote-btn"),u=c.innerHTML;c.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><polyline points="20 6 9 17 4 12"></polyline></svg>',setTimeout(()=>{c.innerHTML=u},1500)})}}if(e.target.closest(".delete-test-btn")){const r=e.target.closest(".delete-test-btn").dataset.date;delete o.tests[r],o.save("tests"),C()}if(e.target.classList.contains("day")){const r=e.target.dataset.date;if(o.tests[r])delete o.tests[r],o.save("tests"),C();else{const i=l.dashboardGrid.querySelector("#add-test-form");i&&(i.date.value=r,i.name.focus())}}const n=o.customCards.find(r=>r.id===s);if(e.target.closest(".toggle-colspan-btn")){const r=o.cardProps[s]||{colspan:1};r.colspan=r.colspan===2?1:2,o.cardProps[s]=r,o.save("cardProps"),C()}if(e.target.closest(".delete-card-btn")&&n&&(o.customCards=o.customCards.filter(r=>r.id!==s),delete o.cardProps[s],delete o.pomodoroState[s],delete o.timeLoggerState[s],o.save("customCards"),o.save("cardProps"),o.save("pomodoroState"),o.save("timeLoggerState"),C()),e.target.classList.contains("delete-log-item")){const r=e.target.closest(".card"),i=r.dataset.cardId,d=e.target.dataset.subject,c=R(new Date);if(o.studyLogs[c]&&o.studyLogs[c][d]!==void 0){delete o.studyLogs[c][d],Object.keys(o.studyLogs[c]).length===0&&delete o.studyLogs[c],o.save("studyLogs");const u=o.customCards.find(m=>m.id===i);y["time-logger"].render(r,u)}}if(n&&n.type==="todo"){const r=e.target.closest("li");if(r){const i=parseInt(r.dataset.index),d=n.content[i];if(e.target.closest(".status-btn")){const c=["todo","in-progress","done"],u=c.indexOf(d.status||"todo");d.status=c[(u+1)%3],d.completed=d.status==="done",o.save("customCards"),y.todo.render(t,n)}else if(e.target.closest(".priority-btn")){const c=["medium","high","low"],u=c.indexOf(d.priority||"medium");d.priority=c[(u+1)%3],o.save("customCards"),y.todo.render(t,n)}else if(e.target.closest(".toggle-expand-btn"))d.expanded=!d.expanded,o.save("customCards"),y.todo.render(t,n);else if(e.target.closest(".toggle-subtask-btn")){const c=parseInt(e.target.closest(".toggle-subtask-btn").dataset.subIndex);d.subtasks[c]&&(d.subtasks[c].completed=!d.subtasks[c].completed,o.save("customCards"),y.todo.render(t,n))}else if(e.target.closest(".delete-subtask-btn")){const c=parseInt(e.target.closest(".delete-subtask-btn").dataset.subIndex);d.subtasks.splice(c,1),o.save("customCards"),y.todo.render(t,n)}else e.target.closest(".delete-todo-item")&&(n.content.splice(i,1),o.save("customCards"),y.todo.render(t,n))}}if(e.target.closest(".pip-btn")){const r=o.customCards.find(i=>i.id===s);r&&r.type==="time-logger"&&Bt(s,r.type)}if(n&&n.type==="todo"){const r=e.target.closest(".todo-item");if(r){const i=parseInt(r.dataset.index);e.target.closest(".delete-todo-item")?n.content.splice(i,1):e.target.classList.contains("todo-checkbox")&&(n.content[i].completed=!n.content[i].completed),o.save("customCards"),y.todo.render(t,n)}}if(e.target.closest(".toggle-daily-task")){const r=e.target.closest(".toggle-daily-task"),i=parseInt(r.dataset.index),d=e.target.closest(".card"),c=d.dataset.cardId,u=o.customCards.find(g=>g.id===c),m=d.querySelector(".daily-date-selector").value;u&&u.content[m]&&(u.content[m][i].completed=!u.content[m][i].completed,o.save("customCards"),y["daily-tasks"].render(d,u))}if(e.target.closest(".prev-day-btn")||e.target.closest(".next-day-btn")){const r=t.querySelector(".daily-date-selector"),i=new Date(r.value||new Date),d=e.target.closest(".prev-day-btn")?-1:1;i.setDate(i.getDate()+d);const c=i.toISOString().split("T")[0];r.value=c,t.dataset.selectedDate=c;const u=o.customCards.find(m=>m.id===s);y["daily-tasks"].render(t,u)}const a=o.customCards.find(r=>r.id===s);if(a&&a.type==="daily-tasks"){const r=t.querySelector(".daily-date-selector").value;a.content[r]||(a.content[r]=[]);const i=a.content[r],d=e.target.closest("li");if(d){const c=parseInt(d.dataset.index),u=i[c];if(u)if(e.target.closest(".status-btn")){const m=["todo","in-progress","done"],g=m.indexOf(u.status||"todo");u.status=m[(g+1)%3],u.completed=u.status==="done",o.save("customCards"),y["daily-tasks"].render(t,a)}else if(e.target.closest(".priority-btn")){const m=["medium","high","low"],g=m.indexOf(u.priority||"medium");u.priority=m[(g+1)%3],o.save("customCards"),y["daily-tasks"].render(t,a)}else if(e.target.closest(".toggle-expand-btn"))u.expanded=!u.expanded,o.save("customCards"),y["daily-tasks"].render(t,a);else if(e.target.closest(".toggle-subtask-btn")){const m=parseInt(e.target.closest(".toggle-subtask-btn").dataset.subIndex);u.subtasks[m]&&(u.subtasks[m].completed=!u.subtasks[m].completed,o.save("customCards"),y["daily-tasks"].render(t,a))}else if(e.target.closest(".delete-subtask-btn")){const m=parseInt(e.target.closest(".delete-subtask-btn").dataset.subIndex);u.subtasks.splice(m,1),o.save("customCards"),y["daily-tasks"].render(t,a)}else e.target.closest(".delete-daily-task")&&(i.splice(c,1),i.length===0&&delete a.content[r],o.save("customCards"),y["daily-tasks"].render(t,a))}}if(n&&n.type==="line-graph"&&e.target.closest(".delete-mark-item")){const r=parseInt(e.target.closest(".delete-mark-item").dataset.index);n.content.splice(r,1),o.save("customCards"),y["line-graph"].render(t,n)}if(e.target.closest(".toggle-manual-form")){const r=e.target.closest(".card").querySelector(".manual-log-form");r.classList.toggle("hidden");const i=e.target.closest(".toggle-manual-form").querySelector("span");r.classList.contains("hidden")?i.textContent="+ Add Manual Entry":i.textContent="- Close"}n&&n.type==="pomodoro"&&(e.target.classList.contains("pomodoro-btn")?K.setMode(s,e.target.dataset.mode):e.target.classList.contains("start-pause-btn")?K.toggle(s):e.target.classList.contains("reset-btn")&&K.reset(s)),n&&n.type==="time-logger"&&(e.target.classList.contains("start-pause-btn")?window.timeLogger.toggle(s):e.target.classList.contains("log-btn")?window.timeLogger.log(s):e.target.classList.contains("reset-btn")&&window.timeLogger.reset(s))}),l.dashboardGrid.addEventListener("change",e=>{if(e.target.classList.contains("pomodoro-duration-input")){const t=e.target.closest(".card").dataset.cardId,s=e.target.dataset.mode;let n=parseInt(e.target.value);n<1&&(n=1,e.target.value=1),t&&s&&!isNaN(n)&&K.setDuration(t,s,n)}if(e.target.classList.contains("subject-select")){const t=e.target.closest(".card").dataset.cardId;window.timeLogger.changeSubject(t,e.target.value)}if(e.target.classList.contains("daily-date-selector")){const t=e.target.closest(".card"),s=t.dataset.cardId,n=o.customCards.find(a=>a.id===s);t.dataset.selectedDate=e.target.value,y["daily-tasks"].render(t,n)}}),l.dashboardGrid.addEventListener("submit",e=>{e.preventDefault();const t=e.target,s=t.closest(".card"),n=s.dataset.cardId;if(t.id==="add-test-form"){const{date:a,name:r}=t.elements;if(a.value&&r.value.trim()){const i=a.value,d=r.value.trim();o.tests[i]?o.tests[i]=o.tests[i]+" | "+d:o.tests[i]=d,o.save("tests"),C(),t.reset()}}else if(t.classList.contains("add-todo-form")){const a=o.customCards.find(d=>d.id===n),r=t.querySelector("input"),i=r.value.trim();if(i.toLowerCase()==="coco"){Z||(Z={theme:o.settings.theme,customCards:JSON.parse(JSON.stringify(o.customCards)),tests:JSON.parse(JSON.stringify(o.tests)),layout:[...o.layout]}),l.godModePanel.classList.remove("hidden"),new Tone.Synth().toDestination().triggerAttackRelease("C4","0.5"),r.value="";return}if(i.toLowerCase()==="doingocmakesmeexcited"){o.settings.theme="chaitanya-noob",o.saveSettings(),F(),C(),r.value="";return}a&&i&&(Array.isArray(a.content)||(a.content=[]),a.content.push({text:i,completed:!1}),o.save("customCards"),y.todo.render(s,a),r.value="")}else if(t.classList.contains("manual-log-form")){const a=t.querySelector(".manual-subject-select").value,r=t.querySelector('input[name="minutes"]'),i=parseInt(r.value);if(a&&i>0){const d=R(new Date);o.studyLogs[d]||(o.studyLogs[d]={});const c=i*60;o.studyLogs[d][a]=(o.studyLogs[d][a]||0)+c,o.save("studyLogs"),C(),r.value="",console.log(`Added ${i} mins to ${a}`)}}else if(t.classList.contains("add-daily-task-form")){const a=o.customCards.find(u=>u.id===n),r=t.querySelector("input"),i=r.value.trim(),c=s.querySelector(".daily-date-selector").value;a&&i&&c&&((!a.content||Array.isArray(a.content))&&(a.content={}),a.content[c]||(a.content[c]=[]),a.content[c].push({text:i,completed:!1}),o.save("customCards"),y["daily-tasks"].render(s,a),r.value="")}else if(t.classList.contains("add-subtask-form")){const a=o.customCards.find(u=>u.id===n),r=t.closest("li"),i=parseInt(r.dataset.index),c=t.querySelector("input").value.trim();if(a&&c)if(a.type==="daily-tasks"){const u=s.querySelector(".daily-date-selector").value,m=a.content[u]?.[i];if(m){m.subtasks||(m.subtasks=[]),m.subtasks.push({text:c,completed:!1}),o.save("customCards"),y["daily-tasks"].render(s,a);const g=s.querySelector(`li[data-index="${i}"]`);g&&g.querySelector("input").focus()}}else{const u=a.content[i];if(u){u.subtasks||(u.subtasks=[]),u.subtasks.push({text:c,completed:!1}),o.save("customCards"),y.todo.render(s,a);const m=s.querySelector(`li[data-index="${i}"]`);if(m){const g=m.querySelector(".add-subtask-form input");g&&g.focus()}}}}else if(t.classList.contains("add-marks-form")){const a=o.customCards.find(m=>m.id===n),{name:r,phy:i,chem:d,math:c,maxMarks:u}=t.elements;if(a&&r.value.trim()&&i.value&&d.value&&c.value&&u.value){Array.isArray(a.content)||(a.content=[]);const m=parseFloat(i.value),g=parseFloat(d.value),v=parseFloat(c.value),p=m+g+v;a.content.push({name:r.value.trim(),maxMarks:parseFloat(u.value),total:p,subjects:{physics:m,chemistry:g,maths:v}}),o.save("customCards"),y["line-graph"].render(s,a),t.reset()}}else if(t.classList.contains("update-youtube-form")){const a=o.customCards.find(i=>i.id===n),r=t.querySelector("input");a&&r.value.trim()&&(a.content=r.value.trim(),o.save("customCards"),y.youtube.render(s,a))}});function he(){const e=document.getElementById("subject-manager-list"),t=o.settings.userSubjects||[];if(e.innerHTML="",t.length===0){e.innerHTML='<span class="text-xs text-gray-500 italic p-1">No custom subjects added.</span>';return}t.forEach((s,n)=>{const a=document.createElement("div");a.className="subject-chip",a.innerHTML=`
            <span>${s}</span>
            <button class="delete-subject-btn" data-index="${n}" title="Remove ${s}">âœ•</button>
        `,e.appendChild(a)})}function Ye(){const e=document.getElementById("new-subject-input"),t=e.value.trim();if(t){if(o.settings.userSubjects||(o.settings.userSubjects=[]),o.settings.userSubjects.includes(t)){alert("Subject already exists!");return}o.settings.userSubjects.push(t),e.value="",o.saveSettings(),he(),C()}}function Dt(e){o.settings.userSubjects&&o.settings.userSubjects[e]&&(o.settings.userSubjects.splice(e,1),o.saveSettings(),he(),C())}async function Bt(e,t){if("documentPictureInPicture"in window){A&&A.close();try{const s={width:320,height:155};A=await documentPictureInPicture.requestWindow(s),W=e,Oe=t,[...document.styleSheets].forEach(v=>{if(v.href){const p=document.createElement("link");p.rel="stylesheet",p.href=v.href,A.document.head.appendChild(p)}else if(v.ownerNode){const p=v.ownerNode.cloneNode(!0);A.document.head.appendChild(p)}});const a=document.createElement("style");a.textContent=`

                            body {

                                background-color: #000000;

                                color: var(--text-primary);

                                font-family: var(--font-family);

                                display: flex;

                                flex-direction: column;

                                align-items: center;

                                justify-content: center;

                                text-align: center;

                                padding: 1rem;

                                margin: 0;

                                box-sizing: border-box;

                                overflow: hidden;

                            }

                            h2 {

                                font-size: 0.9rem;

                                margin: 0 0 0.5rem 0;

                                color: var(--text-secondary);

                                font-weight: 600;

                            }

                            #pip-timer {

                                

                                font-size: clamp(1.5rem, 25vh, 7.5rem);

                                font-weight: 700;

                                line-height: 1; /* Helps with vertical alignment */

                                letter-spacing: 0.05em;

                                font-family: 'Fira Code', monospace;

                            }

                            #pip-controls {

                                display: flex;

                                gap: 0.75rem;

                                margin-top: 1rem;

                            }

                            #pip-controls button {

                                padding: 0.5rem 1.25rem;

                                font-size: 0.9rem;

                                font-weight: 600;

                                border: none;

                                border-radius: 8px;

                                cursor: pointer;

                                transition: transform 0.1s ease, filter 0.1s ease;

                            }

                            #pip-controls button:hover {

                                transform: translateY(-2px);

                                filter: brightness(1.1);

                            }

                            #pip-start-pause-btn {

                                background-color: var(--accent-color);

                                color: white; /* Default to white for most themes */

                            }

                            #pip-log-btn {

                                background-color: #16a34a; /* A nice, consistent green */

                                color: white;

                            }

                            #pip-log-btn:disabled {

                                background-color: #4b5563; /* Gray out when disabled */

                                cursor: not-allowed;

                                transform: none;

                                filter: none;

                            }

                            #pip-reset-btn {

                                background-color: transparent;

                                color: var(--text-secondary);

                            }

                            /* Fix for themes where button text should be dark */

                            [data-theme="light"] #pip-start-pause-btn,

                            [data-theme="alakh-pandey"] #pip-start-pause-btn {

                                color: var(--bg-color);

                            }

                        `,A.document.head.appendChild(a);const r=document.documentElement.dataset.theme;r&&r!=="default"&&(A.document.documentElement.dataset.theme=r);const i=document.createElement("h2");i.textContent=document.querySelector(`[data-card-id="${e}"] .card-title`).textContent;const d=document.createElement("div");d.id="pip-timer";const c=document.createElement("div");c.id="pip-controls";const u=document.createElement("button");u.id="pip-start-pause-btn",u.addEventListener("click",()=>window.timeLogger.toggle(W));const m=document.createElement("button");m.id="pip-log-btn",m.textContent="Log",m.addEventListener("click",()=>window.timeLogger.log(W));const g=document.createElement("button");g.id="pip-reset-btn",g.textContent="Reset",g.addEventListener("click",()=>window.timeLogger.reset(W)),c.append(u,m,g),A.document.body.append(i,d,c),document.addEventListener("visibilitychange",Je),A.addEventListener("pagehide",()=>{A=null,W=null,Oe=null,document.removeEventListener("visibilitychange",Je)}),ie(),le()}catch(s){console.error("PiP Error:",s),A=null}}else alert("Your browser does not support the Document Picture-in-Picture API required for this feature. Please try a recent version of Chrome or Edge on a desktop computer.")}l.buttons.addCard.forEach(e=>e.addEventListener("click",()=>l.modals.addCard.classList.remove("hidden"))),l.buttons.cancelAddCard.addEventListener("click",()=>l.modals.addCard.classList.add("hidden")),l.inputs.cardType.addEventListener("change",e=>{const t=e.target.value==="note",s=e.target.value==="youtube";l.inputs.cardContent.style.display=t||s?"block":"none",l.inputs.cardContent.placeholder=s?"Paste YouTube video URL...":"Card Content (for notes)"}),l.forms.newCard.addEventListener("submit",e=>{e.preventDefault();const t=l.inputs.cardType.value,s=l.forms.newCard.querySelector('input[type="text"]').value.trim();if(!s)return;const n={id:`custom-${Date.now()}`,type:t,title:s,content:t==="note"||t==="youtube"?l.inputs.cardContent.value.trim():[]};o.customCards.push(n);const a={colspan:t==="line-graph"||t==="youtube"||t==="time-logger"||t==="analytics"?2:1};t==="line-graph"&&(a.maxMarks=300),o.cardProps[n.id]=a,o.save("customCards"),o.save("cardProps"),C(),l.modals.addCard.classList.add("hidden"),l.forms.newCard.reset(),l.inputs.cardContent.style.display="block"});const Ce=()=>l.modals.customize.classList.add("hidden");l.buttons.customize.forEach(e=>e.addEventListener("click",()=>l.modals.customize.classList.remove("hidden"))),l.buttons.closeCustomize.addEventListener("click",Ce),l.buttons.closeCustomizeIcon.addEventListener("click",Ce),l.modals.customize.addEventListener("click",e=>{e.target===l.modals.customize&&Ce()});const Ve=document.getElementById("preset-wallpaper-grid");Ve&&[{name:"Deep Space",type:"img",thumb:"https://images.unsplash.com/photo-1462331940025-496dfbfc7564?auto=format&fit=crop&w=200&q=60",url:"https://images.unsplash.com/photo-1462331940025-496dfbfc7564?auto=format&fit=crop&w=1920&q=80"},{name:"Midnight City",type:"img",thumb:"https://images.unsplash.com/photo-1519501025264-65ba15a82390?auto=format&fit=crop&w=200&q=60",url:"https://images.unsplash.com/photo-1519501025264-65ba15a82390?auto=format&fit=crop&w=1920&q=80"},{name:"Dark Library",type:"img",thumb:"https://images.unsplash.com/photo-1507842217343-583bb7270b66?auto=format&fit=crop&w=200&q=60",url:"https://images.unsplash.com/photo-1507842217343-583bb7270b66?auto=format&fit=crop&w=1920&q=80"},{name:"Zen Forest",type:"img",thumb:"https://images.pexels.com/photos/167699/pexels-photo-167699.jpeg?auto=compress&cs=tinysrgb&w=200",url:"https://images.pexels.com/photos/167699/pexels-photo-167699.jpeg?auto=compress&cs=tinysrgb&w=1920"},{name:"Study Desk",type:"img",thumb:"https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?auto=format&fit=crop&w=200&q=60",url:"https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?auto=format&fit=crop&w=1920&q=80"},{name:"Stormy Sea",type:"img",thumb:"https://images.unsplash.com/photo-1505118380757-91f5f5632de0?auto=format&fit=crop&w=200&q=60",url:"https://images.unsplash.com/photo-1505118380757-91f5f5632de0?auto=format&fit=crop&w=1920&q=80"},{name:"Minimal Dark",type:"img",thumb:"https://images.unsplash.com/photo-1478760329108-5c3ed9d495a0?auto=format&fit=crop&w=200&q=60",url:"https://images.unsplash.com/photo-1478760329108-5c3ed9d495a0?auto=format&fit=crop&w=1920&q=80"},{name:"Cozy Rain",type:"img",thumb:"https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?auto=format&fit=crop&w=200&q=60",url:"https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?auto=format&fit=crop&w=1920&q=80"}].forEach(e=>{const t=document.createElement("button");t.className="relative group w-full h-16 rounded-md overflow-hidden border border-gray-700 hover:border-white transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500",t.type="button",t.innerHTML=`

                <img src="${e.thumb}" alt="${e.name}" class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity">

                <span class="absolute bottom-0 left-0 right-0 bg-black/60 text-[9px] text-white text-center py-0.5 truncate">${e.name}</span>

                ${e.type==="gif"?'<span class="absolute top-1 right-1 bg-indigo-600/80 text-[8px] text-white px-1 rounded">GIF</span>':""}

            `,t.addEventListener("click",()=>{l.inputs.bgUrl.value=e.url,o.settings.bgUrl=e.url,_()}),Ve.appendChild(t)});const _=()=>{o.saveSettings(),F(),C()};l.inputs.examType.addEventListener("change",()=>{o.settings.examType=l.inputs.examType.value,_()}),l.inputs.examYear.addEventListener("change",()=>{o.settings.examYear=l.inputs.examYear.value,o.settings.jeeShiftDate="",l.inputs.jeeShift.value="",_()}),l.inputs.theme.addEventListener("change",()=>{o.settings.theme=l.inputs.theme.value,o.saveSettings(),F(),C()}),l.inputs.font.addEventListener("change",()=>{o.settings.font=l.inputs.font.value,o.saveSettings(),F()}),l.inputs.bgUrl.addEventListener("input",()=>{o.settings.bgUrl=l.inputs.bgUrl.value,o.saveSettings(),F()}),l.buttons.removeBg.addEventListener("click",()=>{o.settings.bgUrl="",o.saveSettings(),F()}),l.inputs.youtubeTintToggle.addEventListener("change",()=>{o.settings.youtubeTintEnabled=l.inputs.youtubeTintToggle.checked,o.saveSettings(),ke()}),l.inputs.youtubeBlurToggle.addEventListener("change",()=>{o.settings.youtubeBlurEnabled=l.inputs.youtubeBlurToggle.checked,o.saveSettings(),ke()}),l.inputs.focusShieldToggle.addEventListener("change",()=>{const e=l.inputs.focusShieldToggle.checked;if(o.settings.focusShieldEnabled=e,o.saveSettings(),!e&&o.activeTimer.cardId){const{cardId:t,type:s}=o.activeTimer;s==="pomodoro"&&K.stop(t),s==="time-logger"&&window.timeLogger.pause(t)}});const We=document.querySelectorAll(".card-option"),$t=document.getElementById("new-card-type"),ye=document.getElementById("new-card-content"),Te=document.getElementById("new-card-title"),_e={note:"Quick Note",todo:"My Tasks","daily-tasks":"Agenda",pomodoro:"Focus Timer","time-logger":"Study Log","line-graph":"Test Progress",analytics:"Stats",ambient:"Soundscapes",youtube:"Video Player"};We.forEach(e=>{e.addEventListener("click",()=>{We.forEach(i=>i.classList.remove("active")),e.classList.add("active");const t=e.dataset.value;$t.value=t;const s=t==="note",n=t==="youtube";s||n?(ye.style.display="block",ye.placeholder=n?"Paste YouTube URL...":"Write your note here...",setTimeout(()=>ye.focus(),50)):(ye.style.display="none",Te.focus());const a=Te.value;(Object.values(_e).includes(a)||a==="")&&(Te.value=_e[t]||"")})}),l.inputs.tickingSoundToggle.addEventListener("change",()=>{o.settings.tickingSoundEnabled=l.inputs.tickingSoundToggle.checked,o.saveSettings()}),l.buttons.resetDashboard.addEventListener("click",()=>{fe("This will delete all custom cards and reset the layout to the default.",async()=>{if(Object.keys(k).forEach(e=>{e!=="settings"&&e!=="mobileAlertDismissed"&&localStorage.removeItem(k[e])}),P){G("Resetting Cloud Data...");try{await Ne.collection("users").doc(P.uid).delete(),console.log("Cloud data deleted.")}catch(e){console.error("Error resetting cloud data:",e),alert("Failed to reset cloud data. Check console.");return}}location.reload()},"Reset Dashboard?")}),l.buttons.exportData.addEventListener("click",()=>{const e={};for(const i in k){const d=localStorage.getItem(k[i]);d!==null&&(e[i]=JSON.parse(d))}const t=JSON.stringify(e,null,2),s=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(s),a=document.createElement("a");a.href=n;const r=new Date().toISOString().slice(0,10);a.download=`studylocus-backup-${r}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}),l.buttons.importData.addEventListener("click",()=>{l.inputs.importFile.click()}),l.inputs.importFile.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const s=new FileReader;s.onload=n=>{try{const a=JSON.parse(n.target.result);if(!a.layout||!a.customCards){alert("Invalid backup file.");return}fe("This will overwrite your dashboard.",()=>{for(const r in k)a[r]&&(o[r]=a[r],localStorage.setItem(k[r],JSON.stringify(a[r])));ze(),P&&pe(),F(),C(),G("Import Successful")},"Import Data?")}catch(a){console.error(a),alert("Error reading file.")}finally{l.inputs.importFile.value=""}},s.readAsText(t)}),l.buttons.info.forEach(e=>e.addEventListener("click",()=>l.modals.info.classList.remove("hidden"))),l.buttons.closeInfo.addEventListener("click",()=>l.modals.info.classList.add("hidden")),l.buttons.zenModeBtn.forEach(e=>e.addEventListener("click",()=>{l.body.classList.add("zen-mode"),l.buttons.exitZenBtn.classList.remove("hidden")})),l.buttons.exitZenBtn.addEventListener("click",()=>{l.body.classList.remove("zen-mode"),l.buttons.exitZenBtn.classList.add("hidden")}),l.buttons.confirmCancel.addEventListener("click",()=>{l.modals.confirm.classList.add("hidden"),J=null}),l.buttons.confirmOk.addEventListener("click",()=>{typeof J=="function"&&J(),l.modals.confirm.classList.add("hidden"),J=null});const K={tick(e){const t=o.pomodoroState[e];if(t.time>0)t.time--,this.updateDisplay(e);else{if(t.mode==="pomodoro"){const s=R(new Date);o.studyLogs[s]||(o.studyLogs[s]={});const n="Pomodoro",a=t.durations.pomodoro*60;o.studyLogs[s][n]=(o.studyLogs[s][n]||0)+a,o.save("studyLogs"),C()}this.stop(e),new Tone.Synth().toDestination().triggerAttackRelease("C5","0.5")}},updateDisplay(e){const t=l.dashboardGrid.querySelector(`[data-card-id="${e}"]`);t&&y.pomodoro.render(t,{id:e});const s=o.pomodoroState[e];if(s.isRunning){const n=Math.floor(s.time/60).toString().padStart(2,"0"),a=(s.time%60).toString().padStart(2,"0");document.title=`${n}:${a} - Time to focus!`}else{const{examType:n,examYear:a}=o.settings;document.title=`${n} ${a} | StudyLocus`}},start(e,t=!1){const s=o.pomodoroState[e];if(!s.isRunning){if(s.isRunning=!0,!t){if(o.activeTimer.cardId!==e||o.activeTimer.type!=="pomodoro"){o.activeTimer.unfocusedTime=0;const n=l.dashboardGrid.querySelector(`[data-card-id="${e}"]`);if(n){const a=n.querySelector(".focus-status");a&&(a.textContent="")}}o.activeTimer.cardId=e,o.activeTimer.type="pomodoro",o.settings.focusShieldEnabled&&Ke()}s.intervalId=setInterval(()=>this.tick(e),1e3),this.updateDisplay(e),o.save("pomodoroState")}},_internalPause(e){const t=o.pomodoroState[e];clearInterval(t.intervalId),t.isRunning=!1,this.updateDisplay(e)},stop(e){const t=o.pomodoroState[e];clearInterval(t.intervalId),o.activeTimer.cardId===e&&(o.activeTimer.cardId=null,o.activeTimer.type=null,o.settings.focusShieldEnabled&&Ze()),t.isRunning=!1,this.updateDisplay(e),o.save("pomodoroState")},toggle(e){o.pomodoroState[e].isRunning?this.stop(e):this.start(e)},reset(e){const t=o.pomodoroState[e];this.stop(e),t.time=t.durations[t.mode]*60,this.updateDisplay(e),o.save("pomodoroState")},setMode(e,t){o.pomodoroState[e].mode=t,this.reset(e)},setDuration(e,t,s){const n=o.pomodoroState[e];n.durations[t]=s,n.mode===t&&this.reset(e),o.save("pomodoroState")}};window.timeLogger={tick(e){const t=o.timeLoggerState[e];if(t&&t.isRunning&&t.startTime){const s=Date.now()-t.startTime,n=t.accumulatedTime+Math.round(s/1e3),a=l.dashboardGrid.querySelector(`[data-card-id="${e}"]`),r=Ee(n);a&&(a.querySelector(".timer-display").textContent=r,ie()),document.title=`${r} â€¢ ${t.currentSubject||"Focus"}`}},start(e){const t=o.timeLoggerState[e];if(!t||t.isRunning)return;t.isRunning=!0,t.startTime=Date.now(),o.activeTimer.cardId=e,o.activeTimer.type="time-logger",o.settings.focusShieldEnabled&&Ke(),t.intervalId=setInterval(()=>this.tick(e),1e3);const s=l.dashboardGrid.querySelector(`[data-card-id="${e}"]`);s&&(s.querySelector(".start-pause-btn").textContent="PAUSE"),o.save("timeLoggerState"),le()},pause(e,t=!0){const s=o.timeLoggerState[e];if(!s||!s.isRunning)return;clearInterval(s.intervalId);const n=Date.now()-s.startTime;s.accumulatedTime+=Math.round(n/1e3),s.isRunning=!1,s.startTime=null,s.intervalId=null,o.activeTimer.cardId===e&&(o.activeTimer.cardId=null,o.activeTimer.type=null,o.settings.focusShieldEnabled&&Ze());const{examType:a,examYear:r}=o.settings,i=a==="Custom"?o.settings.customExamName||"My Exam":`${a} ${r}`;if(document.title=`${i} | StudyLocus`,o.save("timeLoggerState"),t){const d=l.dashboardGrid.querySelector(`[data-card-id="${e}"]`);d&&y["time-logger"].render(d,{id:e})}le(),ie()},toggle(e){o.timeLoggerState[e].isRunning?this.pause(e):this.start(e)},log(e){this.pause(e,!1);const t=o.timeLoggerState[e];if(t.accumulatedTime<60){const a=l.dashboardGrid.querySelector(`[data-card-id="${e}"]`);if(a){const r=a.querySelector(".log-message");r&&(r.textContent="Minimum log time is 1 minute.",setTimeout(()=>{r&&(r.textContent="")},3e3))}this.start(e);return}const s=R(new Date);o.studyLogs[s]||(o.studyLogs[s]={});const n=t.currentSubject;o.studyLogs[s][n]=(o.studyLogs[s][n]||0)+t.accumulatedTime,o.save("studyLogs"),t.accumulatedTime=0,o.save("timeLoggerState"),C(),ie(),le()},reset(e){this.pause(e,!1),o.timeLoggerState[e].accumulatedTime=0,o.save("timeLoggerState"),C(),ie(),le()},changeSubject(e,t){const s=o.timeLoggerState[e];if(t==="add_new"){alert("Please go to 'Customize Dashboard' to manage your subjects."),l.modals.customize.classList.remove("hidden"),he();const n=l.dashboardGrid.querySelector(`[data-card-id="${e}"]`);n&&(n.querySelector(".subject-select").value=s.currentSubject);return}s&&(s.currentSubject=t,o.save("timeLoggerState"))}},l.inputs.examType.addEventListener("change",()=>{o.settings.examType=l.inputs.examType.value,o.settings.examType==="JEE"?l.inputs.jeeContainer.classList.remove("hidden"):l.inputs.jeeContainer.classList.add("hidden"),_()}),l.inputs.jeeSession.addEventListener("change",()=>{o.settings.jeeSession=l.inputs.jeeSession.value,o.settings.jeeShiftDate="",l.inputs.jeeShift.value="",_();const{examType:e,examYear:t,jeeSession:s}=o.settings,n=e==="JEE"?`JEE ${t}`:`${e} ${t}`;l.mainTitle.textContent=n}),l.inputs.jeeShift.addEventListener("change",()=>{o.settings.jeeShiftDate=l.inputs.jeeShift.value,_()});let Z=null;l.body.addEventListener("click",e=>{if(e.target.closest("#god-mode-panel")){const t=e.target.id;if(t==="god-mode-close-btn"&&(l.godModePanel.classList.add("hidden"),Z&&(o.settings.theme=Z.theme,o.customCards=Z.customCards,o.tests=Z.tests,o.layout=Z.layout,Z=null,F(),C())),t==="god-mode-theme-btn"){const s=l.inputs.theme;if(!s.querySelector('[value="god-mode"]')){const n=document.createElement("option");n.value="god-mode",n.textContent="--- GOD MODE ---",s.appendChild(n)}o.settings.theme="god-mode",F(),C()}if(t==="god-mode-complete-tasks-btn"&&(o.customCards.forEach(s=>{s.type==="todo"&&Array.isArray(s.content)&&s.content.forEach(n=>n.completed=!0)}),C()),t==="god-mode-perfect-score-btn"){const s=o.customCards.find(n=>n.type==="line-graph");if(s&&Array.isArray(s.content)){const n=o.settings.examType==="NEET"?720:300;s.content.push({name:"God Tier",marks:n,maxMarks:n}),C()}}if(t==="god-mode-timewarp-btn"){const s={};Object.keys(o.tests).forEach(n=>{const a=new Date(n+"T00:00:00");a.setDate(a.getDate()+7);const r=R(a);s[r]=o.tests[n]}),o.tests=s,C()}if(t==="god-mode-scramble-btn"){let s=o.layout;for(let n=s.length-1;n>0;n--){const a=Math.floor(Math.random()*(n+1));[s[n],s[a]]=[s[a],s[n]]}C()}t==="god-mode-nuke-btn"&&(l.dashboardGrid.querySelectorAll(".card").forEach((s,n)=>{s.style.animation=`fall-apart 1s ease-in-out ${n*.05}s forwards`}),setTimeout(()=>{fe("Dashboard nuked. Restore?",()=>{l.dashboardGrid.innerHTML="",C()},"KABOOM!")},1500))}});function Ke(){try{document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen()}catch(e){console.warn("Fullscreen request failed.",e)}document.addEventListener("visibilitychange",Xe),document.addEventListener("fullscreenchange",Qe)}function Ze(){try{document.fullscreenElement&&document.exitFullscreen&&document.exitFullscreen()}catch(n){console.warn("Exit fullscreen request failed.",n)}document.removeEventListener("visibilitychange",Xe),document.removeEventListener("fullscreenchange",Qe);const{cardId:e,type:t}=o.activeTimer,s=l.dashboardGrid.querySelector(`[data-card-id="${e}"]`);if(s){const n=s.querySelector(".focus-status");n&&(n.textContent="")}}function Qe(){if(!document.fullscreenElement&&o.activeTimer.cardId){const{cardId:e,type:t}=o.activeTimer;t==="pomodoro"&&K.stop(e),t==="time-logger"&&window.timeLogger.pause(e)}}function Xe(){const{cardId:e,type:t}=o.activeTimer;if(!e||t!=="time-logger")return;const s=window.timeLogger,n=o.timeLoggerState[e];if(n){if(document.visibilityState==="hidden")n.isRunning&&s.pause(e,!1);else if(document.visibilityState==="visible"&&n.isRunning){const a=(Date.now()-n.startTime)/1e3;n.accumulatedTime+=Math.round(a),s.start(e)}}}l.inputs.customName.addEventListener("input",()=>{o.settings.customExamName=l.inputs.customName.value,_()}),l.inputs.customDate.addEventListener("change",()=>{o.settings.customExamDate=l.inputs.customDate.value,_()}),l.inputs.examType.addEventListener("change",()=>{o.settings.examType=l.inputs.examType.value,l.inputs.jeeContainer.classList.toggle("hidden",o.settings.examType!=="JEE"),l.inputs.customContainer.classList.toggle("hidden",o.settings.examType!=="Custom"),_()});let be=0,et;const jt=()=>{const e=l.inputs.theme.querySelector('[value="alakh-pandey"]');e&&e.classList.remove("hidden"),o.settings.theme="alakh-pandey",o.saveSettings(),F(),C(),typeof Tone<"u"&&new Tone.Synth().toDestination().triggerAttackRelease("G4","0.5")};[l.mainTitle,l.mainTitleRiced].forEach(e=>{e&&e.addEventListener("click",t=>{be++,clearTimeout(et),be===3?(jt(),be=0):et=setTimeout(()=>{be=0},400)})});let tt=!1;document.addEventListener("click",()=>{!tt&&typeof Tone<"u"&&Tone.context.state==="suspended"&&(Tone.start(),tt=!0,console.log("AudioContext resumed by user gesture."));const e=document.getElementById("user-menu-dropdown");e&&!e.classList.contains("hidden")&&e.classList.add("hidden")}),ge(),F(),C(),new Sortable(l.dashboardGrid,{animation:150,handle:".drag-handle",ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",onEnd:()=>{o.layout=[...l.dashboardGrid.children].map(e=>e.dataset.cardId),o.save("layout")}});const ot=new Tone.NoiseSynth({noise:{type:"white"},envelope:{attack:.001,decay:.005,sustain:0}}).toDestination(),st=new Tone.NoiseSynth({noise:{type:"pink"},envelope:{attack:.001,decay:.015,sustain:0}}).toDestination(),nt=new Tone.Filter(4e3,"highpass").toDestination();ot.connect(nt),st.connect(nt);let ve=0,Le=0,Ie=!1;setInterval(()=>{const e=l.dashboardGrid.querySelector('[data-card-id="countdown"]');if(e&&y.countdown.render&&y.countdown.render(e),o.settings.tickingSoundEnabled?(ve++,ve>=60&&(Ie?st.triggerAttackRelease("32n",void 0,.1):ot.triggerAttackRelease("32n",void 0,.15),e&&(e.style.transform="scale(1.04)",e.style.transition="transform 0.1s ease-out",setTimeout(()=>{e.style.transform="scale(1)"},100)),Ie=!Ie,ve=0)):ve=0,Le++,Le>=30){const s=l.dashboardGrid.querySelector('[data-card-id="quote"]');if(s&&y.quote.render){const n=s.querySelector("#quote-card-content");n?(n.style.transition="opacity 0.5s ease",n.style.opacity="0",setTimeout(()=>{y.quote.render(s),n.style.opacity="1"},500)):y.quote.render(s)}Le=0}const t=l.dashboardGrid.querySelector('[data-card-id="time"]');t&&y.time.render&&y.time.render(t)},1e3);const Me=document.getElementById("info-modal"),qt=Me.querySelectorAll(".tab-btn"),At=Me.querySelectorAll(".tab-content");Me.addEventListener("click",e=>{const t=e.target.closest(".tab-btn");if(!t)return;const s=t.dataset.tab;qt.forEach(n=>{n.classList.toggle("active",n.dataset.tab===s)}),At.forEach(n=>{n.classList.toggle("hidden",n.id!==`tab-${s}`)})});const xe=document.getElementById("super-focus-overlay"),at=document.querySelectorAll(".focus-tab-btn"),Pt=document.querySelectorAll(".focus-view"),Nt=document.getElementById("toggle-focus-fullscreen"),rt=document.getElementById("focus-clock-display"),it=document.getElementById("focus-date-display"),te=document.getElementById("focus-quote-display"),lt=document.getElementById("focus-big-timer"),Ot=document.getElementById("focus-timer-toggle"),Rt=document.getElementById("focus-timer-reset"),dt=document.getElementById("dashboard-timer-display"),Ht=document.getElementById("dash-timer-toggle"),Ft=document.getElementById("dash-timer-reset"),ct=document.querySelectorAll(".timer-mode-btn"),De=document.getElementById("focus-dashboard-tasks"),ut=document.getElementById("focus-dash-add-task");let oe="pomodoro",de=null,Se=0;const mt=()=>{l.body.style.backgroundImage&&(xe.style.backgroundImage=l.body.style.backgroundImage),xe.classList.remove("hidden"),pt("clock"),ft(!0),Ut(),$e()};document.getElementById("exit-super-focus").addEventListener("click",()=>{xe.classList.add("hidden"),de&&clearInterval(de),document.fullscreenElement&&document.exitFullscreen().catch(e=>console.log(e)),C()}),Nt.addEventListener("click",()=>{document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen().catch(e=>console.log(e)):document.documentElement.requestFullscreen().catch(e=>console.log(e))});function gt(){let e=!1;if(!o.customCards.some(t=>t.type==="pomodoro")){const t={id:`custom-${Date.now()}-pom`,type:"pomodoro",title:"Pomodoro",content:[]};o.customCards.push(t),o.layout.push(t.id),o.pomodoroState[t.id]={mode:"pomodoro",time:1500,isRunning:!1,durations:{pomodoro:25,shortBreak:5,longBreak:15}},e=!0}if(!o.customCards.some(t=>t.type==="time-logger")){const t={id:`custom-${Date.now()}-log`,type:"time-logger",title:"Study Logger",content:[]};o.customCards.push(t),o.layout.push(t.id),o.timeLoggerState[t.id]={isRunning:!1,accumulatedTime:0,currentSubject:"Physics"},e=!0}e&&(o.save("customCards"),o.save("layout"),o.save("pomodoroState"),o.save("timeLoggerState"),C(),console.log("Auto-added missing timer cards for Focus Mode."))}at.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.view;if((t==="timer"||t==="dashboard")&&(gt(),t==="timer")){const s=o.customCards.some(a=>a.type==="pomodoro"),n=o.customCards.some(a=>a.type==="time-logger");!s&&oe==="pomodoro"&&Be("logger"),!n&&oe==="logger"&&Be("pomodoro")}pt(t)})});function pt(e){at.forEach(t=>t.classList.toggle("active",t.dataset.view===e)),Pt.forEach(t=>t.classList.add("hidden")),document.getElementById(`focus-view-${e}`).classList.remove("hidden")}ct.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.mode;gt(),Be(t)})});function Be(e){oe=e,ct.forEach(t=>t.classList.toggle("active",t.dataset.mode===e)),ce()}function ce(){let e="00:00",t=!1,s=null;if(oe==="pomodoro"){const r=o.customCards.find(i=>i.type==="pomodoro");if(r){s=r.id;const i=o.pomodoroState[s];if(i){const d=Math.floor(i.time/60).toString().padStart(2,"0"),c=(i.time%60).toString().padStart(2,"0");e=`${d}:${c}`,t=i.isRunning}}}else{const r=o.customCards.find(i=>i.type==="time-logger");if(r){s=r.id;const i=o.timeLoggerState[s];if(i){let d=i.accumulatedTime;if(i.isRunning&&i.startTime){const c=Math.round((Date.now()-i.startTime)/1e3);d+=c}e=Ee(d),t=i.isRunning}}}lt&&(lt.textContent=e),dt&&(dt.textContent=e);const n=t?"PAUSE":"START",a=t?"#2C2D33":"grey";[Ot,Ht].forEach(r=>{r&&(r.textContent=n,r.style.backgroundColor=a,r.onclick=()=>Gt(s,oe))}),[Rt,Ft].forEach(r=>{r&&(r.onclick=()=>zt(s,oe))})}function Gt(e,t){e&&(t==="pomodoro"?K.toggle(e):window.timeLogger.toggle(e),setTimeout(ce,50))}function zt(e,t){e&&(t==="pomodoro"?K.reset(e):window.timeLogger.reset(e),setTimeout(ce,50))}function ft(e=!1){if(!te)return;const t=o.settings.theme==="alakh-pandey"?O:q,s=t[Math.floor(Math.random()*t.length)];e?(te.textContent=`"${s.text}"`,te.style.opacity=1):(te.style.opacity=0,setTimeout(()=>{te.textContent=`"${s.text}"`,te.style.opacity=1},800))}function Ut(){de&&clearInterval(de),Se=0,de=setInterval(()=>{const e=new Date;rt&&(rt.textContent=e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1})),it&&(it.textContent=e.toLocaleDateString([],{weekday:"long",month:"long",day:"numeric"})),xe.classList.contains("hidden")||ce(),Se++,Se>=10&&(ft(),Se=0)},1e3),ce()}function $e(){if(!De)return;De.innerHTML="";let e=o.customCards.find(t=>t.type==="todo");e||(e={id:`custom-${Date.now()}-todo`,type:"todo",title:"Tasks",content:[]},o.customCards.push(e),o.layout.push(e.id),o.save("customCards"),o.save("layout"),C()),e&&e.content&&e.content.forEach(t=>{if(!t.completed){const s=document.createElement("li");s.className="flex items-center gap-3 p-3 bg-white/5 rounded-lg hover:bg-white/10 cursor-pointer group transition-all",s.innerHTML=`

                    <div class="w-4 h-4 rounded-full border border-white/40 group-hover:border-green-400 group-hover:bg-green-400/20 transition-colors"></div>

                    <span class="text-sm text-white/80 group-hover:text-white transition-colors">${t.text}</span>

                `,s.addEventListener("click",()=>{t.completed=!0,o.save("customCards"),s.style.opacity="0",setTimeout($e,200)}),De.appendChild(s)}})}ut&&ut.addEventListener("keypress",e=>{if(e.key==="Enter"&&e.target.value.trim()){let t=o.customCards.find(s=>s.type==="todo");t||(t={id:`custom-${Date.now()}`,type:"todo",title:"Tasks",content:[]},o.customCards.push(t)),t.content.push({text:e.target.value.trim(),completed:!1}),o.save("customCards"),$e(),e.target.value=""}});const ht=document.getElementById("static-focus-btn");ht&&ht.addEventListener("click",mt);const yt=document.querySelector(".default-header .flex.items-center.space-x-2");if(yt){const e=document.createElement("button");e.id="open-focus-mode-btn",e.className="bg-gray-700/50 hover:bg-gray-600/60 text-white font-bold p-2 rounded-full transition-colors text-sm",e.title="Super Focus Mode",e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>',e.addEventListener("click",mt);const t=document.getElementById("zen-mode-btn");yt.insertBefore(e,t)}const ue=document.getElementById("shortcuts-modal"),bt=document.getElementById("close-shortcuts-modal");bt&&bt.addEventListener("click",()=>{ue.classList.add("hidden")}),document.addEventListener("keydown",e=>{const t=document.activeElement.tagName,s=t==="INPUT"||t==="TEXTAREA"||t==="SELECT"||document.activeElement.isContentEditable;if(e.key==="Escape"){if(s){document.activeElement.blur();return}Object.values(l.modals).forEach(a=>a.classList.add("hidden")),ue&&ue.classList.add("hidden"),document.getElementById("mobile-alert")&&document.getElementById("mobile-alert").classList.add("hidden");return}if(s)return;switch(e.key.toLowerCase()){case" ":e.preventDefault();let a=o.activeTimer.cardId,r=o.activeTimer.type;if(!a){const d=o.customCards.find(c=>c.type==="pomodoro");d&&(a=d.id,r="pomodoro")}a&&r&&(r==="pomodoro"&&K.toggle(a),r==="time-logger"&&window.timeLogger.toggle(a));break;case"z":l.body.classList.toggle("zen-mode");const i=l.body.classList.contains("zen-mode");l.buttons.exitZenBtn.classList.toggle("hidden",!i);break;case"?":case"/":ue&&ue.classList.remove("hidden");break}});const Jt=()=>{if(!window.driver?.js?.driver){console.warn("Driver.js not loaded");return}const e=document.getElementById("info-modal");e&&e.classList.add("hidden");const t=document.getElementById("customize-modal");t&&t.classList.add("hidden"),setTimeout(()=>{const s=window.driver.js.driver,n=o.settings.ricedModeEnabled,a=n?".top-bar":".default-header",i=[{element:n?"#main-title-riced":"#main-title",popover:{title:"Welcome to StudyLocus",description:"Your personal JEE/NEET command center. Drag cards to reorder them.",side:"bottom",align:"start"}},{element:"#dashboard-grid",popover:{title:"Your Workspace",description:"This is where your study tools live.",side:"top"}},{element:`${a} .add-card-btn`,popover:{title:"Add Widgets",description:"Click here to add To-Do lists, Timers, Graphs, or YouTube videos.",side:"bottom"}},{element:`${a} .customize-btn`,popover:{title:"Customise",description:"Change themes, fonts, wallpapers, and set your Exam Goal here. (IMPORTANT)",side:"bottom"}},{element:`${a} .zen-mode-btn`,popover:{title:"Zen Mode",description:"Hide everything except your dashboard for deep focus.",side:"bottom"}},{element:".fab-container",popover:{title:"Quick Tools",description:"Fast access to Syllabus Tracker and Zenith.",side:"left"}},{element:n?"#auth-container-riced":"#auth-container",popover:{title:"Cloud Sync & Backup",description:"Sign in with Google to save your dashboard, tasks, and settings to the cloud. Never lose your progress and access your study space from any device! NOT COMPULSORY :)",side:"left",align:"center"}},{element:n?"#main-title-riced":"#main-title",popover:{title:"Well, good luck with your preparation!",description:"If you like the project, share it with others and follow me on github pls ðŸ™‚",side:"bottom",align:"center"}}].filter(c=>{const u=document.querySelector(c.element);return u&&(u.offsetWidth>0||u.offsetHeight>0)}),d=s({showProgress:!0,animate:!0,allowClose:!0,overlayClickNext:!1,popoverClass:"driverjs-theme",steps:i,onDestroyStarted:()=>{localStorage.setItem("tutorialSeen_v2","true"),d.destroy()}});d.drive()},300)};window.startTutorial=Jt;const je=document.querySelectorAll(".settings-nav-btn"),Yt=document.querySelectorAll(".settings-panel");je.forEach(e=>{e.addEventListener("click",()=>{je.forEach(n=>n.classList.remove("active")),e.classList.add("active"),Yt.forEach(n=>n.classList.add("hidden"));const t=`panel-${e.dataset.target}`,s=document.getElementById(t);s&&s.classList.remove("hidden")})});const vt=document.querySelectorAll(".view-tab-btn"),Vt=[document.getElementById("view-dashboard"),document.getElementById("view-statistics"),document.getElementById("view-calendar")];vt.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.target,s=`view-${t}`;vt.forEach(n=>n.classList.remove("active")),e.classList.add("active"),Vt.forEach(n=>{n&&(n.id===s?n.classList.remove("hidden"):n.classList.add("hidden"))}),t==="statistics"&&typeof xt=="function"&&xt(),t==="calendar"&&typeof St<"u"&&St.init()})});const z={trend:null,subject:null,performance:null,radar:null};function xt(){const e=o.studyLogs||{},t={},s={},n=[0,0,0,0,0,0,0];let a=0,r=0;const i=Object.keys(e).sort();R(new Date),Object.entries(e).forEach(([D,f])=>{let E=0;const j=new Date(D).getDay();Object.entries(f).forEach(([I,V])=>{t[I]=(t[I]||0)+V,E+=V,a+=V}),E>0&&(s[D]=E,n[j]+=E,r++)});let d=0,c=new Date,u=R(c);for(s[u]||(c.setDate(c.getDate()-1),u=R(c));s[u];)d++,c.setDate(c.getDate()-1),u=R(c);document.getElementById("stat-streak").innerText=`${d} Days`;let m=0,g="C";if(r>2){const D=Object.values(s).slice(-14),f=D.reduce((I,V)=>I+V,0)/D.length,E=D.reduce((I,V)=>I+Math.pow(V-f,2),0)/D.length,j=Math.sqrt(E)/f;m=Math.max(0,Math.min(100,100-j*100)),m>80?g="A":m>60?g="B":m>40?g="C":g="D"}document.getElementById("stat-consistency").innerText=`${Math.round(m)}%`,document.getElementById("stat-consistency-grade").innerText=g,document.getElementById("stat-consistency-grade").className=`h-12 w-12 rounded-full border-4 flex items-center justify-center text-xs font-bold ${m>60?"border-green-500/30 text-green-400":"border-blue-500/30 text-blue-400"}`;const v=document.getElementById("ypt-prev-btn"),p=document.getElementById("ypt-next-btn");v&&(v.onclick=()=>{Q.setMonth(Q.getMonth()-1),qe()}),p&&(p.onclick=()=>{Q.setMonth(Q.getMonth()+1),qe()}),qe(),document.getElementById("stat-total-time").innerText=re(a);const h=r>0?Math.round(a/r):0;document.getElementById("stat-daily-avg").innerText=re(h);const S=o.settings.userSubjects||["Physics","Chemistry","Maths"],w=i.slice(-7),M=new Set;w.forEach(D=>{Object.keys(e[D]).forEach(f=>M.add(f))});const L=S.filter(D=>!M.has(D)&&D!=="Pomodoro"),b=document.getElementById("neglect-container");L.length>0?(b.classList.remove("hidden"),document.getElementById("stat-neglected-subjects").innerText=`No logs recently: ${L.slice(0,3).join(", ")}`):b.classList.add("hidden");const x=o.customCards.find(D=>D.type==="line-graph"),T=x?x.content||[]:[];let B={name:"-",avg:-1},Y={name:"-",avg:999};const $={},ee={};T.forEach(D=>{D.subjects&&Object.entries(D.subjects).forEach(([f,E])=>{$[f]=($[f]||0)+E,ee[f]=(ee[f]||0)+1})}),Object.keys($).forEach(D=>{const f=$[D]/ee[D];f>B.avg&&(B={name:D,avg:f}),f<Y.avg&&(Y={name:D,avg:f})}),B.name===Y.name&&B.name!=="-"&&(Y={name:"None",avg:0}),document.getElementById("stat-strongest-sub").innerText=B.name,document.getElementById("stat-weakest-sub").innerText=Y.name,Wt(s),_t(t),Kt(T),Zt(n)}function Wt(e){const t=document.getElementById("stats-trend-chart").getContext("2d"),s=[],n=[];let a=0;for(let i=29;i>=0;i--){const d=new Date;d.setDate(d.getDate()-i);const c=R(d);s.push(d.toLocaleDateString("en-US",{day:"numeric",month:"short"}));const u=e[c]||0;n.push((u/3600).toFixed(1)),a+=u}document.getElementById("stat-total-trend").innerText=`30d Total: ${re(a)}`,z.trend&&z.trend.destroy();const r=t.createLinearGradient(0,0,0,400);r.addColorStop(0,"rgba(59, 130, 246, 0.5)"),r.addColorStop(1,"rgba(59, 130, 246, 0)"),z.trend=new Chart(t,{type:"line",data:{labels:s,datasets:[{label:"Hours",data:n,borderColor:"#3b82f6",backgroundColor:r,fill:!0,tension:.4,pointRadius:0,pointHoverRadius:6}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1}},scales:{y:{border:{display:!1},grid:{color:"rgba(255,255,255,0.05)"}},x:{grid:{display:!1},ticks:{maxTicksLimit:10}}}}})}function _t(e){const t=document.getElementById("stats-subject-chart").getContext("2d"),s=Object.keys(e),n=Object.values(e).map(r=>(r/3600).toFixed(1)),a=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#ec4899"];z.subject&&z.subject.destroy(),z.subject=new Chart(t,{type:"doughnut",data:{labels:s,datasets:[{data:n,backgroundColor:a,borderWidth:0,hoverOffset:10}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"75%",plugins:{legend:{position:"right",labels:{color:"#9ca3af",boxWidth:10,font:{size:10}}}}}})}function Kt(e){const t=document.getElementById("stats-performance-chart").getContext("2d"),s=e.slice(-5),n=s.map(i=>i.name.substring(0,8)),a=s.map(i=>i.total||i.marks),r=s.length>0?s[0].maxMarks:300;z.performance&&z.performance.destroy(),z.performance=new Chart(t,{type:"bar",data:{labels:n,datasets:[{label:"Score",data:a,backgroundColor:"#8b5cf6",borderRadius:4,barThickness:20}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{display:!1,max:parseFloat(r)},x:{grid:{display:!1},ticks:{color:"#6b7280",font:{size:9}}}}}})}function Zt(e){const t=document.getElementById("stats-radar-chart").getContext("2d"),s=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],n=e.map(d=>(d/3600).toFixed(1)),a=Math.max(...e),r=e.indexOf(a);let i="Balanced Scholar";a===0?i="Ghost Mode":r===0||r===6?i="Weekend Warrior":e[1]>0&&e[5]>0&&(i="Daily Grinder"),document.getElementById("stat-day-persona").innerText=`Study Persona: ${i}`,z.radar&&z.radar.destroy(),z.radar=new Chart(t,{type:"radar",data:{labels:s,datasets:[{label:"Study Hours",data:n,backgroundColor:"rgba(245, 158, 11, 0.2)",borderColor:"rgba(245, 158, 11, 0.8)",pointBackgroundColor:"#fff",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"rgba(245, 158, 11, 1)"}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{r:{angleLines:{color:"rgba(255, 255, 255, 0.1)"},grid:{color:"rgba(255, 255, 255, 0.1)"},pointLabels:{color:"#9ca3af",font:{size:10}},ticks:{display:!1,backdropColor:"transparent"}}},plugins:{legend:{display:!1}}}})}const St={currentDate:new Date,listenersAttached:!1,init(){this.render(),this.listenersAttached||(this.attachHeaderListeners(),this.listenersAttached=!0)},getDailyTasksCard(){let e=o.customCards.find(t=>t.type==="daily-tasks");return e||(e={id:`custom-${Date.now()}-daily`,type:"daily-tasks",title:"Daily Schedule",content:{}},o.customCards.push(e),o.layout.push(e.id)),(Array.isArray(e.content)||!e.content)&&(e.content={}),e},render(){const e=document.getElementById("calendar-grid");if(!e)return;e.innerHTML="";const t=this.currentDate.getFullYear(),s=this.currentDate.getMonth();document.getElementById("cal-month-name").innerText=this.currentDate.toLocaleString("default",{month:"long"}),document.getElementById("cal-year-name").innerText=t;const a=(new Date(t,s,1).getDay()+6)%7,r=42,i=this.getDailyTasksCard(),d=i.content,c=R(new Date);for(let u=0;u<r;u++){const m=new Date(t,s,1+(u-a)),g=R(m),v=g===c,p=m.getMonth()===s,h=document.createElement("div");h.className=`cal-day-cell ${v?"today":""} ${p?"":"other-month"}`,h.dataset.date=g;const S=document.createElement("span");S.className="cal-day-header",S.textContent=m.getDate(),h.appendChild(S);const w=document.createElement("div");w.className="cal-task-container",w.dataset.date=g,(d[g]||[]).forEach((L,b)=>{const x=document.createElement("div");x.className=`cal-task-pill ${L.completed?"completed":""}`,x.dataset.index=b,x.dataset.priority=L.priority||"medium",x.innerHTML=`<span>${L.text}</span>`,w.appendChild(x)}),h.appendChild(w),e.appendChild(h),this.makeSortable(w),h.addEventListener("click",L=>{if(L.target.closest(".cal-task-pill"))return;const b=document.querySelector('[data-target="dashboard"]');b&&b.click(),setTimeout(()=>{const x=document.querySelector(`[data-card-id="${i.id}"]`);if(x){x.scrollIntoView({behavior:"smooth",block:"center"}),x.style.transition="box-shadow 0.5s",x.style.boxShadow="0 0 20px var(--accent-color)",setTimeout(()=>x.style.boxShadow="",1500);const T=x.querySelector(".daily-date-selector");T&&(T.value=g,x.dataset.selectedDate=g,y["daily-tasks"]&&y["daily-tasks"].render(x,i))}},100)})}},makeSortable(e){new Sortable(e,{group:"calendar-tasks",animation:150,ghostClass:"sortable-ghost",delay:150,delayOnTouchOnly:!0,onEnd:t=>{const s=t.from.dataset.date,n=t.to.dataset.date,a=t.oldIndex,r=t.newIndex;s===n&&a===r||this.moveTask(s,n,a,r)}})},moveTask(e,t,s,n){const a=this.getDailyTasksCard(),r=a.content[e],[i]=r.splice(s,1);r.length===0&&delete a.content[e],a.content[t]||(a.content[t]=[]),a.content[t].splice(n,0,i),o.save("customCards"),C()},attachHeaderListeners(){const e=document.getElementById("cal-prev-btn"),t=document.getElementById("cal-next-btn"),s=document.getElementById("cal-today-btn");e&&e.addEventListener("click",()=>{this.currentDate.setMonth(this.currentDate.getMonth()-1),this.render()}),t&&t.addEventListener("click",()=>{this.currentDate.setMonth(this.currentDate.getMonth()+1),this.render()}),s&&s.addEventListener("click",()=>{this.currentDate=new Date,this.render()})}},wt=document.getElementById("dev-json-input"),X=document.getElementById("dev-save-btn"),Qt=()=>({settings:o.settings,layout:o.layout,customCards:o.customCards,tests:o.tests,cardProps:o.cardProps,pomodoroState:o.pomodoroState,timeLoggerState:o.timeLoggerState,studyLogs:o.studyLogs});je.forEach(e=>{e.addEventListener("click",()=>{if(e.dataset.target==="developer"){const t=Qt();wt.value=JSON.stringify(t,null,2)}})}),X&&X.addEventListener("click",()=>{try{const e=wt.value,t=JSON.parse(e);if(!t.layout||!t.customCards)throw new Error("Missing core data (layout or customCards).");Object.assign(o,t),Object.keys(t).forEach(n=>{k[n]&&localStorage.setItem(k[n],JSON.stringify(t[n]))}),P&&(G("Syncing Dev Changes..."),pe()),F(),C();const s=X.textContent;X.textContent="Saved!",X.classList.add("bg-green-600","border-green-500"),setTimeout(()=>{X.textContent=s,X.classList.remove("bg-green-600","border-green-500")},1500)}catch(e){alert("JSON Error: "+e.message)}}),window.addEventListener("beforeunload",()=>{let e=!1;Object.keys(o.timeLoggerState).forEach(t=>{const s=o.timeLoggerState[t];if(s.isRunning&&s.startTime){const n=Math.round((Date.now()-s.startTime)/1e3);s.accumulatedTime+=n,s.intervalId=null,e=!0}}),e&&localStorage.setItem("jeeTimeLoggerState_v1",JSON.stringify(o.timeLoggerState))});function qe(){const e=document.getElementById("ypt-grid"),t=document.getElementById("ypt-month-label");if(!e||!t)return;e.innerHTML="";const s=Q.getFullYear(),n=Q.getMonth();t.textContent=Q.toLocaleString("default",{month:"long",year:"numeric"}).toUpperCase();const a=new Date(s,n,1),i=new Date(s,n+1,0).getDate();let d=(a.getDay()+6)%7;for(let p=0;p<d;p++){const h=document.createElement("div");h.className="ypt-cell empty",e.appendChild(h)}const c=10*3600,m=getComputedStyle(document.documentElement).getPropertyValue("--accent-color").trim()||"#3b82f6",v=(p=>{const h=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(p);return h?`${parseInt(h[1],16)}, ${parseInt(h[2],16)}, ${parseInt(h[3],16)}`:"59, 130, 246"})(m);for(let p=1;p<=i;p++){const h=`${s}-${String(n+1).padStart(2,"0")}-${String(p).padStart(2,"0")}`;let S=0;if(o.studyLogs&&o.studyLogs[h]){const b=o.studyLogs[h];typeof b=="number"?S=b:typeof b=="object"&&(S=Object.values(b).reduce((x,T)=>x+T,0))}const w=document.createElement("div");w.className="ypt-cell";let M="OFF",L="empty-text";if(S>0){let x=.15+Math.min(1,S/c)*.8;w.style.backgroundColor=`rgba(${v}, ${x})`,w.style.borderColor=`rgba(${v}, 1)`,w.style.color=x>.6?"#000":"#fff";const T=Math.floor(S/3600),B=Math.floor(S%3600/60);M=`${T}h ${B}m`,L=""}else w.style.color="var(--text-secondary)";w.innerHTML=`
                <span class="ypt-date">${p}</span>
                <span class="ypt-time ${L}">${M}</span>
            `,e.appendChild(w)}}});
