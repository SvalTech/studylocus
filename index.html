<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyLocus | Customizable Dashboard for JEE & NEET Prep</title>
    <meta name="description" content="A customizable dashboard for students preparing for JEE, NEET, and other competitive exams. Track your progress with a journey graph, manage tasks with to-do lists, and stay focused with a Pomodoro timer.">
    <meta name="keywords" content="JEE dashboard, NEET dashboard, study planner, exam preparation, Pomodoro timer, syllabus tracker, mock test analysis, student dashboard, JEE 2026, NEET 2026, study logger">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://sval.tech/studylocus/">
    <meta property="og:title" content="StudyLocus | Customizable Dashboard for JEE & NEET Prep">
    <meta property="og:description" content="A customizable dashboard for students preparing for JEE, NEET, and other competitive exams. Track your progress, manage tasks, and stay focused.">
    <meta property="og:image" content="https://i.ibb.co/5Wm282XC/logo1.png">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://sval.tech/studylocus/">
    <meta property="twitter:title" content="StudyLocus | Customizable Dashboard for JEE & NEET Prep">
    <meta property="twitter:description" content="A customizable dashboard for students preparing for JEE, NEET, and other competitive exams. Track your progress, manage tasks, and stay focused.">
    <meta property="twitter:image" content="https://i.ibb.co/5Wm282XC/logo1.png">
    
    <link rel="canonical" href="https://sval.tech/studylocus/" />
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&family=Fira+Code&family=Inter:wght@400;600;700&family=Roboto+Slab&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
		/* STEP 1: INCREASE GLOBAL ROUNDING, GLASSMORPHISM, AND ACCENT BORDER */
		:root,[data-theme=alakh-pandey],[data-theme=dracula],[data-theme=forest],[data-theme=ocean],[data-theme=rose-gold],[data-theme=sunset]{--card-shadow:0 4px 12px rgba(0,0,0,0.3)}.day,.tab-btn{cursor:pointer}#bg-overlay,.aspect-w-16>*,.modal-overlay{right:0;bottom:0;top:0}#customize-modal.modal-overlay,#info-modal.modal-overlay{align-items:flex-start;padding-top:2rem;padding-bottom:2rem;overflow-y:auto}#customize-modal.modal-overlay>.card,#info-modal.modal-overlay>.card{flex-shrink:0}.tab-nav{display:flex;border-bottom:1px solid var(--border-color);margin-bottom:1.5rem}.tab-btn{padding:.75rem .5rem;border:none;background-color:transparent;color:var(--text-secondary);font-size:.9rem;font-weight:600;border-bottom:3px solid transparent;transition:.2s;flex:1;word-break:break-word;line-height:1.3;text-align:center}.card,.form-input,.tab-btn:hover,body,select.form-input option{color:var(--text-primary)}.day .tooltip,.modal-overlay{transition:opacity .3s;pointer-events:none}.tab-btn.active{color:var(--accent-color);border-bottom-color:var(--accent-color)}.tab-content{animation:.3s ease-in-out fadeIn}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}:root{--bg-color:#0d1117;--card-bg-color:rgba(22, 27, 34, 0.4); /* Reduced opacity for heavy glassmorphism */
    --border-color:#30363d;
    --text-primary:#c9d1d9;
    --text-secondary:#8b949e;
    --accent-color:#58a6ff;
    --accent-glow:0 0 15px rgba(88, 166, 255, 0.3);
    --font-family:'Inter',sans-serif;
    --day-past-color:#21262d;
    --day-future-color:#0e4429;
    --day-today-color:#1a633a;
    --day-exam-color:#9e2a2b;
    --day-part-test-color:#1f6feb}[data-theme=light]{--bg-color:#f0f0f0;--card-bg-color:rgba(255, 255, 255, 0.4); /* Reduced opacity for heavy glassmorphism */
    --border-color:#d1d5db;
    --text-primary:#1f2937;
    --text-secondary:#4b5563;
    --accent-color:#3b82f6;
    --accent-glow:0 0 15px rgba(59, 130, 246, 0.4);
    --card-shadow:0 4px 12px rgba(0,0,0,0.1);
    --day-past-color:#ebedf0;
    --day-future-color:#9be9a8;
    --day-today-color:#40c463;
    --day-exam-color:#da5252;
    --day-part-test-color:#58a6ff}[data-theme=cyberpunk]{--bg-color:#0c0a24;--card-bg-color:rgba(23, 0, 61, 0.3); /* Reduced opacity */
    --border-color:#ff00f2;
    --text-primary:#00f7ff;
    --text-secondary:#faff00;
    --accent-color:#ff00f2;
    --accent-glow:0 0 20px rgba(255, 0, 242, 0.5);
    --card-shadow:0 0 10px rgba(255, 0, 242, 0.3);
    --day-past-color:#180f3d;
    --day-future-color:#5d00ff;
    --day-today-color:#00f7ff;
    --day-exam-color:#ff00f2;
    --day-part-test-color:#faff00}[data-theme=forest]{--bg-color:#1a201a;--card-bg-color:rgba(32, 42, 32, 0.4); /* Reduced opacity */
    --border-color:#4a5c4a;
    --text-primary:#d4e0d4;
    --text-secondary:#8a9c8a;
    --accent-color:#6a9c6a;
    --accent-glow:0 0 15px rgba(106, 156, 106, 0.4);
    --day-past-color:#2f3e2f;
    --day-future-color:#4a5c4a;
    --day-today-color:#9ae6b4;
    --day-exam-color:#c53030;
    --day-part-test-color:#63b3ed}[data-theme=rose-gold]{--bg-color:#4a1c2b;--card-bg-color:rgba(107, 48, 64, 0.4); /* Reduced opacity */
    --border-color:#b97a8d;
    --text-primary:#f5e5e8;
    --text-secondary:#d4b2bb;
    --accent-color:#f5c6d3;
    --accent-glow:0 0 15px rgba(245, 198, 211, 0.4);
    --day-past-color:#6b3040;
    --day-future-color:#b97a8d;
    --day-today-color:#f5e5e8;
    --day-exam-color:#ff6d6d;
    --day-part-test-color:#f5c6d3}[data-theme=ocean]{--bg-color:#0d1b2a;--card-bg-color:rgba(27, 38, 59, 0.4); /* Reduced opacity */
    --border-color:#415a77;
    --text-primary:#e0e1dd;
    --text-secondary:#778da9;
    --accent-color:#61a5c2;
    --accent-glow:0 0 15px rgba(97, 165, 194, 0.4);
    --day-past-color:#1b263b;
    --day-future-color:#415a77;
    --day-today-color:#e0e1dd;
    --day-exam-color:#ff6b6b;
    --day-part-test-color:#61a5c2}[data-theme=sunset]{--bg-color:#2c0e37;--card-bg-color:rgba(74, 29, 89, 0.4); /* Reduced opacity */
    --border-color:#83387a;
    --text-primary:#f8f3f9;
    --text-secondary:#e4a1d4;
    --accent-color:#ff6d6d;
    --accent-glow:0 0 15px rgba(255, 109, 109, 0.4);
    --day-past-color:#4a1d59;
    --day-future-color:#83387a;
    --day-today-color:#f8f3f9;
    --day-exam-color:#e4a1d4;
    --day-part-test-color:#ff6d6d}[data-theme=dracula]{--bg-color:#282a36;--card-bg-color:rgba(68, 71, 90, 0.45); /* Reduced opacity */
    --border-color:#6272a4;
    --text-primary:#f8f8f2;
    --text-secondary:#bd93f9;
    --accent-color:#ff79c6;
    --accent-glow:0 0 15px rgba(255, 121, 198, 0.4);
    --day-past-color:#44475a;
    --day-future-color:#6272a4;
    --day-today-color:#50fa7b;
    --day-exam-color:#ff5555;
    --day-part-test-color:#bd93f9}[data-theme=alakh-pandey]{--bg-color:#1e1e1e;--card-bg-color:rgba(40, 40, 40, 0.4); /* Reduced opacity */
    --border-color:#f5cb5c;
    --text-primary:#ffffff;
    --text-secondary:#e0e0e0;
    --accent-color:#f5cb5c;
    --accent-glow:0 0 15px rgba(245, 203, 92, 0.4);
    --day-past-color:#333533;
    --day-future-color:#4f4f4f;
    --day-today-color:#f5cb5c;
    --day-exam-color:#cf6679;
    --day-part-test-color:#bb86fc}[data-theme=chaitanya-noob]{--bg-color:#000000;--card-bg-color:transparent;--border-color:#39ff14;--text-primary:#39ff14;--text-secondary:#ff00ff;--accent-color:#39ff14;--accent-glow:0 0 20px rgba(57, 255, 20, 0.5);--card-shadow:0 0 10px rgba(57, 255, 20, 0.3);--day-past-color:transparent;--day-future-color:transparent;--day-today-color:transparent;--day-exam-color:transparent;--day-part-test-color:transparent}[data-theme=god-mode]{--bg-color:#000000;--card-bg-color:rgba(10, 20, 10, 0.7);--border-color:#00ff00;--text-primary:#00ff00;--text-secondary:#008000;--accent-color:#00ff00;--font-family:'Fira Code',monospace;--day-past-color:#002000;--day-future-color:#004000;--day-today-color:#00ff00;--day-exam-color:#ff0000;--day-part-test-color:#00ffff}[data-theme=chaitanya-noob] .card{backdrop-filter:none;-webkit-backdrop-filter:none}[data-theme=chaitanya-noob] .graph-container .day{border:none!important}[data-theme=chaitanya-noob] .graph-container .day::before{content:'🤓';font-size:12px;line-height:14px;display:block;text-align:center}[data-theme=chaitanya-noob] .graph-container .day-today{border:1px solid var(--accent-color)!important}body{font-family:var(--font-family);background-color:var(--bg-color);background-size:cover;background-position:center;background-attachment:fixed;text-shadow:0 1px 2px rgba(0,0,0,.5);transition:background-color .5s,background-image .5s}#bg-overlay{position:fixed;left:0;background-color:rgba(0,0,0,.5);z-index:-1}.graph-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(14px,1fr));grid-auto-rows:14px;grid-gap:3px;overflow-x:auto}.day{width:14px;height:14px;border-radius:3px;position:relative}

/* --- RESTORED JOURNEY GRAPH STYLES --- */
.day-past{background-color:var(--day-past-color)}
.day-future{background-color:var(--day-future-color)}
.day-today{background-color:var(--day-today-color);border:1px solid var(--accent-color)}
.day-exam{background-color:var(--day-exam-color)}
.day-part-test{background-color:var(--day-part-test-color)}
/* -------------------------------------- */

.day .tooltip{visibility:hidden;width:180px;background-color:#21262d;color:#fff;text-align:center;border-radius:6px;padding:5px 0;position:absolute;z-index:10;bottom:125%;left:50%;margin-left:-90px;opacity:0;font-size:12px;border:1px solid #30363d}.day:hover .tooltip{visibility:visible;opacity:1}#countdown-timer{font-size:1.75rem;font-weight:600}@media (min-width:640px){#countdown-timer{font-size:2.25rem}}@media (min-width:1024px){#countdown-timer{font-size:2.5rem}}.card{background-color:var(--card-bg-color);border:1px solid color-mix(in srgb,var(--accent-color) 40%,var(--border-color)); /* Accent Border */
    border-radius: 24px; /* Increased Corner Radius */
    padding:1.25rem;
    backdrop-filter:blur(20px); /* Increased Blur */
    -webkit-backdrop-filter:blur(20px); /* Increased Blur */
    box-shadow:var(--card-shadow)}.card-header{display:flex;justify-content:space-between;align-items:center;padding:0;margin-bottom:.75rem}.card-header h2{margin-left:.25rem}.card-header-controls{display:flex;align-items:center;gap:.25rem}.card-header-controls button{color:var(--text-secondary);padding:.25rem;border-radius:9999px;transition:color .2s,background-color .2s}.card-header-controls button:hover{color:var(--text-primary);background-color:rgba(255,255,255,.1)}.drag-handle{cursor:grab;padding:.5rem}.sortable-ghost{background:#1f2937;opacity:.6;border:2px dashed var(--accent-color)}.sortable-chosen{cursor:grabbing}.modal-overlay{position:fixed;left:0;background-color:rgba(0,0,0,.5);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:50;opacity:0}.modal-overlay:not(.hidden){opacity:1;pointer-events:auto}.modal-overlay>.card{transform:scale(.95);opacity:0;transition:transform .3s,opacity .3s}.modal-overlay:not(.hidden)>.card{transform:scale(1);opacity:1}.todo-item.completed span{text-decoration:line-through;color:var(--text-secondary)}.form-input{background-color:rgba(0,0,0,.2);border:1px solid var(--border-color);transition:border-color .2s,box-shadow .2s;border-radius: 12px; /* Increased Corner Radius */}.form-input:focus{outline:0;border-color:var(--accent-color);box-shadow:0 0 0 2px color-mix(in srgb,var(--accent-color) 40%,transparent)}.btn-primary{background-color:var(--accent-color);color:#fff;box-shadow:0 2px 5px rgba(0,0,0,.2);border:1px solid transparent;transition:.2s ease-in-out;border-radius: 12px; /* Increased Corner Radius */}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.3),var(--accent-glow)}[data-theme=alakh-pandey] .btn-primary,[data-theme=chaitanya-noob] .btn-primary,[data-theme=cyberpunk] .btn-primary,[data-theme=dracula] .btn-primary,[data-theme=ocean] .btn-primary,[data-theme=rose-gold] .btn-primary,[data-theme=sunset] .btn-primary{color:var(--bg-color)}.text-secondary{color:var(--text-secondary)}select.form-input{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");background-position:right .5rem center;background-repeat:no-repeat;background-size:1.5em 1.5em;padding-right:2.5rem}
/* --- START OF FIX FOR DROPDOWN LEGIBILITY --- */
[data-theme=light] select.form-input { 
    background-color: #f0f0f0; 
    color: var(--text-primary);
} 
select.form-input option {
    /* Use transparent card BG for options for dark themes, allowing custom themes to control the color */
    background: var(--card-bg-color); 
    color: var(--text-primary); 
}
/* For Light Theme Options, force high contrast for legibility when the dropdown list is open */
[data-theme=light] select.form-input option {
    background: #ffffff; 
    color: #1f2937;
}
/* --- END OF FIX FOR DROPDOWN LEGIBILITY --- */
.pomodoro-btn.active,.todo-checkbox:checked,.youtube-container::after{background-color:var(--accent-color)}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}.no-scrollbar::-webkit-scrollbar{display:none}.delete-card-btn:hover{color:#ef4444!important}.pomodoro-btn.active,[data-theme=light] .pomodoro-btn.active{color:#fff}.aspect-w-16{position:relative;padding-bottom:56.25%}.aspect-w-16>*{position:absolute;height:100%;width:100%;left:0}.fab-container{position:fixed;bottom:1.5rem;right:1.5rem;z-index:40}.fab-menu{visibility:hidden;opacity:0;transform:translateY(10px);transition:.2s ease-out;position:absolute;bottom:100%;right:0;margin-bottom:.5rem}.fab-container:hover .fab-menu{visibility:visible;opacity:1;transform:translateY(0)}.todo-checkbox{-webkit-appearance:none;-moz-appearance:none;appearance:none;width:1.25rem;height:1.25rem;border-radius:.25rem;border:1px solid var(--border-color);background-color:transparent;cursor:pointer;position:relative;transition:background-color .2s ease-in-out,border-color .2s ease-in-out}.todo-checkbox:checked{border-color:var(--accent-color)}.todo-checkbox:checked::after{content:'✔';position:absolute;color:#fff;top:50%;left:50%;transform:translate(-50%,-50%);font-size:.8rem}[data-theme=light] .todo-checkbox:checked::after{color:var(--card-bg-color)}body.zen-mode .card-header-controls,body.zen-mode .delete-mark-item,body.zen-mode .delete-test-btn,body.zen-mode .delete-todo-item,body.zen-mode .fab-container,body.zen-mode .log-btn,body.zen-mode .pomodoro-btn,body.zen-mode .pomodoro-settings,body.zen-mode .reset-btn,body.zen-mode footer,body.zen-mode form,body.zen-mode header{display:none}body.zen-mode .card:hover{transform:none;box-shadow:var(--card-shadow)}body.zen-mode .card-header{justify-content:center}.youtube-container{position:relative;border-radius:.375rem;overflow:hidden}.youtube-container::after{content:'';position:absolute;top:0;left:0;width:100%;height:100%;opacity:.2;mix-blend-mode:screen;pointer-events:none;transition:background-color .5s,opacity .5s;z-index:1}.youtube-container.tint-disabled::after{opacity:0}.youtube-iframe{transition:filter .3s ease-in-out}.youtube-container.blurred .youtube-iframe{filter:blur(16px)}.form-input-toggle{-webkit-appearance:none;appearance:none;position:relative;width:38px;height:22px;border-radius:9999px;background-color:rgba(255,255,255,.2);border:1px solid var(--border-color);transition:background-color .2s ease-in-out;cursor:pointer}.form-input-toggle::before{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background-color:#fff;transition:transform .2s ease-in-out}.form-input-toggle:checked{background-color:var(--accent-color)}.form-input-toggle:checked::before{transform:translateX(16px)}.legend-item{display:flex;align-items:center;gap:.5rem}.legend-color{width:12px;height:12px;border-radius:2px}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}@keyframes fall-apart{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}#sync-status{transition:opacity .5s}
        /* ✨ END: Firebase Auth UI Styles */
    </style>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "StudyLocus Dashboard",
      "applicationCategory": "EducationalApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0"
      },
      "author": {
        "@type": "Person",
        "name": "Shaurya Pratap Singh",
        "url": "https://github.com/svalordev"
      },
      "description": "A customizable dashboard for students preparing for JEE, NEET, and other competitive exams. Track your progress with a journey graph, manage tasks with to-do lists, and stay focused with a Pomodoro timer."
    }
    </script>
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TCK0S6VC58"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TCK0S6VC58');
</script>
<body class="antialiased">
    <div id="bg-overlay"></div>
    <div class="container mx-auto px-2 sm:px-4 py-6">
        <header class="flex justify-between items-center mb-6">
            <h1 id="main-title" class="text-3xl sm:text-4xl font-bold cursor-pointer">JEE 2026</h1>
            
            <div class="flex items-center gap-2 sm:gap-4">
                <div class="flex items-center gap-2">
                    <span id="sync-status" class="text-xs text-secondary opacity-0"></span>
                    <div id="auth-container"></div>
                </div>
                <div class="flex items-center space-x-2">
                    
                    <button id="customize-btn" class="bg-gray-700/50 hover:bg-gray-600/60 text-white font-bold rounded-full w-10 h-10 md:w-auto md:rounded-md flex items-center justify-center md:px-4 md:py-2 transition-all text-sm" title="Customize Dashboard" aria-label="Customize Dashboard">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="4" y1="21" y2="14"></line><line x1="4" x2="4" y1="10" y2="3"></line><line x1="12" x2="12" y1="21" y2="12"></line><line x1="12" x2="12" y1="8" y2="3"></line><line x1="20" x2="20" y1="21" y2="16"></line><line x1="20" x2="20" y1="12" y2="3"></line><line x1="1" x2="7" y1="14" y2="14"></line><line x1="9" x2="15" y1="8" y2="8"></line><line x1="17" x2="23" y1="16" y2="16"></line></svg>
                    </button>
                    <button id="add-card-btn" class="btn-primary font-bold rounded-full w-10 h-10 md:w-auto md:rounded-md flex items-center justify-center md:px-4 md:py-2 transition-all text-sm" title="Add New Card" aria-label="Add New Card">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
					<button id="info-btn" class="bg-gray-700/50 hover:bg-gray-600/60 text-white font-bold p-2 rounded-full transition-colors text-sm" title="About this project" aria-label="About this project">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                    </button>
                    <button id="zen-mode-btn" class="bg-gray-700/50 hover:bg-gray-600/60 text-white font-bold p-2 rounded-full transition-colors text-sm" title="Enter Zen Mode" aria-label="Enter Zen Mode">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2Z"></path><path d="m9.5 16.5 4-4"></path><path d="m14.5 16.5-4-4"></path><path d="M12 8V7"></path></svg>
                    </button>
                </div>
            </div>
        </header>

        <main id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            </main>
    </div>

    <button id="exit-zen-btn" class="hidden fixed top-4 right-4 bg-gray-800/50 hover:bg-gray-700/70 backdrop-blur-sm text-white font-bold p-2 rounded-full transition-colors z-50" title="Exit Zen Mode" aria-label="Exit Zen Mode"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>

    <footer class="text-center py-4 mt-4">
        <p class="text-xs text-secondary">
            ©️ <a href="https://github.com/svalordev" target="_blank" rel="noopener noreferrer" class="hover:underline" style="color: var(--accent-color);">Shaurya Pratap Singh</a> 2025 | <a href="https://sval.tech/studylocus/termsandconditions.html" rel="noopener noreferrer" class="hover:underline" style="color: var(--accent-color);">Terms and Conditions</a> 
    </footer>

    <template id="countdown-template">
        <div class="card" data-card-id="countdown">
            <div class="card-header">
                <h2 class="text-lg font-semibold">Countdown</h2>
                <div class="card-header-controls">
                    <button class="toggle-colspan-btn" title="Toggle size" aria-label="Toggle card size"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m6 6v-4m0 4h-4"/><path d="M3 3l6 6"/><path d="M3 3v4m0-4h4"/></svg></button>
                    <span class="drag-handle" aria-label="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
                </div>
            </div>
            <div id="countdown-timer" class="flex justify-center space-x-2 sm:space-x-4 md:space-x-8 text-center py-2">
                <div><div data-value="days" class="font-bold">00</div><div class="text-xs sm:text-sm text-secondary">Days</div></div>
                <div><div data-value="hours" class="font-bold">00</div><div class="text-xs sm:text-sm text-secondary">Hours</div></div>
                <div><div data-value="minutes" class="font-bold">00</div><div class="text-xs sm:text-sm text-secondary">Minutes</div></div>
                <div><div data-value="seconds" class="font-bold">00</div><div class="text-xs sm:text-sm text-secondary">Seconds</div></div>
            </div>
        </div>
    </template>

    <template id="time-template">
        <div class="card" data-card-id="time">
            <div class="card-header">
                <h2 class="text-lg font-semibold">Current Time</h2>
                <div class="card-header-controls">
                    <button class="toggle-colspan-btn" title="Toggle size" aria-label="Toggle card size"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m6 6v-4m0 4h-4"/><path d="M3 3l6 6"/><path d="M3 3v4m0-4h4"/></svg></button>
                    <span class="drag-handle" aria-label="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
                </div>
            </div>
            <div class="text-center py-2">
                <div data-value="time" class="text-3xl font-bold tracking-wider">00:00:00 AM</div>
                <div data-value="date" class="text-sm text-secondary">Sunday, August 17, 2025</div>
            </div>
        </div>
    </template>

    <template id="graph-template">
        <div class="card" data-card-id="graph">
            <div class="card-header">
                <h2 class="text-lg font-semibold">Journey</h2>
                <div class="card-header-controls">
                    <button class="toggle-colspan-btn" title="Toggle size" aria-label="Toggle card size"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m6 6v-4m0 4h-4"/><path d="M3 3l6 6"/><path d="M3 3v4m0-4h4"/></svg></button>
                    <span class="drag-handle" aria-label="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
                </div>
            </div>
            <div class="graph-container no-scrollbar" id="contribution-graph"></div>
            <div class="flex justify-center flex-wrap gap-x-4 gap-y-2 mt-4 text-xs text-secondary">
                <div class="legend-item"><div class="legend-color day-future"></div><span>Future</span></div>
                <div class="legend-item"><div class="legend-color day-today"></div><span>Today</span></div>
                <div class="legend-item"><div class="legend-color day-part-test"></div><span>Test</span></div>
                <div class="legend-item"><div class="legend-color day-exam"></div><span>Exam</span></div>
            </div>
        </div>
    </template>

    <template id="tests-template">
         <div class="card" data-card-id="tests">
             <div class="card-header">
                 <h2 class="text-lg font-semibold">Test Planner</h2>
                 <div class="card-header-controls">
                     <button class="toggle-colspan-btn" title="Toggle size" aria-label="Toggle card size"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m6 6v-4m0 4h-4"/><path d="M3 3l6 6"/><path d="M3 3v4m0-4h4"/></svg></button>
                     <span class="drag-handle" aria-label="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
                 </div>
             </div>
             <form id="add-test-form" class="flex flex-col gap-3 mb-4">
                 <input type="date" name="date" class="form-input rounded-md p-2 w-full text-sm" required>
                 <input type="text" name="name" placeholder="Test Name" class="form-input rounded-md p-2 flex-grow text-sm" required>
                 <button type="submit" class="btn-primary font-bold py-2 px-4 rounded-md transition-colors w-full text-sm">Add Test</button>
             </form>
             <div id="test-list-container">
                 <h3 class="text-md font-semibold mb-2 border-b pb-1" style="border-color: var(--border-color);">Tests</h3>
                 <ul id="test-list" class="space-y-2 max-h-48 overflow-y-auto no-scrollbar"></ul>
             </div>
         </div>
    </template>
    
    <template id="quote-template">
        <div class="card" data-card-id="quote">
            <div class="card-header">
                <h2 class="text-lg font-semibold">Quote</h2>
                <div class="card-header-controls">
                    <button class="toggle-colspan-btn" title="Toggle size" aria-label="Toggle card size"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m6 6v-4m0 4h-4"/><path d="M3 3l6 6"/><path d="M3 3v4m0-4h4"/></svg></button>
                    <span class="drag-handle" aria-label="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
                </div>
            </div>
            <div id="quote-card-content" class="text-center cursor-pointer transition-transform transform hover:scale-105">
                 <p id="quote" class="text-md italic">"The best way to predict the future is to create it."</p>
                 <p id="author" class="text-sm text-secondary mt-2">- Peter Drucker</p>
            </div>
        </div>
    </template>

    <template id="note-card-template">
        <div class="card custom-card" data-card-type="note">
            <div class="card-header">
                <h2 class="text-lg font-semibold card-title">Note</h2>
                <div class="card-header-controls">
                    <button class="toggle-colspan-btn" title="Toggle size" aria-label="Toggle card size"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m6 6v-4m0 4h-4"/><path d="M3 3l6 6"/><path d="M3 3v4m0-4h4"/></svg></button>
                    <button class="delete-card-btn" title="Delete card" aria-label="Delete card"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg></button>
                    <span class="drag-handle" aria-label="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
                </div>
            </div>
            <div class="text-sm card-content whitespace-pre-wrap"></div>
        </div>
    </template>

    <template id="todo-card-template">
        <div class="card custom-card" data-card-type="todo">
            <div class="card-header">
                <h2 class="text-lg font-semibold card-title">To-Do List</h2>
                <div class="card-header-controls">
                    <button class="toggle-colspan-btn" title="Toggle size" aria-label="Toggle card size"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m6 6v-4m0 4h-4"/><path d="M3 3l6 6"/><path d="M3 3v4m0-4h4"/></svg></button>
                    <button class="delete-card-btn" title="Delete card" aria-label="Delete card"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg></button>
                    <span class="drag-handle" aria-label="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
                </div>
            </div>
            <div class="card-content">
                <div class="progress-container w-full bg-gray-700 rounded-full h-2.5 mb-4">
                    <div class="progress-bar bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <ul class="todo-list space-y-1 max-h-48 overflow-y-auto mb-3 no-scrollbar"></ul>
                <form class="add-todo-form flex gap-2 mt-2">
                    <input type="text" placeholder="Add a new task..." class="form-input rounded-md p-2 w-full text-sm" required>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-md text-sm" aria-label="Add task">+</button>
                </form>
            </div>
        </div>
    </template>

    <template id="line-graph-card-template">
	    <div class="card custom-card" data-card-type="line-graph">
			
	        <div class="card-header">
	            <h2 class="text-lg font-semibold card-title">Graph</h2>
	            <div class="card-header-controls">
	                <button class="toggle-colspan-btn" title="Toggle size" aria-label="Toggle card size"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m6 6v-4m0 4h-4"/><path d="M3 3l6 6"/><path d="M3 3v4m0-4h4"/></svg></button>
                    <button class="delete-card-btn" title="Delete card" aria-label="Delete card"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg></button>
                    <span class="drag-handle" aria-label="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
	            </div>
	        </div>
	        <div class="card-content">
	            <div class="mb-2 h-64 relative">
	                <canvas class="marks-chart"></canvas>
	            </div>
	            
	            <!-- ▼▼▼ ADD THIS NEW DIV FOR TOGGLE BUTTONS ▼▼▼ -->
	            <div class="chart-toggles flex justify-center gap-2 mb-4">
	                <button data-subject="total" class="text-sm px-3 py-1 rounded-md border active" style="border-color: var(--accent-color); background-color: var(--accent-color); color: white;">Total</button>
	                <button data-subject="physics" class="text-sm px-3 py-1 rounded-md border border-gray-600">Physics</button>
	                <button data-subject="chemistry" class="text-sm px-3 py-1 rounded-md border border-gray-600">Chemistry</button>
	                <button data-subject="maths" class="text-sm px-3 py-1 rounded-md border border-gray-600">Maths/Bio</button>
	            </div>
	            <!-- ▲▲▲ END OF NEW DIV ▲▲▲ -->
	
	            <!-- ▼▼▼ REPLACE THE OLD FORM WITH THIS NEW ONE ▼▼▼ -->
	            <form class="add-marks-form grid grid-cols-2 gap-2 mb-3">
	                <input type="text" name="name" placeholder="Paper Name" class="form-input rounded-md p-2 text-sm col-span-2" required>
	                <input type="number" name="phy" placeholder="Phy" class="form-input rounded-md p-2 text-sm w-full" required>
	                <input type="number" name="chem" placeholder="Chem" class="form-input rounded-md p-2 text-sm w-full" required>
	                <input type="number" name="math" placeholder="Math/Bio" class="form-input rounded-md p-2 text-sm w-full" required>
	                <input type="number"name="maxMarks" placeholder="MAXIMUM MARKS OF PAPER" class="form-input rounded-md p-2 text-sm w-full" required>
	                <button type="submit" class="btn-primary font-bold py-2 px-3 rounded-md text-sm col-span-2" aria-label="Add mark entry">Add Entry</button>
	            </form>
	            <!-- ▲▲▲ END OF NEW FORM ▲▲▲ -->
	            
	            <ul class="marks-list space-y-1 max-h-24 overflow-y-auto no-scrollbar"></ul>
	        </div>
	    </div>
	</template>
    
    <template id="pomodoro-card-template">
        <div class="card custom-card" data-card-type="pomodoro">
            <div class="card-header">
                <h2 class="text-lg font-semibold card-title">Pomodoro</h2>
                <div class="card-header-controls">
                    <button class="toggle-colspan-btn" title="Toggle size" aria-label="Toggle card size"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m6 6v-4m0 4h-4"/><path d="M3 3l6 6"/><path d="M3 3v4m0-4h4"/></svg></button>
                    <button class="delete-card-btn" title="Delete card" aria-label="Delete card"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg></button>
                    <span class="drag-handle" aria-label="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
                </div>
            </div>
            <div class="card-content text-center">
                <div class="flex justify-center gap-2 mb-4">
                    <button data-mode="pomodoro" class="pomodoro-btn text-sm px-3 py-1 rounded-md border border-transparent hover:border-gray-500">Pomodoro</button>
                    <button data-mode="shortBreak" class="pomodoro-btn text-sm px-3 py-1 rounded-md border border-transparent hover:border-gray-500">Short Break</button>
                    <button data-mode="longBreak" class="pomodoro-btn text-sm px-3 py-1 rounded-md border border-transparent hover:border-gray-500">Long Break</button>
                </div>
                <div class="timer-display text-6xl font-bold my-4">25:00</div>
                <div class="flex justify-center gap-4">
                    <button class="start-pause-btn btn-primary font-bold py-2 px-8 text-lg rounded-md">START</button>
                    <button class="reset-btn text-secondary hover:text-primary">Reset</button>
                </div>
                 <div class="focus-status text-xs text-yellow-400 mt-2 h-4"></div>
                <div class="pomodoro-settings mt-4 flex justify-center gap-4 items-center">
                    <label class="flex flex-col text-xs items-center">
                        Work
                        <input type="number" data-mode="pomodoro" class="pomodoro-duration-input form-input w-16 text-center rounded-md p-1" min="1">
                    </label>
                    <label class="flex flex-col text-xs items-center">
                        Short
                        <input type="number" data-mode="shortBreak" class="pomodoro-duration-input form-input w-16 text-center rounded-md p-1" min="1">
                    </label>
                    <label class="flex flex-col text-xs items-center">
                        Long
                        <input type="number" data-mode="longBreak" class="pomodoro-duration-input form-input w-16 text-center rounded-md p-1" min="1">
                    </label>
                </div>
            </div>
        </div>
    </template>

    <template id="youtube-card-template">
        <div class="card custom-card" data-card-type="youtube">
            <div class="card-header">
                <h2 class="text-lg font-semibold card-title">YouTube</h2>
                <div class="card-header-controls">
                    <button class="toggle-colspan-btn" title="Toggle size" aria-label="Toggle card size"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m6 6v-4m0 4h-4"/><path d="M3 3l6 6"/><path d="M3 3v4m0-4h4"/></svg></button>
                    <button class="delete-card-btn" title="Delete card" aria-label="Delete card"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg></button>
                    <span class="drag-handle" aria-label="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
                </div>
            </div>
            <div class="card-content">
                <div class="aspect-w-16 mb-3 youtube-container">
                    <iframe class="youtube-iframe w-full h-full" title="Embedded YouTube video player" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
                <form class="update-youtube-form flex gap-2">
                    <label for="youtube-url-input" class="sr-only">YouTube URL</label>
                    <input type="text" id="youtube-url-input" name="url" placeholder="Paste YouTube URL..." class="form-input rounded-md p-2 w-full text-sm" required>
                    <button type="submit" class="btn-primary font-bold py-2 px-3 rounded-md text-sm">Load</button>
                </form>
            </div>
        </div>
    </template>

    <template id="time-logger-card-template">
        <div class="card custom-card" data-card-type="time-logger">
            <div class="card-header">
                <h2 class="text-lg font-semibold card-title">Study Logger</h2>
                <div class="card-header-controls">
					<button class="pip-btn" title="Show in floating window" aria-label="Show in floating window">
			            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.75 4.75h-8.5a2 2 0 0 0-2 2v8.5a2 2 0 0 0 2 2h8.5a2 2 0 0 0 2-2v-8.5a2 2 0 0 0-2-2Z"/><path d="M19.25 8.75h-8.5a2 2 0 0 1-2-2v-2.5"/><path d="M17.5 15.5V14"/><path d="m15 12 5 5"/></svg>
			        </button>

                    <button class="toggle-colspan-btn" title="Toggle size" aria-label="Toggle card size"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m6 6v-4m0 4h-4"/><path d="M3 3l6 6"/><path d="M3 3v4m0-4h4"/></svg></button>
                    <button class="delete-card-btn" title="Delete card" aria-label="Delete card"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg></button>
                    <span class="drag-handle" aria-label="Drag to reorder"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
                </div>
            </div>
            <div class="card-content text-center">
                <div class="timer-display text-5xl font-bold my-4 tabular-nums">00:00:00</div>
                 <div class="focus-status text-xs text-yellow-400 mb-2 h-4"></div>
                <div class="flex flex-col sm:flex-row gap-2 mb-4 items-center justify-center">
                    <label for="subject-select" class="text-sm text-secondary sr-only sm:not-sr-only">Subject:</label>
                    <select id="subject-select" class="subject-select form-input rounded-md p-2 text-sm flex-grow">
                        </select>
                </div>
                <div class="flex justify-center gap-4">
                    <button class="start-pause-btn btn-primary font-bold py-2 px-8 text-lg rounded-md">START</button>
                    <button class="log-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-md">LOG</button>
                    <button class="reset-btn text-secondary hover:text-primary">Reset</button>
                </div>
                <p class="log-message text-red-500 text-xs mt-2 h-4"></p>
                <div class="w-full border-t border-[var(--border-color)] my-3"></div>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-md font-semibold text-left">Today's Log</h3>
                    <span class="total-study-time text-sm font-bold text-secondary"></span>
                </div>
                <ul class="study-log-list space-y-2 max-h-32 overflow-y-auto no-scrollbar text-left text-sm">
                    </ul>
            </div>
        </div>
    </template>

    <div id="add-card-modal" class="modal-overlay hidden">
        <div class="card w-11/12 max-w-md">
            <h2 class="text-xl font-semibold mb-4">Add New Card</h2>
            <form id="new-card-form">
                <label for="new-card-type" class="sr-only">Card Type</label>
                <select id="new-card-type" class="form-input rounded-md p-2 w-full mb-3">
                    <option value="note">Note</option>
                    <option value="todo">To-Do List</option>
                    <option value="line-graph">Line Graph</option>
                    <option value="pomodoro">Pomodoro Timer</option>
                    <option value="youtube">YouTube Video</option>
                    <option value="time-logger">Study Logger</option>
                </select>
                 <label for="new-card-title" class="sr-only">Card Title</label>
                <input type="text" id="new-card-title" placeholder="Card Title" class="form-input rounded-md p-2 w-full mb-3" required>
                 <label for="new-card-content" class="sr-only">Card Content</label>
                <textarea id="new-card-content" placeholder="Card Content (URL for YouTube)" rows="4" class="form-input rounded-md p-2 w-full mb-4"></textarea>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-add-card" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                    <button type="submit" class="btn-primary font-bold py-2 px-4 rounded-md">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customize-modal" class="modal-overlay hidden">
        <div class="card w-11/12 max-w-md relative">
             <button id="close-customize-icon-btn" class="absolute top-3 right-3 text-secondary hover:text-primary transition-colors p-1 rounded-full" aria-label="Close customize panel">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
             </button>
            <h2 class="text-xl font-semibold mb-4">Customize Dashboard</h2>
            <div class="space-y-4">
                 <div>
                     <label for="exam-type-select" class="block text-sm font-medium text-secondary mb-1">Target Exam</label>
                     <div class="grid grid-cols-2 gap-2">
                         <select id="exam-type-select" class="form-input rounded-md p-2 w-full">
                             <option value="JEE">JEE</option>
                             <option value="NEET">NEET</option>
                         </select>
                         <label for="exam-year-select" class="sr-only">Exam Year</label>
                         <select id="exam-year-select" class="form-input rounded-md p-2 w-full">
                             <option value="2026">2026</option>
                             <option value="2027">2027</option>
                         </select>
                     </div>
                 </div>
                 <div>
                     <label for="theme-select" class="block text-sm font-medium text-secondary mb-1">Theme</label>
                     <select id="theme-select" class="form-input rounded-md p-2 w-full">
                         <option value="default">Deep Space</option>
                         <option value="light">Solarized Light</option>
                         <option value="cyberpunk">Cyberpunk</option>
                         <option value="forest">Forest</option>
                         <option value="rose-gold">Rose Gold</option>
                         <option value="ocean">Ocean</option>
                         <option value="sunset">Sunset</option>
                         <option value="dracula">Dracula</option>
                         <option value="alakh-pandey" class="hidden">Alakh Pandey</option>
                     </select>
                 </div>
                 <div>
                     <label for="font-select" class="block text-sm font-medium text-secondary mb-1">Font</label>
                     <select id="font-select" class="form-input rounded-md p-2 w-full">
                         <option value="'Inter', sans-serif">Inter (Sans-Serif)</option>
                         <option value="'Roboto Slab', serif">Roboto Slab (Serif)</option>
                         <option value="'Fira Code', monospace">Fira Code (Monospace)</option>
                         <option value="'Comic Neue', cursive">Comic Sans</option>
                     </select>
                 </div>
                 <div>
                     <label for="bg-image-url" class="block text-sm font-medium text-secondary mb-1">Background Image URL</label>
                     <div class="flex gap-2">
                         <input type="text" id="bg-image-url" placeholder="Paste image URL (Ending with .jpg, .png, .webp, etc.)" class="form-input rounded-md p-2 w-full">
                         <button id="remove-bg-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md" aria-label="Remove background image">X</button>
                     </div>
                 </div>
                 <div>
                     <label class="block text-sm font-medium text-secondary mb-1">YouTube Player</label>
                     <div class="space-y-2 mt-2 p-3 rounded-md" style="background-color: rgba(0,0,0,0.2);">
                         <label for="youtube-tint-toggle" class="flex items-center justify-between cursor-pointer">
                             <span class="text-sm">Enable Video Tint</span>
                             <input type="checkbox" id="youtube-tint-toggle" class="form-input-toggle">
                         </label>
                         <label for="youtube-blur-toggle" class="flex items-center justify-between cursor-pointer">
                             <span class="text-sm">Blur Video Player</span>
                              <input type="checkbox" id="youtube-blur-toggle" class="form-input-toggle">
                         </label>
                     </div>
                 </div>
                 <div>
                     <label class="block text-sm font-medium text-secondary mb-1">Focus Mode</label>
                     <div class="space-y-2 mt-2 p-3 rounded-md" style="background-color: rgba(0,0,0,0.2);">
                         <label for="focus-shield-toggle" class="flex items-center justify-between cursor-pointer">
                             <span class="text-sm">Enable Focus Shield</span>
                             <input type="checkbox" id="focus-shield-toggle" class="form-input-toggle">
                         </label>
                     </div>
                 </div>
            </div>
            <div class="flex justify-between items-center mt-6">
                <button type="button" id="reset-dashboard-btn" class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                    <span>Reset Dashboard</span>
                </button>
                <button type="button" id="close-customize" class="btn-primary font-bold py-2 px-4 rounded-md">Close</button>
            </div>
            <div class="mt-6 pt-4 border-t" style="border-color: var(--border-color);">
                <h3 class="text-md font-semibold mb-3 text-secondary">Data Management</h3>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="button" id="export-data-btn" class="flex-1 bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">Export Data</button>
                    <button type="button" id="import-data-btn" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">Import Data</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="card w-11/12 max-w-sm">
            <h2 id="confirm-title" class="text-xl font-semibold mb-2">Are you sure?</h2>
            <p id="confirm-message" class="text-sm text-secondary mb-6"></p>
            <div class="flex justify-end gap-3">
                <button type="button" id="confirm-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                <button type="button" id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Confirm</button>
            </div>
        </div>
    </div>

    <div id="mobile-alert" class="fixed bottom-4 left-4 right-4 bg-yellow-400 text-black p-3 text-center text-sm rounded-lg shadow-lg flex justify-between items-center hidden z-50">
        <span>For the best experience, try this on a desktop.</span>
        <button id="close-alert-btn" class="font-bold text-lg ml-4" aria-label="Close mobile alert">&times;</button>
    </div>

    <div id="info-modal" class="modal-overlay hidden">
	    <div class="card w-11/12 max-w-lg">
	        <!-- Tab Navigation -->
	        <nav class="tab-nav">
	            <button class="tab-btn active" data-tab="quick-start">Quick Start</button>
	            <button class="tab-btn" data-tab="whats-new">What's New</button>
	            <button class="tab-btn" data-tab="feedback">Feedback</button>
	            <button class="tab-btn" data-tab="about">About & Support</button>
	        </nav>
	
	        <!-- Tab Content Panels -->
	        <div>
	            <!-- Quick Start Panel -->
	            <div id="tab-quick-start" class="tab-content space-y-3 text-sm">
					<p><strong>Date changed according to new NTA circular (Oct 19 2025)</strong></p>
					<p><strong>🙏 NEXT MAJOR/FEATURE UPDATE AFTER JEE MAIN 2026 JAN ATTEMPT 🙏 (updation of april attempt, etc.)</strong></p>
					<p><strong>YOU CAN CHANGE JEE/NEET AND YEAR IN CUSTOMISE MENU</strong></p>
	                <p><strong>✨ Drag & Drop:</strong> Use the six-dot handle on any card to rearrange your layout.</p>
	                <p><strong>➕ Add Cards:</strong> Click the "Add Card" button in the header to create custom notes, to-do lists, graphs, and more.</p>
	                <p><strong>🎨 Customize:</strong> Click the "Customize" button to change your theme, font, and background image.</p>
	                <p>Kindly refrain from tapping the top heading of the page (ex. JEE 2026), 3 times in successive continuation please.</p>
	            </div>
	
	            <!-- What's New Panel -->
	            <div id="tab-whats-new" class="tab-content hidden space-y-3 text-sm">
	                <h3 class="text-md font-bold text-primary">Version 1.2 (October 2025)</h3>
	                <ul class="list-disc list-inside text-secondary space-y-2">
	                    <li><strong>Enhanced Mock Test Analysis:</strong> You can now input subject-wise marks (P/C/M) and toggle their visibility on the graph.</li>
	                    <li><strong>Smarter Syncing:</strong> Implemented debouncing and caching to drastically reduce database usage and improve performance.</li>
	                    <li><strong>Persistent Floating Timer:</strong> The Picture-in-Picture window for the study logger now stays open until you return to the tab.</li>
	                </ul>
	            </div>
	
	            <!-- Feedback Panel -->
	            <div id="tab-feedback" class="tab-content hidden space-y-4 text-sm text-center">
	                 <p>Have an idea or found a bug? Join the community!</p>
	                 <a href="https://t.me/studylocus" target="_blank" class="btn-primary inline-block">Join the Telegram Group</a>
	                 <p class="text-xs text-secondary">You can also submit feedback or report issues on the project's GitHub page.</p>
	            </div>
	
	            <!-- About & Support Panel -->
	            <div id="tab-about" class="tab-content hidden space-y-3 text-sm">
	                <p><strong>Created by:</strong> <a href="https://github.com/svalordev" target="_blank">Shaurya Pratap Singh</a></p>
	                <p><strong>Project Repository:</strong> <a href="https://github.com/SvalTech/studylocus/" target="_blank">View on GitHub</a></p>
	                <div class="border-t border-gray-700 my-4"></div>
	                <p>Enjoying StudyLocus? Your support helps keep the project running and ad-free. Thank you!</p>
	                <div class="text-center mt-2">
	                    <a href="https://buymeacoffee.com/svalordev" target="_blank" class="btn-primary inline-block">Support the Project</a>
	                </div>
	            </div>
	        </div>
	        
	        <div class="flex justify-end mt-6">
	            <button type="button" id="close-info-modal" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Close</button>
	        </div>
	    </div>
	</div>

    <div class="fab-container">
        <div class="fab-menu card p-2 space-y-1">
             <h3 class="text-sm font-bold px-2 text-secondary">sval.tech</h3>
             <a href="#" class="flex items-center gap-2 p-2 rounded-md hover:bg-gray-700/50">
                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"></rect><path d="M7 3v18"></path><path d="M12 3v18"></path><path d="M17 3v18"></path><path d="M3 7.5h18"></path><path d="M3 12h18"></path><path d="M3 16.5h18"></path></svg>
                 <span>Dashboard</span>
             </a>
             <a href="https://svaltech.github.io/syllabustracker" target="_blank" class="flex items-center gap-2 p-2 rounded-md hover:bg-gray-700/50">
                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="m10 14-2 2 2 2"></path><path d="m14 6-2 2 2 2"></path></svg>
                 <span>Syllabus Tracker</span>
             </a>
        </div>
        <button class="w-14 h-14 rounded-full bg-gray-800 shadow-lg flex items-center justify-center text-white hover:bg-gray-700 transition-colors" aria-label="Toggle sval.tech products menu">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
        </button>
    </div>

    <input type="file" id="import-file-input" class="hidden" accept=".json">

    <div id="god-mode-panel" class="hidden fixed bottom-4 left-4 card p-4 w-64 z-50 space-y-3">
        <h3 class="text-lg font-bold text-center" style="color: var(--accent-color);">-- GOD MODE --</h3>
        <p class="text-xs text-secondary text-center">Ultimate power is now yours.</p>
        <div class="border-t border-[var(--border-color)]"></div>
        <div class="space-y-2">
            <button id="god-mode-theme-btn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md text-sm">Matrix Theme</button>
            <button id="god-mode-complete-tasks-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-md text-sm">Complete All Tasks</button>
            <button id="god-mode-perfect-score-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md text-sm">Get Perfect Score</button>
            <button id="god-mode-timewarp-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md text-sm">Time Warp (+7 Days)</button>
            <button id="god-mode-scramble-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md text-sm">Scramble Layout</button>
            <button id="god-mode-nuke-btn" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-md text-sm">NUKE</button>
        </div>
        <button id="god-mode-close-btn" class="absolute top-2 right-2 text-secondary hover:text-primary" aria-label="Close God Mode Panel">&times;</button>
    </div>
    
    <script>
        console.log("Kyu nahi ho rahi padhai?")
        /**
         * Creates a debounced version of a function that delays invoking the function
         * until after 'delay' milliseconds have passed since the last time it was invoked.
         */
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // --- Firebase Configuration ---
        // (Note: Your provided config is here)
        const firebaseConfig = {
            apiKey: "AIzaSyAO9ya8gHtVbMfxcnAAJrz6FdYWvIRqgBY",
            authDomain: "studydashboard-2a3eb.firebaseapp.com",
            projectId: "studydashboard-2a3eb",
            storageBucket: "studydashboard-2a3eb.firebasestorage.app",
            messagingSenderId: "79210973277",
            appId: "1:79210973277:web:cc0a5fa86729fd6d3f65b4",
            measurementId: "G-TE7Z0SR8L1",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Global State ---
        let currentUser = null;
        let syncTimeout = null;

        // --- DOM Ready Event Listener ---
        document.addEventListener("DOMContentLoaded", () => {
            /**
            * Maps internal state keys to their corresponding localStorage keys.
            */
            const LOCAL_STORAGE_KEYS = {
                tests: "jeePartTests_v2",
                layout: "jeeDashboardLayout_v3",
                customCards: "jeeCustomCards_v3",
                settings: "jeeDashboardSettings_v3",
                mobileAlertDismissed: "jeeMobileAlertDismissed_v1",
                cardProps: "jeeCardProps_v2",
                pomodoroState: "jeePomodoroState_v1",
                timeLoggerState: "jeeTimeLoggerState_v1",
                studyLogs: "jeeStudyLogs_v1",
            };

            /**
            * Default target exam dates.
            */
            const EXAM_DATES = {
                JEE: { 2026: new Date("2026-01-21T00:00:00"), 2027: new Date("2027-01-21T00:00:00") },
                NEET: { 2026: new Date("2026-05-03T00:00:00"), 2027: new Date("2027-05-02T00:00:00") },
            };

            // Load initial state from localStorage
            const parsedSettings = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.settings));

            /**
            * Main application state object.
            * Manages all dashboard data and provides methods to save it.
            */
            const appState = {
                tests: JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.tests)) || {},
                customCards: JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.customCards)) || [
                    {
                        id: "default-todo",
                        type: "todo",
                        title: "My Tasks",
                        content: [
                            { text: "Solve 20 Physics problems", completed: false },
                            { text: "Revise Organic Chemistry", completed: true },
                            { text: "Take a short break!", completed: false },
                        ],
                    },
                    {
                        id: "default-line-graph",
                        type: "line-graph",
                        title: "Mock Test Progress",
                        content: [
                            { name: "Test 1", marks: 120, maxMarks: 300 },
                            { name: "Test 2", marks: 145, maxMarks: 300 },
                            { name: "Test 3", marks: 160, maxMarks: 300 },
                        ],
                    },
                    {
                        id: "default-note",
                        type: "note",
                        title: "Welcome!",
                        content:
                            "Welcome to your new dashboard! You can drag, resize, and delete these cards. Add your own from the top right. Best of luck in your journey!",
                    },
                    { id: "default-study-logger", type: "time-logger", title: "Study Log", content: [] },
                ],
                layout: JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.layout)) || [
                    "countdown",
                    "graph",
                    "default-todo",
                    "default-study-logger",
                    "default-note",
                    "default-line-graph",
                    "tests",
                    "quote",
                    "time",
                ],
                settings: {
                    theme: "default",
                    font: "'Inter', sans-serif",
                    bgUrl: "",
                    examType: "JEE",
                    examYear: "2026",
                    youtubeTintEnabled: true,
                    youtubeBlurEnabled: false,
                    focusShieldEnabled: false,
                    userSubjects: [],
                    ...parsedSettings,
                },
                cardProps: JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.cardProps)) || {
                    graph: { colspan: 2 },
                    "default-line-graph": { colspan: 1 },
                    "default-study-logger": { colspan: 1 },
                },
                pomodoroState: JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.pomodoroState)) || {},
                timeLoggerState: JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.timeLoggerState)) || {},
                studyLogs: JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.studyLogs)) || {},
                chartInstances: {}, // Holds active Chart.js instances
                activeTimer: { cardId: null, type: null, unfocusedTime: 0, unfocusedStart: 0 },

                /**
                * Saves a specific part of the state to localStorage and triggers a cloud sync.
                * @param {string} key The key of the appState property to save (e.g., 'tests', 'layout').
                */
                save(key) {
                    localStorage.setItem(LOCAL_STORAGE_KEYS[key], JSON.stringify(this[key]));
                    triggerSync(key);
                },

                /**
                * Saves the 'settings' object specifically.
                */
                saveSettings() {
                    localStorage.setItem(LOCAL_STORAGE_KEYS.settings, JSON.stringify(this.settings));
                    triggerSync("settings");
                },
            };

            // --- Quotes Data ---
            const generalQuotes = [
                { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
                { text: "It’s not whether you get knocked down, it’s whether you get up.", author: "Vince Lombardi" },
                { text: "Success is the sum of small efforts, repeated day in and day out.", author: "Robert Collier" },
                { text: "The expert in anything was once a beginner.", author: "Helen Hayes" },
                { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
                {
                    text: "The difference between ordinary and extraordinary is that little extra.",
                    author: "Jimmy Johnson",
                },
                { text: "A person who never made a mistake never tried anything new.", author: "Albert Einstein" },
                { text: "The harder I work, the luckier I get.", author: "Samuel Goldwyn" },
                {
                    text: "Success is not final, failure is not fatal: it is the courage to continue that counts.",
                    author: "Winston Churchill",
                },
                { text: "Strive for progress, not perfection.", author: "Unknown" },
                {
                    text: "Genius is one percent inspiration and ninety-nine percent perspiration.",
                    author: "Thomas A. Edison",
                },
                { text: "It does not matter how slowly you go as long as you do not stop.", author: "Confucius" },
                { text: "Doubt kills more dreams than failure ever will.", author: "Suzy Kassem" },
                { text: "Push yourself, because no one else is going to do it for you.", author: "Unknown" },
                { text: "If you want to shine like a sun, first burn like a sun.", author: "A. P. J. Abdul Kalam" },
                {
                    text: "The important thing is not to stop questioning. Curiosity has its own reason for existing.",
                    author: "Albert Einstein",
                },
                {
                    text: "We are what we repeatedly do. Excellence, then, is not an act, but a habit.",
                    author: "Aristotle",
                },
                { text: "The chapters you study today will decide the chapters of your life tomorrow.", author: "Unknown" },
                { text: "Your toughest competition is the person you were yesterday.", author: "Unknown" },
                { text: "Rank is just a number. Knowledge and skill are the real assets.", author: "Unknown" },
                {
                    text: "Dream is not that which you see while sleeping it is something that does not let you sleep.",
                    author: "A. P. J. Abdul Kalam",
                },
                {
                    text: "Focus on the process, not the outcome. The right process will lead to the right outcome.",
                    author: "Unknown",
                },
            ];
            const alakhPandeyQuotes = [
                { text: "Kyu nahi ho rahi padhai?", author: "Alakh Pandey" },
                { text: "System phaad denge!", author: "A wise man" },
                { text: "Physics is not a subject, it's an emotion.", author: "Alakh Pandey" },
                { text: "Aag laga denge!", author: "Revolutionaries" },
                { text: "Mehnat karta hu bhai", author: "Basava Reddy" },
            ];
            const chaitanyaQuotes = [ // Easter egg quotes
                { text: "Chaitanya is a noob 🤓", author: "Everyone" },
                { text: "I love Organic Chemistry 🤓", author: "Chaitanya (probably)" },
                { text: "Isomerism is my favorite topic 🤓", author: "Definitely Chaitanya" },
                { text: "Just like us guys 🤓", author: "Chaitanya the moron" },
            ];

            /**
            * Object containing references to all key DOM elements.
            */
            const domElements = {
                body: document.body,
                mainTitle: document.getElementById("main-title"),
                dashboardGrid: document.getElementById("dashboard-grid"),
                authContainer: document.getElementById("auth-container"),
                syncStatus: document.getElementById("sync-status"),
                modals: {
                    addCard: document.getElementById("add-card-modal"),
                    customize: document.getElementById("customize-modal"),
                    info: document.getElementById("info-modal"),
                    confirm: document.getElementById("confirm-modal"),
                },
                buttons: {
                    addCard: document.getElementById("add-card-btn"),
                    cancelAddCard: document.getElementById("cancel-add-card"),
                    customize: document.getElementById("customize-btn"),
                    closeCustomize: document.getElementById("close-customize"),
                    closeCustomizeIcon: document.getElementById("close-customize-icon-btn"),
                    removeBg: document.getElementById("remove-bg-btn"),
                    closeAlert: document.getElementById("close-alert-btn"),
                    resetDashboard: document.getElementById("reset-dashboard-btn"),
                    info: document.getElementById("info-btn"),
                    closeInfo: document.getElementById("close-info-modal"),
                    exportData: document.getElementById("export-data-btn"),
                    importData: document.getElementById("import-data-btn"),
                    confirmOk: document.getElementById("confirm-ok-btn"),
                    confirmCancel: document.getElementById("confirm-cancel-btn"),
                    zenModeBtn: document.getElementById("zen-mode-btn"),
                    exitZenBtn: document.getElementById("exit-zen-btn"),
                    godModeClose: document.getElementById("god-mode-close-btn"),
                },
                forms: {
                    newCard: document.getElementById("new-card-form"),
                },
                inputs: {
                    cardType: document.getElementById("new-card-type"),
                    cardContent: document.getElementById("new-card-content"),
                    theme: document.getElementById("theme-select"),
                    font: document.getElementById("font-select"),
                    bgUrl: document.getElementById("bg-image-url"),
                    examType: document.getElementById("exam-type-select"),
                    examYear: document.getElementById("exam-year-select"),
                    importFile: document.getElementById("import-file-input"),
                    youtubeTintToggle: document.getElementById("youtube-tint-toggle"),
                    youtubeBlurToggle: document.getElementById("youtube-blur-toggle"),
                    focusShieldToggle: document.getElementById("focus-shield-toggle"),
                },
                mobileAlert: document.getElementById("mobile-alert"),
                confirmTitle: document.getElementById("confirm-title"),
                confirmMessage: document.getElementById("confirm-message"),
                godModePanel: document.getElementById("god-mode-panel"),
            };

            // --- App Loading State ---
            // Disable controls until Firebase auth state is resolved
            domElements.buttons.addCard.disabled = true;
            domElements.dashboardGrid.style.pointerEvents = "none";
            domElements.dashboardGrid.style.opacity = "0.5";

            // --- Picture-in-Picture (PiP) State ---
            let pipWindow = null;
            let pipCardId = null;
            let pipCardType = null;

            // --- Authentication ---
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadUserData(user);
                    enableAppControls();
                } else {
                    currentUser = null;
                    updateAuthUI();
                    enableAppControls();
                }
            });

            /**
            * Initiates Google Sign-In popup.
            */
            const signInWithGoogle = () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch((error) => {
                    console.error("Authentication Error:", error);
                });
            };

            /**
            * Signs out the current user.
            */
            const signOutUser = () => {
                sessionStorage.removeItem("cloud_data_loaded"); // Force cloud reload on next login
                auth.signOut();
            };

            /**
            * Enables dashboard controls after auth state is determined.
            */
            const enableAppControls = () => {
                domElements.buttons.addCard.disabled = false;
                domElements.dashboardGrid.style.pointerEvents = "auto";
                domElements.dashboardGrid.style.opacity = "1";
            };

            /**
            * Updates the auth container UI based on the current user state.
            */
            const updateAuthUI = () => {
                if (currentUser) {
                    // User is signed in
                    domElements.authContainer.innerHTML = `
                            <div class="relative" id="user-menu-container">
                                <button id="user-menu-button" title="User Menu" class="flex items-center justify-center w-10 h-10 rounded-full transition-colors hover:bg-white/20 sm:w-auto sm:h-auto sm:px-2 sm:py-1">
                                    <img src="${currentUser.photoURL}" alt="${currentUser.displayName}" class="w-8 h-8 rounded-full pointer-events-none" />
                                    <span class="text-sm font-semibold hidden sm:inline ml-2 pointer-events-none">${currentUser.displayName.split(" ")[0]}</span>
                                </button>
                                <div id="user-menu-dropdown" class="card absolute right-0 mt-2 w-48 p-2 hidden z-50">
                                    <div class="px-2 py-1 mb-1 border-b" style="border-color: var(--border-color);">
                                        <p class="text-sm font-semibold truncate" title="${currentUser.displayName}">${currentUser.displayName}</p>
                                        <p class="text-xs text-secondary truncate" title="${currentUser.email}">${currentUser.email}</p>
                                    </div>
                                    <button id="sign-out-btn" class="w-full text-left flex items-center gap-2 p-2 rounded-md hover:bg-white/10 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                                        <span>Sign Out</span>
                                    </button>
                                </div>
                            </div>
                        `;
                    // Add event listeners for the new dropdown
                    const userMenuButton = domElements.authContainer.querySelector("#user-menu-button");
                    const userMenuDropdown = domElements.authContainer.querySelector("#user-menu-dropdown");
                    const signOutBtn = domElements.authContainer.querySelector("#sign-out-btn");

                    userMenuButton.addEventListener("click", (event) => {
                        event.stopPropagation();
                        userMenuDropdown.classList.toggle("hidden");
                    });
                    signOutBtn.addEventListener("click", signOutUser);
                } else {
                    // User is signed out
                    domElements.authContainer.innerHTML =
                        '<button id="sign-in-btn" class="flex items-center justify-center w-10 h-10 rounded-full transition-colors hover:bg-white/20 sm:w-auto sm:px-3 sm:py-2"><svg class="w-5 h-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">\n                            <path d="M47.532 24.552c0-1.566-.14-3.084-.404-4.548H24.5v8.58h12.944c-.566 2.76-2.213 5.108-4.72 6.708v5.524h7.112c4.162-3.832 6.596-9.42 6.596-16.264z" fill="#4285F4"/><path d="M24.5 48c6.48 0 11.944-2.14 15.928-5.788l-7.112-5.524c-2.14 1.44-4.884 2.292-7.816 2.292-6.004 0-11.084-4.04-12.9-9.492H4.42v5.7c3.48 6.912 10.32 11.532 18.08 11.532l2 .28z" fill="#34A853"/><path d="M11.6 28.98c-.34-.996-.54-2.052-.54-3.144s.2-2.148.54-3.144V16.992H4.42C2.852 20.04 2 23.436 2 27.024c0 3.588.852 6.984 2.42 10.032l7.18-5.7v-.376z" fill="#FBBC05"/><path d="M24.5 9.8c3.516 0 6.66 1.212 9.128 3.54l6.32-6.32C36.44.88 30.98 0 24.5 0 16.74 0 9.9 4.62 6.42 11.532l7.18 5.7c1.816-5.452 6.896-9.432 12.9-9.432z" fill="#EA4335"/>\n                        </svg><span class="text-sm font-semibold hidden sm:inline ml-2">Sign In</span></button>';
                    domElements.authContainer.querySelector("#sign-in-btn").addEventListener("click", signInWithGoogle);
                }
            };

            // --- Firestore Data Sync ---

            /**
            * Loads user data from Firestore or migrates local data if new user.
            * @param {firebase.User} user The authenticated user object.
            */
            const loadUserData = async (user) => {
                updateAuthUI();
                const userDocRef = db.collection("users").doc(user.uid);
                const userDoc = await userDocRef.get();

                if (userDoc.exists) {
                    mergeCloudDataWithLocal(userDoc.data());
                } else {
                    migrateLocalDataToCloud(userDocRef);
                }
            };

            /**
            * Merges cloud data with local data, preferring cloud data.
            * Reloads the page if any local data was overwritten.
            * @param {Object} cloudData Data from Firestore.
            */
            const mergeCloudDataWithLocal = (cloudData) => {
                // Prevent redundant loads within the same session
                if (sessionStorage.getItem("cloud_data_loaded") === "true") {
                    console.log("Cloud data already loaded this session. Skipping redundant load.");
                    return;
                }
                console.log("Loading data from cloud...");

                let isReloadNeeded = false;
                for (const key in LOCAL_STORAGE_KEYS) {
                    if (cloudData[key]) {
                        const localDataString = localStorage.getItem(LOCAL_STORAGE_KEYS[key]);
                        const cloudDataString = JSON.stringify(cloudData[key]);

                        if (localDataString !== cloudDataString) {
                            localStorage.setItem(LOCAL_STORAGE_KEYS[key], cloudDataString);
                            isReloadNeeded = true;
                        }
                    }
                }

                if (isReloadNeeded) {
                    sessionStorage.setItem("cloud_data_loaded", "true");
                    location.reload();
                }
            };

            /**
            * For new users, migrates existing localStorage data to Firestore.
            * @param {firebase.firestore.DocumentReference} userDocRef Reference to the user's Firestore document.
            */
            const migrateLocalDataToCloud = (userDocRef) => {
                console.log("New user detected. Migrating local data to cloud...");
                const localData = {};
                for (const key in LOCAL_STORAGE_KEYS) {
                    const dataString = localStorage.getItem(LOCAL_STORAGE_KEYS[key]);
                    if (dataString) {
                        localData[key] = JSON.parse(dataString);
                    }
                }

                if (Object.keys(localData).length > 0) {
                    userDocRef
                        .set(localData)
                        .then(() => showSyncStatus("Synced"))
                        .catch((error) => console.error("Migration failed:", error));
                }
            };

            /**
            * Displays a sync status message (e.g., "Saving...", "All changes saved").
            * @param {string} message The message to display.
            */
            const showSyncStatus = (message) => {
                clearTimeout(syncTimeout);
                domElements.syncStatus.textContent = message;
                domElements.syncStatus.style.opacity = 1;

                if (message !== "Saving...") {
                    syncTimeout = setTimeout(() => {
                        domElements.syncStatus.style.opacity = 0;
                    }, 2000);
                }
            };

            /**
            * Debounced function to save a specific state key to Firestore.
            * @param {string} key The key of the appState to sync (e.g., 'tests', 'settings').
            */
            const debouncedSyncToFirestore = debounce((key) => {
                if (!currentUser) return;

                const userDocRef = db.collection("users").doc(currentUser.uid);
                const dataString = localStorage.getItem(LOCAL_STORAGE_KEYS[key]);

                if (dataString) {
                    const dataToSync = { [key]: JSON.parse(dataString) };
                    userDocRef
                        .set(dataToSync, { merge: true })
                        .then(() => {
                            console.log(`Debounced sync for '${key}' successful.`);
                            showSyncStatus("All changes saved");
                        })
                        .catch((error) => {
                            showSyncStatus("Sync Error");
                            console.error("Firestore sync error:", error);
                        });
                }
            }, 5000); // 5-second debounce

            /**
            * Triggers a debounced Firestore sync for a given state key.
            * @param {string} key The key of the appState to sync.
            */
            const triggerSync = (key) => {
                if (currentUser) {
                    showSyncStatus("Saving...");
                    debouncedSyncToFirestore(key);
                }
            };

            // --- Modals & Utility Functions ---
            let confirmCallback = null; // Stores the 'OK' action for the confirm modal

            /**
            * Displays a confirmation modal.
            * @param {string} message The confirmation message.
            * @param {Function} callback The function to execute if the user clicks "OK".
            * @param {string} [title="Are you sure?"] The title for the modal.
            */
            function showConfirmModal(message, callback, title = "Are you sure?") {
                domElements.confirmTitle.textContent = title;
                domElements.confirmMessage.textContent = message;
                confirmCallback = callback;
                domElements.modals.confirm.classList.remove("hidden");
            }

            /**
            * Formats a Date object to an ISO string (YYYY-MM-DD).
            * @param {Date} date The date to format.
            * @returns {string} The formatted date string.
            */
            const formatDateToISO = (date) => {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, "0");
                const day = date.getDate().toString().padStart(2, "0");
                return `${year}-${month}-${day}`;
            };

            /**
            * Gets the target exam date based on user settings.
            * @returns {Date} The target exam date.
            */
            const getTargetExamDate = () => {
                const { examType, examYear } = appState.settings;
                return EXAM_DATES[examType]?.[examYear] || new Date(); // Fallback to now
            };

            /**
            * Formats total seconds into a HH:MM:SS string.
            * @param {number} totalSeconds The number of seconds.
            * @returns {string} The formatted time string.
            */
            const formatTimeHHMMSS = (totalSeconds) => {
                const hours = Math.floor(totalSeconds / 3600)
                    .toString()
                    .padStart(2, "0");
                const minutes = Math.floor((totalSeconds % 3600) / 60)
                    .toString()
                    .padStart(2, "0");
                const seconds = Math.floor(totalSeconds % 60)
                    .toString()
                    .padStart(2, "0");
                return `${hours}:${minutes}:${seconds}`;
            };

            /**
            * Formats total seconds into a readable string (e.g., "1h 30m", "45m", "30s").
            * @param {number} totalSeconds The number of seconds.
            * @returns {string} The readable time string.
            */
            const formatTimeReadable = (totalSeconds) => {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                let resultString = "";
                if (hours > 0) {
                    resultString += `${hours}h `;
                }
                if (minutes > 0 || hours > 0) {
                    resultString += `${minutes}m`;
                }
                if (resultString === "") {
                    resultString = (totalSeconds % 60) + "s";
                }
                return resultString.trim();
            };

            // --- Picture-in-Picture (PiP) Functions ---

            /**
            * Closes the PiP window if the main document becomes visible.
            */
            function handleVisibilityChangePiP() {
                if (document.visibilityState === "visible" && pipWindow) {
                    pipWindow.close();
                }
            }

            /**
            * Updates the timer display inside the PiP window.
            */
            function updatePiPTimerDisplay() {
                if (!pipWindow || !pipCardId) return;
                const mainTimerDisplay = document.querySelector(`[data-card-id="${pipCardId}"] .timer-display`);
                const pipTimerDisplay = pipWindow.document.getElementById("pip-timer");
                if (mainTimerDisplay && pipTimerDisplay) {
                    pipTimerDisplay.textContent = mainTimerDisplay.textContent;
                }
            }

            /**
            * Updates the PiP window's control buttons (Start/Pause, Log) state.
            */
            function updatePiPControls() {
                if (!pipWindow || !pipCardId) return;
                const loggerState = appState.timeLoggerState[pipCardId];
                if (!loggerState) return;
                const pipStartPauseBtn = pipWindow.document.getElementById("pip-start-pause-btn");
                const pipLogBtn = pipWindow.document.getElementById("pip-log-btn");
                if (pipStartPauseBtn) {
                    pipStartPauseBtn.textContent = loggerState.isRunning ? "Pause" : "Start";
                }
                if (pipLogBtn) {
                    pipLogBtn.disabled = loggerState.accumulatedTime < 60; // Disable log if less than 1 min
                }
            }

            // --- Card Rendering ---

            /**
            * An object mapping card types to their rendering logic.
            * Each renderer defines a templateId and a render function.
            */
            const cardRenderers = {
                countdown: {
                    templateId: "countdown-template",
                    isDefault: true,
                    render: (cardElement) => {
                        const diff = getTargetExamDate() - new Date();
                        cardElement.querySelector('[data-value="days"]').innerText = Math.floor(diff / (1000 * 60 * 60 * 24))
                            .toString()
                            .padStart(2, "0");
                        cardElement.querySelector('[data-value="hours"]').innerText = Math.floor((diff / (1000 * 60 * 60)) % 24)
                            .toString()
                            .padStart(2, "0");
                        cardElement.querySelector('[data-value="minutes"]').innerText = Math.floor((diff / (1000 * 60)) % 60)
                            .toString()
                            .padStart(2, "0");
                        cardElement.querySelector('[data-value="seconds"]').innerText = Math.floor((diff / 1000) % 60)
                            .toString()
                            .padStart(2, "0");
                    },
                },
                time: {
                    templateId: "time-template",
                    isDefault: true,
                    render: (cardElement) => {
                        const now = new Date();
                        cardElement.querySelector('[data-value="time"]').textContent = now.toLocaleTimeString("en-US", {
                            hour: "2-digit",
                            minute: "2-digit",
                            second: "2-digit",
                            hour12: true,
                        });
                        cardElement.querySelector('[data-value="date"]').textContent = now.toLocaleDateString("en-US", {
                            weekday: "long",
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                        });
                    },
                },
                graph: {
                    templateId: "graph-template",
                    isDefault: true,
                    render: (cardElement) => {
                        const graphContainer = cardElement.querySelector("#contribution-graph");
                        graphContainer.innerHTML = ""; // Clear previous render

                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        const currentYear = new Date().getFullYear();
                        let currentDate = new Date(`${currentYear}-01-01T00:00:00`); // Start from Jan 1st

                        const examDate = getTargetExamDate();
                        examDate.setHours(0, 0, 0, 0);

                        // Loop from Jan 1st to the exam date
                        while (currentDate <= examDate) {
                            const dayCell = document.createElement("div");
                            const tooltip = document.createElement("span");
                            const dateString = formatDateToISO(currentDate);

                            dayCell.className = "day";
                            dayCell.dataset.date = dateString;
                            tooltip.className = "tooltip";

                            let dayClass = "day-future";
                            let tooltipText = currentDate.toDateString();

                            if (currentDate < today) dayClass = "day-past";
                            if (currentDate.getTime() === today.getTime()) {
                                dayClass = "day-today";
                                tooltipText += " - Today";
                            }
                            if (appState.tests[dateString]) {
                                dayClass = "day-part-test";
                                const daysFromNow = Math.ceil((new Date(dateString) - today) / (1000 * 60 * 60 * 24));
                                tooltipText = `${appState.tests[dateString]} (${daysFromNow-1} days from now)`;
                            }
                            if (currentDate.getTime() === examDate.getTime()) {
                                dayClass = "day-exam";
                                tooltipText += " - Exam!";
                            }

                            dayCell.classList.add(dayClass);
                            tooltip.textContent = tooltipText;
                            dayCell.appendChild(tooltip);
                            graphContainer.appendChild(dayCell);

                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    },
                },
                tests: {
                    templateId: "tests-template",
                    isDefault: true,
                    render: (cardElement) => {
                        const listElement = cardElement.querySelector("#test-list");
                        listElement.innerHTML = "";
                        const sortedDates = Object.keys(appState.tests).sort();

                        if (sortedDates.length !== 0) {
                            sortedDates.forEach((date) => {
                                const listItem = document.createElement("li");
                                listItem.className = "flex justify-between items-center bg-gray-800 p-2 rounded-md";
                                listItem.innerHTML = `<div class="flex flex-col"><span class="font-semibold text-sm">${appState.tests[date]}</span><span class="text-xs text-secondary">${new Date(date + "T00:00:00").toDateString()}</span></div><button data-date="${date}" class="delete-test-btn text-red-500 hover:text-red-400 font-semibold text-xs">Delete</button>`;
                                listElement.appendChild(listItem);
                            });
                        } else {
                            listElement.innerHTML = '<li class="text-secondary px-2 text-sm">No tests scheduled.</li>';
                        }
                    },
                },
                quote: {
                    templateId: "quote-template",
                    isDefault: true,
                    render: (cardElement) => {
                        let quotesArray = generalQuotes;
                        if (appState.settings.theme === "alakh-pandey") quotesArray = alakhPandeyQuotes;
                        if (appState.settings.theme === "chaitanya-noob") quotesArray = chaitanyaQuotes;

                        const { text, author } = quotesArray[Math.floor(Math.random() * quotesArray.length)];
                        cardElement.querySelector("#quote").textContent = `"${text}"`;
                        cardElement.querySelector("#author").textContent = `- ${author}`;
                    },
                },
                note: {
                    templateId: "note-card-template",
                    render: (cardElement, cardData) => {
                        cardElement.querySelector(".card-content").textContent = cardData.content;
                    },
                },
                todo: {
                    templateId: "todo-card-template",
                    render: (cardElement, cardData) => {
                        const listElement = cardElement.querySelector(".todo-list");
                        const progressBar = cardElement.querySelector(".progress-bar");
                        listElement.innerHTML = "";

                        if (Array.isArray(cardData.content)) {
                            const totalTasks = cardData.content.length;
                            const completedTasks = cardData.content.filter((task) => task.completed).length;
                            const progressPercent = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
                            progressBar.style.width = `${progressPercent}%`;

                            if (totalTasks === 0) {
                                listElement.innerHTML =
                                    '<li class="text-secondary px-2 text-sm">No tasks yet. Add one below!</li>';
                            } else {
                                cardData.content.forEach((task, index) => {
                                    const listItem = document.createElement("li");
                                    listItem.className =
                                        "flex items-center gap-3 p-2 rounded-md hover:bg-white/5 transition-colors todo-item " +
                                        (task.completed ? "completed" : "");
                                    listItem.dataset.index = index;
                                    listItem.innerHTML = `<input type="checkbox" ${task.completed ? "checked" : ""} class="todo-checkbox"><span class="flex-grow text-sm">${task.text}</span><button class="delete-todo-item" aria-label="Delete task">×</button>`;
                                    listElement.appendChild(listItem);
                                });
                            }
                        }
                    },
                },
                "line-graph": {
                    templateId: "line-graph-card-template",
                    render: (cardElement, cardData) => {
                        const marksListEl = cardElement.querySelector(".marks-list");
                        marksListEl.innerHTML = "";
                        cardData.content.forEach((entry, index) => {
                            const listItem = document.createElement("li");
                            listItem.className = "flex justify-between items-center text-xs bg-gray-800 p-2 rounded";
                            listItem.innerHTML = `
                                    <div class="flex-grow">
                                        <strong>${entry.name}</strong>: ${entry.total ?? entry.marks} / ${entry.maxMarks}
                                        <span class="text-gray-400 ml-2">${entry.subjects ? `(P:${entry.subjects.physics}, C:${entry.subjects.chemistry}, M:${entry.subjects.maths})` : "(No subject data)"}</span>
                                    </div>
                                    <button data-index="${index}" class="delete-mark-item text-red-500 px-1" aria-label="Delete mark entry">×</button>`;
                            marksListEl.appendChild(listItem);
                        });

                        const ctx = cardElement.querySelector(".marks-chart").getContext("2d");
                        // Destroy previous chart instance if it exists
                        if (appState.chartInstances[cardData.id]) {
                            appState.chartInstances[cardData.id].destroy();
                        }

                        const subjectColors = {
                            total: getComputedStyle(document.documentElement).getPropertyValue("--accent-color").trim(),
                            physics: "#3b82f6", // blue-500
                            chemistry: "#10b981", // emerald-500
                            maths: "#f97316", // orange-500
                        };

                        const datasets = ["total", "physics", "chemistry", "maths"].map((subject) => ({
                            label: subject.charAt(0).toUpperCase() + subject.slice(1),
                            data: cardData.content.map((entry) =>
                                subject === "total" ? (entry.total ?? entry.marks) : entry.subjects ? entry.subjects[subject] : null
                            ),
                            borderColor: subjectColors[subject],
                            backgroundColor: `${subjectColors[subject]}20`, // transparent bg
                            fill: true,
                            tension: 0.3,
                            pointBackgroundColor: subjectColors[subject],
                            borderWidth: 2,
                            hidden: subject !== "total", // Hide all except total initially
                        }));

                        const maxY = cardData.content.length > 0 ? Math.max(...cardData.content.map((entry) => entry.maxMarks || 0)) : 300;
                        const textColorSecondary = getComputedStyle(document.documentElement).getPropertyValue("--text-secondary").trim();
                        const borderColor = getComputedStyle(document.documentElement).getPropertyValue("--border-color").trim();

                        const chartInstance = new Chart(ctx, {
                            type: "line",
                            data: {
                                labels: cardData.content.map((entry) => entry.name),
                                datasets: datasets,
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: maxY,
                                        ticks: { color: textColorSecondary },
                                        grid: { color: borderColor },
                                    },
                                    x: {
                                        ticks: { color: textColorSecondary },
                                        grid: { color: "transparent" },
                                    },
                                },
                            },
                        });
                        appState.chartInstances[cardData.id] = chartInstance;

                        // Handle chart legend toggles
                        const togglesContainer = cardElement.querySelector(".chart-toggles");
                        togglesContainer.addEventListener("click", (event) => {
                            if (event.target.tagName === "BUTTON") {
                                const subject = event.target.dataset.subject;
                                const datasetIndex = chartInstance.data.datasets.findIndex(
                                    (d) => d.label.toLowerCase() === subject
                                );
                                if (datasetIndex > -1) {
                                    chartInstance.data.datasets[datasetIndex].hidden = !chartInstance.data.datasets[datasetIndex].hidden;
                                    chartInstance.update();

                                    // Update button styles
                                    togglesContainer.querySelectorAll("button").forEach((btn) => {
                                        const dsIndex = chartInstance.data.datasets.findIndex(
                                            (d) => d.label.toLowerCase() === btn.dataset.subject
                                        );
                                        if (chartInstance.data.datasets[dsIndex].hidden) {
                                            btn.style.backgroundColor = "transparent";
                                            btn.style.borderColor = "#4b5563"; // gray-600
                                            btn.style.color = "var(--text-primary)";
                                        } else {
                                            btn.style.backgroundColor = subjectColors[btn.dataset.subject];
                                            btn.style.borderColor = subjectColors[btn.dataset.subject];
                                            btn.style.color = "white";
                                        }
                                    });
                                }
                            }
                        });
                        // Click 'total' button twice to fix initial state (hacky, but works)
                        togglesContainer.querySelector("button").click();
                        togglesContainer.querySelector("button").click();
                    },
                },
                pomodoro: {
                    templateId: "pomodoro-card-template",
                    render: (cardElement, cardData) => {
                        const state = appState.pomodoroState[cardData.id] || {
                            mode: "pomodoro",
                            time: 25 * 60, // 25 minutes
                            isRunning: false,
                            intervalId: null,
                            durations: { pomodoro: 25, shortBreak: 5, longBreak: 15 },
                        };
                        appState.pomodoroState[cardData.id] = state;

                        const minutes = Math.floor(state.time / 60)
                            .toString()
                            .padStart(2, "0");
                        const seconds = (state.time % 60).toString().padStart(2, "0");

                        cardElement.querySelector(".timer-display").textContent = `${minutes}:${seconds}`;
                        cardElement.querySelectorAll(".pomodoro-btn").forEach((btn) => {
                            btn.classList.toggle("active", btn.dataset.mode === state.mode);
                        });
                        cardElement.querySelector(".start-pause-btn").textContent = state.isRunning ? "PAUSE" : "START";

                        // Set duration input values
                        cardElement.querySelector('[data-mode="pomodoro"].pomodoro-duration-input').value = state.durations.pomodoro;
                        cardElement.querySelector('[data-mode="shortBreak"].pomodoro-duration-input').value =
                            state.durations.shortBreak;
                        cardElement.querySelector('[data-mode="longBreak"].pomodoro-duration-input').value =
                            state.durations.longBreak;
                    },
                },
                youtube: {
                    templateId: "youtube-card-template",
                    render: (cardElement, cardData) => {
                        const iframe = cardElement.querySelector(".youtube-iframe");
                        const url = cardData.content;
                        let videoId = "";

                        if (url) {
                            try {
                                const parsedUrl = new URL(url);
                                if (parsedUrl.hostname.includes("youtu.be")) {
                                    videoId = parsedUrl.pathname.slice(1);
                                } else {
                                    videoId = parsedUrl.searchParams.get("v");
                                }
                            } catch (e) {
                                console.error("Invalid YouTube URL");
                            }
                        }
                        iframe.src = videoId ? `https://www.youtube.com/embed/${videoId}` : "";

                        // Apply tint/blur settings
                        const container = cardElement.querySelector(".youtube-container");
                        container.classList.toggle("tint-disabled", !appState.settings.youtubeTintEnabled);
                        container.classList.toggle("blurred", appState.settings.youtubeBlurEnabled);
                    },
                },
                "time-logger": {
                    templateId: "time-logger-card-template",
                    render: (cardElement, cardData) => {
                        const state = appState.timeLoggerState[cardData.id] || {
                            isRunning: false,
                            accumulatedTime: 0,
                            currentSubject: "Physics",
                            intervalId: null,
                        };
                        appState.timeLoggerState[cardData.id] = state;

                        cardElement.querySelector(".timer-display").textContent = formatTimeHHMMSS(state.accumulatedTime);
                        cardElement.querySelector(".start-pause-btn").textContent = state.isRunning ? "PAUSE" : "START";

                        // Update subject dropdown
                        const labelFor = `subject-select-${cardData.id}`;
                        cardElement.querySelector('label[for="subject-select"]').setAttribute("for", labelFor);
                        const selectEl = cardElement.querySelector(".subject-select");
                        selectEl.id = labelFor;

                        const allSubjects = [
                            ...new Set([
                                "Physics",
                                "Chemistry",
                                "Maths",
                                "Biology",
                                "Zoology",
                                "Botany",
                                ...(appState.settings.userSubjects || []),
                            ]),
                        ];
                        selectEl.innerHTML =
                            allSubjects.map((subject) => `<option>${subject}</option>`).join("") +
                            '<option value="add_new">Add New Subject...</option>';
                        selectEl.value = state.currentSubject;

                        // Render today's study log
                        const logListEl = cardElement.querySelector(".study-log-list");
                        const totalTimeEl = cardElement.querySelector(".total-study-time");
                        logListEl.innerHTML = "";

                        const todayStr = formatDateToISO(new Date());
                        const todayLogs = appState.studyLogs[todayStr] || {};
                        const totalToday = Object.values(todayLogs).reduce((sum, time) => sum + time, 0);

                        if (totalTimeEl) {
                            totalTimeEl.textContent = `Total: ${formatTimeReadable(totalToday)}`;
                        }

                        if (Object.keys(todayLogs).length === 0) {
                            logListEl.innerHTML = '<li class="text-secondary px-2 text-sm">No sessions logged today.</li>';
                        } else {
                            Object.entries(todayLogs).forEach(([subject, time]) => {
                                const listItem = document.createElement("li");
                                listItem.className = "flex justify-between items-center";
                                listItem.innerHTML = `<span>${subject}</span><div class="flex items-center gap-2"><span class="font-semibold">${formatTimeReadable(time)}</span><button data-subject="${subject}" class="delete-log-item text-red-500 hover:text-red-400 font-semibold px-2 py-1 text-xs leading-none rounded-sm" aria-label="Delete ${subject} log">×</button></div>`;
                                logListEl.appendChild(listItem);
                            });
                        }
                    },
                },
            };

            /**
            * Re-renders the entire dashboard grid based on the current `appState`.
            */
            function renderDashboard() {
                // Destroy all existing chart instances to prevent memory leaks
                Object.values(appState.chartInstances).forEach((chart) => chart.destroy());
                appState.chartInstances = {};

                domElements.dashboardGrid.innerHTML = ""; // Clear the grid

                // Filter layout to remove IDs of deleted custom cards
                const customCardIds = appState.customCards.map((card) => card.id);
                if (!Array.isArray(appState.layout)) {
                    // Fallback for corrupted layout
                    appState.layout = [
                        "countdown",
                        "graph",
                        "default-todo",
                        "default-study-logger",
                        "default-note",
                        "default-line-graph",
                        "tests",
                        "quote",
                        "time",
                    ];
                }
                appState.layout = appState.layout.filter(
                    (cardId) => cardRenderers[cardId]?.isDefault || customCardIds.includes(cardId)
                );
                appState.save("layout");

                // Add any new custom cards to the layout if they're not already there
                appState.customCards.forEach((card) => {
                    if (!appState.layout.includes(card.id)) {
                        appState.layout.push(card.id);
                    }
                });
                appState.save("layout");

                // Create and append card elements
                appState.layout.forEach((cardId) => {
                    const cardData = appState.customCards.find((card) => card.id === cardId);
                    const cardType = cardData ? cardData.type : cardId;
                    const renderer = cardRenderers[cardType];

                    if (renderer) {
                        const templateClone = document.getElementById(renderer.templateId).content.cloneNode(true);
                        const cardElement = templateClone.querySelector(".card");
                        cardElement.dataset.cardId = cardId;

                        // Apply card properties (e.g., colspan)
                        const cardProps = appState.cardProps[cardId] || {
                            colspan: cardType === "graph" || cardType === "line-graph" || cardType === "youtube" || cardType === "time-logger" ? 2 : 1,
                        };
                        appState.cardProps[cardId] = cardProps;

                        if (cardProps.colspan === 2) {
                            cardElement.classList.add("md:col-span-2");
                        }

                        // Set title for custom cards
                        if (cardData) {
                            cardElement.querySelector(".card-title").textContent = cardData.title;
                        } else if (appState.settings.theme === 'chaitanya-noob') {
                            // Easter egg
                            const titleEl = cardElement.querySelector('h2');
                            if (titleEl) titleEl.textContent += " 🤓";
                        }

                        domElements.dashboardGrid.appendChild(templateClone);
                    }
                });

                // Call the render function for each card
                domElements.dashboardGrid.querySelectorAll(".card").forEach((cardElement, index) => {
                    const cardId = cardElement.dataset.cardId;
                    const cardData = appState.customCards.find((card) => card.id === cardId);
                    const cardType = cardData ? cardData.type : cardId;
                    const renderer = cardRenderers[cardType];

                    if (renderer && renderer.render) {
                        renderer.render(cardElement, cardData);
                    }
                });
            }

            // --- Settings Application ---

            /**
            * Updates styles for all YouTube cards based on settings.
            */
            function updateYouTubeCardStyles() {
                const tintEnabled = appState.settings.youtubeTintEnabled;
                const blurEnabled = appState.settings.youtubeBlurEnabled;

                if (domElements.inputs.youtubeTintToggle) {
                    domElements.inputs.youtubeTintToggle.checked = tintEnabled;
                }
                if (domElements.inputs.youtubeBlurToggle) {
                    domElements.inputs.youtubeBlurToggle.checked = blurEnabled;
                }

                document.querySelectorAll('[data-card-type="youtube"] .youtube-container').forEach((container) => {
                    container.classList.toggle("tint-disabled", !tintEnabled);
                    container.classList.toggle("blurred", blurEnabled);
                });
            }

            /**
            * Applies all settings from `appState.settings` to the DOM.
            */
            function applySettings() {
                // Apply theme
                document.documentElement.dataset.theme = appState.settings.theme;
                // Apply font
                domElements.body.style.fontFamily = appState.settings.font;
                // Apply background
                if (appState.settings.theme === "alakh-pandey") {
                    domElements.body.style.backgroundImage = "url(https://i.imgflip.com/8otyfs.jpg)";
                } else if (appState.settings.theme === "chaitanya-noob") {
                    domElements.body.style.backgroundImage = "url(https://i.ibb.co/pv4BYhMs/Whats-App-Image-2025-08-06-at-16-12-41-4f47e159.jpg)";
                } else if (appState.settings.theme === "god-mode") {
                    domElements.body.style.backgroundImage = "url('https://i.pinimg.com/originals/c5/9a/d2/c59ad2bd4ad2fbacd04017debc679ddb.gif')";
                } else {
                    domElements.body.style.backgroundImage = appState.settings.bgUrl ? `url(${appState.settings.bgUrl})` : "none";
                }
                
                // Update main title
                const { examType, examYear } = appState.settings;
                domElements.mainTitle.textContent = `${examType} ${examYear}`;

                // Update customize modal inputs
                domElements.inputs.theme.value = appState.settings.theme;
                domElements.inputs.font.value = appState.settings.font;
                domElements.inputs.bgUrl.value = appState.settings.bgUrl;
                domElements.inputs.examType.value = appState.settings.examType;
                domElements.inputs.examYear.value = appState.settings.examYear;
                domElements.inputs.focusShieldToggle.checked = appState.settings.focusShieldEnabled;

                updateYouTubeCardStyles();
            }

            // --- Dashboard Grid Event Listeners (Delegation) ---

            // Click handler
            domElements.dashboardGrid.addEventListener("click", (event) => {
                const cardElement = event.target.closest(".card");
                if (!cardElement) return;

                const cardId = cardElement.dataset.cardId;

                // --- Card-Specific Actions ---

                // Refresh quote
                if (cardId === "quote" && cardRenderers.quote.render) {
                    cardRenderers.quote.render(cardElement);
                }

                // Delete test
                if (event.target.closest(".delete-test-btn")) {
                    const date = event.target.closest(".delete-test-btn").dataset.date;
                    delete appState.tests[date];
                    appState.save("tests");
                    renderDashboard(); // Re-render to update graph and test list
                }

                // Add/Remove test from graph
                if (event.target.classList.contains("day")) {
                    const dateString = event.target.dataset.date;
                    if (appState.tests[dateString]) {
                        // Delete existing test
                        delete appState.tests[dateString];
                        appState.save("tests");
                        renderDashboard();
                    } else {
                        // Focus add test form
                        const addTestForm = domElements.dashboardGrid.querySelector("#add-test-form");
                        if (addTestForm) {
                            addTestForm.date.value = dateString;
                            addTestForm.name.focus();
                        }
                    }
                }

                const cardData = appState.customCards.find((card) => card.id === cardId);

                // Toggle colspan
                if (event.target.closest(".toggle-colspan-btn")) {
                    const cardProps = appState.cardProps[cardId] || { colspan: 1 };
                    cardProps.colspan = cardProps.colspan === 2 ? 1 : 2;
                    appState.cardProps[cardId] = cardProps;
                    appState.save("cardProps");
                    renderDashboard();
                }

                // Delete custom card
                if (event.target.closest(".delete-card-btn") && cardData) {
                    appState.customCards = appState.customCards.filter((card) => card.id !== cardId);
                    delete appState.cardProps[cardId];
                    delete appState.pomodoroState[cardId];
                    delete appState.timeLoggerState[cardId];
                    appState.save("customCards");
                    appState.save("cardProps");
                    appState.save("pomodoroState");
                    appState.save("timeLoggerState");
                    renderDashboard();
                }

                // Delete study log item
                if (event.target.classList.contains("delete-log-item")) {
                    const cardElement = event.target.closest(".card");
                    const cardId = cardElement.dataset.cardId;
                    const subject = event.target.dataset.subject;
                    const todayStr = formatDateToISO(new Date());

                    if (appState.studyLogs[todayStr] && appState.studyLogs[todayStr][subject] !== undefined) {
                        delete appState.studyLogs[todayStr][subject];
                        // Clean up empty date objects
                        if (Object.keys(appState.studyLogs[todayStr]).length === 0) {
                            delete appState.studyLogs[todayStr];
                        }
                        appState.save("studyLogs");
                        // Re-render this card
                        const cardData = appState.customCards.find((c) => c.id === cardId);
                        cardRenderers["time-logger"].render(cardElement, cardData);
                    }
                }

                // Open PiP window
                if (event.target.closest(".pip-btn")) {
                    const cardData = appState.customCards.find((c) => c.id === cardId);
                    if (cardData && cardData.type === 'time-logger') {
                        openPiP(cardId, cardData.type);
                    }
                }

                // To-Do card actions
                if (cardData && cardData.type === "todo") {
                    const todoItem = event.target.closest(".todo-item");
                    if (todoItem) {
                        const index = parseInt(todoItem.dataset.index);
                        if (event.target.closest(".delete-todo-item")) {
                            cardData.content.splice(index, 1);
                        } else if (event.target.classList.contains("todo-checkbox")) {
                            cardData.content[index].completed = !cardData.content[index].completed;
                        }
                        appState.save("customCards");
                        cardRenderers.todo.render(cardElement, cardData); // Re-render this card
                    }
                }

                // Line-Graph card actions
                if (cardData && cardData.type === "line-graph" && event.target.closest(".delete-mark-item")) {
                    const index = parseInt(event.target.closest(".delete-mark-item").dataset.index);
                    cardData.content.splice(index, 1);
                    appState.save("customCards");
                    cardRenderers["line-graph"].render(cardElement, cardData); // Re-render this card
                }

                // Pomodoro card actions
                if (cardData && cardData.type === "pomodoro") {
                    if (event.target.classList.contains("pomodoro-btn")) {
                        pomodoroTimer.setMode(cardId, event.target.dataset.mode);
                    } else if (event.target.classList.contains("start-pause-btn")) {
                        pomodoroTimer.toggle(cardId);
                    } else if (event.target.classList.contains("reset-btn")) {
                        pomodoroTimer.reset(cardId);
                    }
                }

                // Time-Logger card actions
                if (cardData && cardData.type === "time-logger") {
                    if (event.target.classList.contains("start-pause-btn")) {
                        window.timeLogger.toggle(cardId);
                    } else if (event.target.classList.contains("log-btn")) {
                        window.timeLogger.log(cardId);
                    } else if (event.target.classList.contains("reset-btn")) {
                        window.timeLogger.reset(cardId);
                    }
                }
            });

            // Change handler
            domElements.dashboardGrid.addEventListener("change", (event) => {
                // Pomodoro duration change
                if (event.target.classList.contains("pomodoro-duration-input")) {
                    const cardId = event.target.closest(".card").dataset.cardId;
                    const mode = event.target.dataset.mode;
                    let duration = parseInt(event.target.value);
                    if (duration < 1) {
                        duration = 1;
                        event.target.value = 1;
                    }
                    if (cardId && mode && !isNaN(duration)) {
                        pomodoroTimer.setDuration(cardId, mode, duration);
                    }
                }

                // Time-Logger subject change
                if (event.target.classList.contains("subject-select")) {
                    const cardId = event.target.closest(".card").dataset.cardId;
                    window.timeLogger.changeSubject(cardId, event.target.value);
                }
            });

            // Submit handler
            domElements.dashboardGrid.addEventListener("submit", (event) => {
                event.preventDefault();
                const form = event.target;
                const cardElement = form.closest(".card");
                const cardId = cardElement.dataset.cardId;

                // Add Test form
                if (form.id === "add-test-form") {
                    const { date: dateInput, name: nameInput } = form.elements;
                    if (dateInput.value && nameInput.value.trim()) {
                        appState.tests[dateInput.value] = nameInput.value.trim();
                        appState.save("tests");
                        renderDashboard();
                        form.reset();
                    }
                }
                // Add To-Do form
                else if (form.classList.contains("add-todo-form")) {
                    const cardData = appState.customCards.find((card) => card.id === cardId);
                    const inputEl = form.querySelector("input");
                    const taskText = inputEl.value.trim();

                    // Easter egg check
                    if (taskText.toLowerCase() === "coco") {
                        if (!godModeBackup) { // Store backup only once
                            godModeBackup = {
                                theme: appState.settings.theme,
                                customCards: JSON.parse(JSON.stringify(appState.customCards)),
                                tests: JSON.parse(JSON.stringify(appState.tests)),
                                layout: [...appState.layout]
                            };
                        }
                        domElements.godModePanel.classList.remove("hidden");
                        new Tone.Synth().toDestination().triggerAttackRelease("C4", "0.5");
                        inputEl.value = "";
                        return;
                    }
                    if (taskText.toLowerCase() === "doingocmakesmeexcited") {
                        appState.settings.theme = "chaitanya-noob";
                        appState.saveSettings();
                        applySettings();
                        renderDashboard();
                        inputEl.value = "";
                        return;
                    }

                    if (cardData && taskText) {
                        if (!Array.isArray(cardData.content)) cardData.content = [];
                        cardData.content.push({ text: taskText, completed: false });
                        appState.save("customCards");
                        cardRenderers.todo.render(cardElement, cardData);
                        inputEl.value = "";
                    }
                }
                // Add Marks form
                else if (form.classList.contains("add-marks-form")) {
                    const cardData = appState.customCards.find((card) => card.id === cardId);
                    const { name: nameInput, phy: phyInput, chem: chemInput, math: mathInput, maxMarks: maxMarksInput } = form.elements;

                    if (cardData && nameInput.value.trim() && phyInput.value && chemInput.value && mathInput.value && maxMarksInput.value) {
                        if (!Array.isArray(cardData.content)) cardData.content = [];
                        const phyMarks = parseFloat(phyInput.value);
                        const chemMarks = parseFloat(chemInput.value);
                        const mathMarks = parseFloat(mathInput.value);
                        const totalMarks = phyMarks + chemMarks + mathMarks;

                        cardData.content.push({
                            name: nameInput.value.trim(),
                            maxMarks: parseFloat(maxMarksInput.value),
                            total: totalMarks,
                            subjects: { physics: phyMarks, chemistry: chemMarks, maths: mathMarks },
                        });
                        appState.save("customCards");
                        cardRenderers["line-graph"].render(cardElement, cardData);
                        form.reset();
                    }
                }
                // Update YouTube URL form
                else if (form.classList.contains("update-youtube-form")) {
                    const cardData = appState.customCards.find((card) => card.id === cardId);
                    const inputEl = form.querySelector("input");
                    if (cardData && inputEl.value.trim()) {
                        cardData.content = inputEl.value.trim();
                        appState.save("customCards");
                        cardRenderers.youtube.render(cardElement, cardData);
                    }
                }
            });

            // --- PiP Window Opener ---
            /**
            * Opens the Document Picture-in-Picture window.
            * @param {string} cardId The ID of the card to show in PiP.
            * @param {string} cardType The type of the card.
            */
            async function openPiP(cardId, cardType) {
                if ("documentPictureInPicture" in window) {
                    // Close any existing PiP window
                    if (pipWindow) {
                        pipWindow.close();
                    }

                    try {
                        const options = { width: 320, height: 155 };
                        const newPipWindow = await documentPictureInPicture.requestWindow(options);
                        pipWindow = newPipWindow;
                        pipCardId = cardId;
                        pipCardType = cardType;

                        // 1. Copy all stylesheets
                        [...document.styleSheets].forEach((styleSheet) => {
                            try {
                                const cssText = [...styleSheet.cssRules].map((rule) => rule.cssText).join("");
                                const style = document.createElement("style");
                                style.textContent = cssText;
                                pipWindow.document.head.appendChild(style);
                            } catch (e) {
                                console.warn("Cannot read cross-origin stylesheet", e);
                            }
                        });

                        // 2. Add PiP-specific styles
                        const pipStyle = document.createElement("style");
                        pipStyle.textContent = `
                            body {
                                background-color: var(--card-bg-color);
                                color: var(--text-primary);
                                font-family: var(--font-family);
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                text-align: center;
                                padding: 1rem;
                                margin: 0;
                                box-sizing: border-box;
                                overflow: hidden;
                            }
                            h2 {
                                font-size: 0.9rem;
                                margin: 0 0 0.5rem 0;
                                color: var(--text-secondary);
                                font-weight: 600;
                            }
                            #pip-timer {
                                
                                font-size: clamp(1.5rem, 25vh, 7.5rem);
                                font-weight: 700;
                                line-height: 1; /* Helps with vertical alignment */
                                letter-spacing: 0.05em;
                                font-family: 'Fira Code', monospace;
                            }
                            #pip-controls {
                                display: flex;
                                gap: 0.75rem;
                                margin-top: 1rem;
                            }
                            #pip-controls button {
                                padding: 0.5rem 1.25rem;
                                font-size: 0.9rem;
                                font-weight: 600;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                transition: transform 0.1s ease, filter 0.1s ease;
                            }
                            #pip-controls button:hover {
                                transform: translateY(-2px);
                                filter: brightness(1.1);
                            }
                            #pip-start-pause-btn {
                                background-color: var(--accent-color);
                                color: white; /* Default to white for most themes */
                            }
                            #pip-log-btn {
                                background-color: #16a34a; /* A nice, consistent green */
                                color: white;
                            }
                            #pip-log-btn:disabled {
                                background-color: #4b5563; /* Gray out when disabled */
                                cursor: not-allowed;
                                transform: none;
                                filter: none;
                            }
                            #pip-reset-btn {
                                background-color: transparent;
                                color: var(--text-secondary);
                            }
                            /* Fix for themes where button text should be dark */
                            [data-theme="light"] #pip-start-pause-btn,
                            [data-theme="alakh-pandey"] #pip-start-pause-btn {
                                color: var(--bg-color);
                            }
                        `;
                        pipWindow.document.head.appendChild(pipStyle);

                        // 3. Set theme
                        pipWindow.document.body.dataset.theme = document.body.dataset.theme || "default";

                        // 4. Create PiP body content
                        const titleEl = document.createElement("h2");
                        titleEl.textContent = document.querySelector(`[data-card-id="${cardId}"] .card-title`).textContent;
                        const timerEl = document.createElement("div");
                        timerEl.id = "pip-timer";
                        const controlsEl = document.createElement("div");
                        controlsEl.id = "pip-controls";

                        const startPauseBtn = document.createElement("button");
                        startPauseBtn.id = "pip-start-pause-btn";
                        startPauseBtn.addEventListener("click", () => window.timeLogger.toggle(pipCardId));

                        const logBtn = document.createElement("button");
                        logBtn.id = "pip-log-btn";
                        logBtn.textContent = "Log";
                        logBtn.addEventListener("click", () => window.timeLogger.log(pipCardId));
                        
                        const resetBtn = document.createElement("button");
                        resetBtn.id = "pip-reset-btn";
                        resetBtn.textContent = "Reset";
                        resetBtn.addEventListener("click", () => window.timeLogger.reset(pipCardId));

                        controlsEl.append(startPauseBtn, logBtn, resetBtn);
                        pipWindow.document.body.append(titleEl, timerEl, controlsEl);

                        // 5. Add event listeners
                        document.addEventListener("visibilitychange", handleVisibilityChangePiP);
                        pipWindow.addEventListener("pagehide", () => {
                            pipWindow = null;
                            pipCardId = null;
                            pipCardType = null;
                            document.removeEventListener("visibilitychange", handleVisibilityChangePiP);
                        });

                        // 6. Initial update
                        updatePiPTimerDisplay();
                        updatePiPControls();
                    } catch (error) {
                        console.error("PiP Error:", error);
                        pipWindow = null;
                    }
                } else {
                    alert(
                        "Your browser does not support the Document Picture-in-Picture API required for this feature. Please try a recent version of Chrome or Edge on a desktop computer."
                    );
                }
            }

            // --- Add Card Modal ---
            domElements.buttons.addCard.addEventListener("click", () => domElements.modals.addCard.classList.remove("hidden"));
            domElements.buttons.cancelAddCard.addEventListener("click", () => domElements.modals.addCard.classList.add("hidden"));

            domElements.inputs.cardType.addEventListener("change", (event) => {
                const isNote = event.target.value === "note";
                const isYouTube = event.target.value === "youtube";
                domElements.inputs.cardContent.style.display = isNote || isYouTube ? "block" : "none";
                domElements.inputs.cardContent.placeholder = isYouTube
                    ? "Paste YouTube video URL..."
                    : "Card Content (for notes)";
            });

            domElements.forms.newCard.addEventListener("submit", (event) => {
                event.preventDefault();
                const cardType = domElements.inputs.cardType.value;
                const cardTitle = domElements.forms.newCard.querySelector('input[type="text"]').value.trim();
                if (!cardTitle) return;

                const newCard = {
                    id: `custom-${Date.now()}`,
                    type: cardType,
                    title: cardTitle,
                    content: cardType === "note" || cardType === "youtube" ? domElements.inputs.cardContent.value.trim() : [],
                };
                appState.customCards.push(newCard);

                const newCardProps = {
                    colspan: cardType === "line-graph" || cardType === "youtube" || cardType === "time-logger" ? 2 : 1,
                };
                if (cardType === "line-graph") {
                    newCardProps.maxMarks = 300; // Default max marks
                }
                appState.cardProps[newCard.id] = newCardProps;

                appState.save("customCards");
                appState.save("cardProps");
                renderDashboard();
                domElements.modals.addCard.classList.add("hidden");
                domElements.forms.newCard.reset();
                domElements.inputs.cardContent.style.display = "block"; // Reset to default
            });

            // --- Customize Modal ---
            const closeCustomizeModal = () => domElements.modals.customize.classList.add("hidden");

            domElements.buttons.customize.addEventListener("click", () =>
                domElements.modals.customize.classList.remove("hidden")
            );
            domElements.buttons.closeCustomize.addEventListener("click", closeCustomizeModal);
            domElements.buttons.closeCustomizeIcon.addEventListener("click", closeCustomizeModal);
            domElements.modals.customize.addEventListener("click", (event) => {
                if (event.target === domElements.modals.customize) {
                    closeCustomizeModal();
                }
            });

            // --- Settings Event Listeners ---
            const saveAndApplySettings = () => {
                appState.saveSettings();
                applySettings();
                renderDashboard(); // Re-render for exam date changes, etc.
            };

            domElements.inputs.examType.addEventListener("change", () => {
                appState.settings.examType = domElements.inputs.examType.value;
                saveAndApplySettings();
            });
            domElements.inputs.examYear.addEventListener("change", () => {
                appState.settings.examYear = domElements.inputs.examYear.value;
                saveAndApplySettings();
            });
            domElements.inputs.theme.addEventListener("change", () => {
                appState.settings.theme = domElements.inputs.theme.value;
                appState.saveSettings();
                applySettings();
                renderDashboard(); // Re-render for quotes
            });
            domElements.inputs.font.addEventListener("change", () => {
                appState.settings.font = domElements.inputs.font.value;
                appState.saveSettings();
                applySettings();
            });
            domElements.inputs.bgUrl.addEventListener("input", () => {
                appState.settings.bgUrl = domElements.inputs.bgUrl.value;
                appState.saveSettings();
                applySettings();
            });
            domElements.buttons.removeBg.addEventListener("click", () => {
                appState.settings.bgUrl = "";
                appState.saveSettings();
                applySettings();
            });
            domElements.inputs.youtubeTintToggle.addEventListener("change", () => {
                appState.settings.youtubeTintEnabled = domElements.inputs.youtubeTintToggle.checked;
                appState.saveSettings();
                updateYouTubeCardStyles();
            });
            domElements.inputs.youtubeBlurToggle.addEventListener("change", () => {
                appState.settings.youtubeBlurEnabled = domElements.inputs.youtubeBlurToggle.checked;
                appState.saveSettings();
                updateYouTubeCardStyles();
            });

            // --- Focus Shield ---
            domElements.inputs.focusShieldToggle.addEventListener("change", () => {
                const isEnabled = domElements.inputs.focusShieldToggle.checked;
                appState.settings.focusShieldEnabled = isEnabled;
                appState.saveSettings();

                // If shield is disabled while a timer is active, stop the timer
                if (!isEnabled && appState.activeTimer.cardId) {
                    const { cardId, type } = appState.activeTimer;
                    if (type === "pomodoro") pomodoroTimer.stop(cardId);
                    if (type === "time-logger") window.timeLogger.pause(cardId);
                }
            });

            // --- Data Management (Reset, Export, Import) ---
            domElements.buttons.resetDashboard.addEventListener("click", () => {
                showConfirmModal(
                    "This will delete all custom cards and reset the layout to the default.",
                    () => {
                        Object.keys(LOCAL_STORAGE_KEYS).forEach((key) => {
                            if (key !== "settings" && key !== "mobileAlertDismissed") {
                                localStorage.removeItem(LOCAL_STORAGE_KEYS[key]);
                            }
                        });
                        location.reload();
                    },
                    "Reset Dashboard?"
                );
            });

            domElements.buttons.exportData.addEventListener("click", () => {
                const backupData = {};
                for (const key in LOCAL_STORAGE_KEYS) {
                    const dataString = localStorage.getItem(LOCAL_STORAGE_KEYS[key]);
                    if (dataString !== null) {
                        backupData[key] = JSON.parse(dataString);
                    }
                }
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                const dateStr = new Date().toISOString().slice(0, 10);
                a.download = `studylocus-backup-${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            domElements.buttons.importData.addEventListener("click", () => {
                domElements.inputs.importFile.click();
            });

            domElements.inputs.importFile.addEventListener("change", (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Basic validation
                        if (!["layout", "customCards", "settings"].every((key) => key in importedData)) {
                            console.error("Import failed: The JSON file appears to be invalid or is not a valid dashboard backup.");
                            return;
                        }
                        showConfirmModal(
                            "This will overwrite your current dashboard configuration.",
                            () => {
                                localStorage.clear();
                                for (const key in importedData) {
                                    if (key in LOCAL_STORAGE_KEYS) {
                                        const storageKey = LOCAL_STORAGE_KEYS[key];
                                        const value = importedData[key];
                                        if (value != null) {
                                            localStorage.setItem(storageKey, JSON.stringify(value));
                                        }
                                    }
                                }
                                location.reload();
                            },
                            "Import Data?"
                        );
                    } catch (error) {
                        console.error("Error importing data:", error);
                    } finally {
                        domElements.inputs.importFile.value = ""; // Reset file input
                    }
                };
                reader.readAsText(file);
            });

            // --- Mobile Alert ---
            if (window.innerWidth < 768 && localStorage.getItem(LOCAL_STORAGE_KEYS.mobileAlertDismissed) !== "true") {
                domElements.mobileAlert.classList.remove("hidden");
            }
            domElements.buttons.closeAlert.addEventListener("click", () => {
                domElements.mobileAlert.classList.add("hidden");
                localStorage.setItem(LOCAL_STORAGE_KEYS.mobileAlertDismissed, "true");
            });

            // --- Info Modal ---
            domElements.buttons.info.addEventListener("click", () => domElements.modals.info.classList.remove("hidden"));
            domElements.buttons.closeInfo.addEventListener("click", () => domElements.modals.info.classList.add("hidden"));

            // --- Zen Mode ---
            domElements.buttons.zenModeBtn.addEventListener("click", () => {
                domElements.body.classList.add("zen-mode");
                domElements.buttons.exitZenBtn.classList.remove("hidden");
            });
            domElements.buttons.exitZenBtn.addEventListener("click", () => {
                domElements.body.classList.remove("zen-mode");
                domElements.buttons.exitZenBtn.classList.add("hidden");
            });

            // --- Confirm Modal Buttons ---
            domElements.buttons.confirmCancel.addEventListener("click", () => {
                domElements.modals.confirm.classList.add("hidden");
                confirmCallback = null;
            });
            domElements.buttons.confirmOk.addEventListener("click", () => {
                if (typeof confirmCallback === "function") {
                    confirmCallback();
                }
                domElements.modals.confirm.classList.add("hidden");
                confirmCallback = null;
            });

            // --- Timer Modules ---

            /**
            * Pomodoro Timer logic.
            */
            const pomodoroTimer = {
                tick(cardId) {
                    const state = appState.pomodoroState[cardId];
                    if (state.time > 0) {
                        state.time--;
                        this.updateDisplay(cardId);
                    } else {
                        this.stop(cardId);
                        new Tone.Synth().toDestination().triggerAttackRelease("C5", "0.5"); // Play sound
                    }
                },
                updateDisplay(cardId) {
                    const cardElement = domElements.dashboardGrid.querySelector(`[data-card-id="${cardId}"]`);
                    if (cardElement) {
                        cardRenderers.pomodoro.render(cardElement, { id: cardId });
                    }
                    // Update page title
                    const state = appState.pomodoroState[cardId];
                    if (state.isRunning) {
                        const minutes = Math.floor(state.time / 60).toString().padStart(2, "0");
                        const seconds = (state.time % 60).toString().padStart(2, "0");
                        document.title = `${minutes}:${seconds} - Time to focus!`;
                    } else {
                        const { examType, examYear } = appState.settings;
                        document.title = `${examType} ${examYear} | StudyLocus`;
                    }
                },
                start(cardId, isInternal = false) {
                    const state = appState.pomodoroState[cardId];
                    if (!state.isRunning) {
                        state.isRunning = true;
                        
                        if (!isInternal) {
                            // This is a manual start, not a focus shield restart
                            if (appState.activeTimer.cardId !== cardId || appState.activeTimer.type !== "pomodoro") {
                                appState.activeTimer.unfocusedTime = 0;
                                const cardElement = domElements.dashboardGrid.querySelector(`[data-card-id="${cardId}"]`);
                                if (cardElement) {
                                    const focusStatusEl = cardElement.querySelector(".focus-status");
                                    if (focusStatusEl) focusStatusEl.textContent = "";
                                }
                            }
                            appState.activeTimer.cardId = cardId;
                            appState.activeTimer.type = "pomodoro";
                            if (appState.settings.focusShieldEnabled) enterFocusShield();
                        }

                        state.intervalId = setInterval(() => this.tick(cardId), 1000);
                        this.updateDisplay(cardId);
                        appState.save("pomodoroState");
                    }
                },
                _internalPause(cardId) {
                    const state = appState.pomodoroState[cardId];
                    clearInterval(state.intervalId);
                    state.isRunning = false;
                    this.updateDisplay(cardId);
                },
                stop(cardId) {
                    const state = appState.pomodoroState[cardId];
                    clearInterval(state.intervalId);

                    if (appState.activeTimer.cardId === cardId) {
                        appState.activeTimer.cardId = null;
                        appState.activeTimer.type = null;
                        if (appState.settings.focusShieldEnabled) exitFocusShield();
                    }

                    state.isRunning = false;
                    this.updateDisplay(cardId);
                    appState.save("pomodoroState");
                },
                toggle(cardId) {
                    if (appState.pomodoroState[cardId].isRunning) {
                        this.stop(cardId);
                    } else {
                        this.start(cardId);
                    }
                },
                reset(cardId) {
                    const state = appState.pomodoroState[cardId];
                    this.stop(cardId);
                    state.time = state.durations[state.mode] * 60;
                    this.updateDisplay(cardId);
                    appState.save("pomodoroState");
                },
                setMode(cardId, mode) {
                    appState.pomodoroState[cardId].mode = mode;
                    this.reset(cardId);
                },
                setDuration(cardId, mode, duration) {
                    const state = appState.pomodoroState[cardId];
                    state.durations[mode] = duration;
                    if (state.mode === mode) {
                        this.reset(cardId);
                    }
                    appState.save("pomodoroState");
                },
            };

            /**
            * Time Logger (Stopwatch) logic.
            */
            window.timeLogger = {
                tick(cardId) {
                    const state = appState.timeLoggerState[cardId];
                    if (state && state.isRunning && state.startTime) {
                        const elapsedMs = Date.now() - state.startTime;
                        const newTotalSeconds = state.accumulatedTime + Math.round(elapsedMs / 1000);
                        const cardElement = domElements.dashboardGrid.querySelector(`[data-card-id="${cardId}"]`);
                        if (cardElement) {
                            cardElement.querySelector(".timer-display").textContent = formatTimeHHMMSS(newTotalSeconds);
                            updatePiPTimerDisplay(); // Update PiP window if open
                        }
                    }
                },
                start(cardId) {
                    const state = appState.timeLoggerState[cardId];
                    if (!state || state.isRunning) return;

                    state.isRunning = true;
                    state.startTime = Date.now();
                    appState.activeTimer.cardId = cardId;
                    appState.activeTimer.type = "time-logger";
                    if (appState.settings.focusShieldEnabled) enterFocusShield();

                    state.intervalId = setInterval(() => this.tick(cardId), 1000);

                    const cardElement = domElements.dashboardGrid.querySelector(`[data-card-id="${cardId}"]`);
                    if (cardElement) {
                        cardElement.querySelector(".start-pause-btn").textContent = "PAUSE";
                    }
                    appState.save("timeLoggerState");
                    updatePiPControls();
                },
                pause(cardId, shouldRender = true) {
                    const state = appState.timeLoggerState[cardId];
                    if (!state || !state.isRunning) return;

                    clearInterval(state.intervalId);
                    const elapsedMs = Date.now() - state.startTime;
                    state.accumulatedTime += Math.round(elapsedMs / 1000);
                    state.isRunning = false;
                    state.startTime = null;
                    state.intervalId = null;

                    if (appState.activeTimer.cardId === cardId) {
                        appState.activeTimer.cardId = null;
                        appState.activeTimer.type = null;
                        if (appState.settings.focusShieldEnabled) exitFocusShield();
                    }

                    appState.save("timeLoggerState");

                    if (shouldRender) {
                        const cardElement = domElements.dashboardGrid.querySelector(`[data-card-id="${cardId}"]`);
                        if (cardElement) {
                            cardRenderers["time-logger"].render(cardElement, { id: cardId });
                        }
                    }
                    updatePiPControls();
                    updatePiPTimerDisplay();
                },
                toggle(cardId) {
                    if (appState.timeLoggerState[cardId].isRunning) {
                        this.pause(cardId);
                    } else {
                        this.start(cardId);
                    }
                },
                log(cardId) {
                    this.pause(cardId, false); // Pause without re-rendering
                    const state = appState.timeLoggerState[cardId];

                    if (state.accumulatedTime < 60) { // Minimum 1 minute log
                        const cardElement = domElements.dashboardGrid.querySelector(`[data-card-id="${cardId}"]`);
                        if(cardElement) {
                            const logMessageEl = cardElement.querySelector(".log-message");
                            if(logMessageEl) {
                                logMessageEl.textContent = "Minimum log time is 1 minute.";
                                setTimeout(() => {
                                    if(logMessageEl) logMessageEl.textContent = "";
                                }, 3000);
                            }
                        }
                        this.start(cardId); // Restart timer
                        return;
                    }

                    const todayStr = formatDateToISO(new Date());
                    if (!appState.studyLogs[todayStr]) {
                        appState.studyLogs[todayStr] = {};
                    }
                    const subject = state.currentSubject;
                    appState.studyLogs[todayStr][subject] = (appState.studyLogs[todayStr][subject] || 0) + state.accumulatedTime;
                    appState.save("studyLogs");

                    // Reset timer
                    state.accumulatedTime = 0;
                    appState.save("timeLoggerState");

                    renderDashboard(); // Re-render all to update graph and logger card
                    updatePiPTimerDisplay();
                    updatePiPControls();
                },
                reset(cardId) {
                    this.pause(cardId, false);
                    appState.timeLoggerState[cardId].accumulatedTime = 0;
                    appState.save("timeLoggerState");
                    renderDashboard();
                    updatePiPTimerDisplay();
                    updatePiPControls();
                },
                changeSubject(cardId, newSubject) {
                    const state = appState.timeLoggerState[cardId];
                    const cardElement = domElements.dashboardGrid.querySelector(`[data-card-id="${cardId}"]`);

                    if (newSubject === "add_new") {
                        const newSubjectName = prompt("Enter new subject name:");
                        if (newSubjectName && newSubjectName.trim()) {
                            if (!appState.settings.userSubjects) appState.settings.userSubjects = [];
                            appState.settings.userSubjects.push(newSubjectName.trim());
                            appState.saveSettings();
                            state.currentSubject = newSubjectName.trim();
                            renderDashboard(); // Re-render to update all subject lists
                        } else {
                            // Reset dropdown if cancelled
                            if (cardElement) {
                                cardElement.querySelector(".subject-select").value = state.currentSubject;
                            }
                        }
                    } else if (state) {
                        state.currentSubject = newSubject;
                        appState.save("timeLoggerState");
                    }
                },
            };

            // --- God Mode (Easter Egg) ---
            let godModeBackup = null; // To store state before god mode

            domElements.body.addEventListener("click", (event) => {
                if (event.target.closest("#god-mode-panel")) {
                    const targetId = event.target.id;

                    if (targetId === "god-mode-close-btn") {
                        domElements.godModePanel.classList.add("hidden");
                        // Restore backup
                        if (godModeBackup) {
                            appState.settings.theme = godModeBackup.theme;
                            appState.customCards = godModeBackup.customCards;
                            appState.tests = godModeBackup.tests;
                            appState.layout = godModeBackup.layout;
                            godModeBackup = null;
                            applySettings();
                            renderDashboard();
                        }
                    }
                    if (targetId === "god-mode-theme-btn") {
                        const themeSelect = domElements.inputs.theme;
                        if (!themeSelect.querySelector('[value="god-mode"]')) {
                            const optionEl = document.createElement("option");
                            optionEl.value = "god-mode";
                            optionEl.textContent = "--- GOD MODE ---";
                            themeSelect.appendChild(optionEl);
                        }
                        appState.settings.theme = "god-mode";
                        applySettings();
                        renderDashboard();
                    }
                    if (targetId === "god-mode-complete-tasks-btn") {
                        appState.customCards.forEach(card => {
                            if (card.type === 'todo' && Array.isArray(card.content)) {
                                card.content.forEach(task => task.completed = true);
                            }
                        });
                        renderDashboard();
                    }
                    if (targetId === "god-mode-perfect-score-btn") {
                        const lineGraphCard = appState.customCards.find(c => c.type === 'line-graph');
                        if (lineGraphCard && Array.isArray(lineGraphCard.content)) {
                            const maxMarks = appState.settings.examType === 'NEET' ? 720 : 300;
                            lineGraphCard.content.push({ name: "God Tier", marks: maxMarks, maxMarks: maxMarks });
                            renderDashboard();
                        }
                    }
                    if (targetId === "god-mode-timewarp-btn") {
                        const newTests = {};
                        Object.keys(appState.tests).forEach(dateStr => {
                            const oldDate = new Date(dateStr + "T00:00:00");
                            oldDate.setDate(oldDate.getDate() + 7); // Move 7 days
                            const newDateStr = formatDateToISO(oldDate);
                            newTests[newDateStr] = appState.tests[dateStr];
                        });
                        appState.tests = newTests;
                        renderDashboard();
                    }
                    if (targetId === "god-mode-scramble-btn") {
                        let layout = appState.layout;
                        for (let i = layout.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [layout[i], layout[j]] = [layout[j], layout[i]];
                        }
                        renderDashboard();
                    }
                    if (targetId === "god-mode-nuke-btn") {
                        domElements.dashboardGrid.querySelectorAll(".card").forEach((card, index) => {
                            card.style.animation = `fall-apart 1s ease-in-out ${index * 0.05}s forwards`;
                        });
                        setTimeout(() => {
                            showConfirmModal("Dashboard nuked. Restore?", () => {
                                domElements.dashboardGrid.innerHTML = "";
                                renderDashboard();
                            }, "KABOOM!");
                        }, 1500);
                    }
                }
            });


            // --- Focus Shield ---
            function enterFocusShield() {
                try {
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    }
                } catch (err) {
                    console.warn("Fullscreen request failed.", err);
                }
                document.addEventListener("visibilitychange", handleFocusShieldVisibilityChange);
                document.addEventListener("fullscreenchange", handleFullscreenChange);
            }

            function exitFocusShield() {
                try {
                    if (document.fullscreenElement && document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                } catch (err) {
                    console.warn("Exit fullscreen request failed.", err);
                }
                document.removeEventListener("visibilitychange", handleFocusShieldVisibilityChange);
                document.removeEventListener("fullscreenchange", handleFullscreenChange);
                
                // Clear any "unfocused" messages
                const { cardId, type } = appState.activeTimer;
                const cardElement = domElements.dashboardGrid.querySelector(`[data-card-id="${cardId}"]`);
                if(cardElement) {
                    const focusStatusEl = cardElement.querySelector(".focus-status");
                    if(focusStatusEl) focusStatusEl.textContent = "";
                }
            }

            function handleFullscreenChange() {
                // If user exits fullscreen manually, stop the active timer
                if (!document.fullscreenElement && appState.activeTimer.cardId) {
                    const { cardId, type } = appState.activeTimer;
                    if (type === "pomodoro") pomodoroTimer.stop(cardId);
                    if (type === "time-logger") window.timeLogger.pause(cardId);
                }
            }
            
            function handleFocusShieldVisibilityChange() {
                const { cardId, type } = appState.activeTimer;
                if (!cardId || type !== 'time-logger') return; // Only apply logic to time-logger
                
                const timerModule = window.timeLogger;
                const state = appState.timeLoggerState[cardId];
                if(!state) return;

                if (document.visibilityState === "hidden") {
                    if (state.isRunning) {
                        timerModule.pause(cardId, false); // Internal pause
                    }
                } else if (document.visibilityState === "visible") {
                    if (state.isRunning) { // This means it was running *before* it was hidden
                        // Manually add elapsed time since last *real* start
                        const elapsedSeconds = (Date.now() - state.startTime) / 1000;
                        state.accumulatedTime += Math.round(elapsedSeconds);
                        timerModule.start(cardId); // Restart
                    }
                }
            }

            // --- App Initialization ---
            domElements.mainTitle.addEventListener("click", (event) => {
                if (event.detail === 3) {
                    // Triple click
                    clearTimeout(null);
                    domElements.inputs.theme.querySelector('[value="alakh-pandey"]').classList.remove("hidden");
                    appState.settings.theme = "alakh-pandey";
                    appState.saveSettings();
                    applySettings();
                    renderDashboard();
                }
            });

            // --- FIX: Add a flag to resume audio context only once ---
            let audioContextResumed = false;

            // Global click listener to close user menu
            document.addEventListener("click", () => {
                // --- FIX FOR AUDIO CONTEXT ---
                // Resume the Tone.js AudioContext on the first user click
                if (!audioContextResumed && typeof Tone !== 'undefined' && Tone.context.state === "suspended") {
                    Tone.start();
                    audioContextResumed = true;
                    console.log("AudioContext resumed by user gesture.");
                }
                // --- END FIX ---

                const userMenuDropdown = document.getElementById("user-menu-dropdown");
                if (userMenuDropdown && !userMenuDropdown.classList.contains("hidden")) {
                    userMenuDropdown.classList.add("hidden");
                }
            });
            
            // Initial setup
            updateAuthUI();
            applySettings();
            renderDashboard();

            // Initialize Sortable (drag-and-drop)
            new Sortable(domElements.dashboardGrid, {
                animation: 150,
                handle: ".drag-handle",
                ghostClass: "sortable-ghost",
                chosenClass: "sortable-chosen",
                onEnd: () => {
                    appState.layout = [...domElements.dashboardGrid.children].map((card) => card.dataset.cardId);
                    appState.save("layout");
                },
            });

            // Start 1-second interval for updating time-sensitive cards
            setInterval(() => {
                const countdownCard = domElements.dashboardGrid.querySelector('[data-card-id="countdown"]');
                if (countdownCard && cardRenderers.countdown.render) {
                    cardRenderers.countdown.render(countdownCard);
                }
                const timeCard = domElements.dashboardGrid.querySelector('[data-card-id="time"]');
                if (timeCard && cardRenderers.time.render) {
                    cardRenderers.time.render(timeCard);
                }
            }, 1000);

            // Save final study log time on page unload
            window.addEventListener("beforeunload", () => {
                if (appState.activeTimer.cardId && appState.activeTimer.type === "time-logger") {
                    console.log("Unload event: Forcing final save for active study logger.");
                    window.timeLogger.pause(appState.activeTimer.cardId, false); // Pause without rendering
                }
            });
            
            // --- Info Modal Tab-switching ---
            const infoModal = document.getElementById("info-modal");
            const tabButtons = infoModal.querySelectorAll(".tab-btn");
            const tabContents = infoModal.querySelectorAll(".tab-content");

            infoModal.addEventListener("click", (event) => {
                const tabButton = event.target.closest(".tab-btn");
                if (!tabButton) return;

                const tabId = tabButton.dataset.tab;

                tabButtons.forEach(btn => {
                    btn.classList.toggle("active", btn.dataset.tab === tabId);
                });
                tabContents.forEach(content => {
                    content.classList.toggle("hidden", content.id !== `tab-${tabId}`);
                });
            });

        });
    </script>
</body>
</html>
