<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE 2026 Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Inter:wght@400;600;700&family=Roboto+Slab&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Draggable Library -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Charting Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg-color: #161b22;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-color: #3b82f6;
            --font-family: 'Inter', sans-serif;
        }

        [data-theme="light"] {
            --bg-color: #f0f0f0;
            --card-bg-color: #ffffff;
            --border-color: #d1d5db;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
        }

        [data-theme="cyberpunk"] {
            --bg-color: #0c0a24;
            --card-bg-color: rgba(23, 0, 61, 0.6);
            --border-color: #ff00f2;
            --text-primary: #00f7ff;
            --text-secondary: #faff00;
            --accent-color: #ff00f2;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        #bg-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: -1;
        }
        .graph-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(14px, 1fr));
            grid-auto-rows: 14px;
            grid-gap: 3px;
            overflow-x: auto;
        }
        .day {
            width: 14px; height: 14px; border-radius: 3px;
            position: relative; cursor: pointer;
        }
        .day-past { background-color: #21262d; }
        .day-future { background-color: #0e4429; }
        .day-today { background-color: #1a633a; border: 1px solid #3cc36e; }
        .day-exam { background-color: #9e2a2b; border: 1px solid #ff6b6b; }
        .day-part-test { background-color: #1f6feb; border: 1px solid #58a6ff; }
        .day .tooltip {
            visibility: hidden; width: 160px; background-color: #21262d;
            color: #fff; text-align: center; border-radius: 6px;
            padding: 5px 0; position: absolute; z-index: 10;
            bottom: 125%; left: 50%; margin-left: -80px;
            opacity: 0; transition: opacity 0.3s; font-size: 12px;
            border: 1px solid #30363d; pointer-events: none;
        }
        .day:hover .tooltip { visibility: visible; opacity: 1; }
        #countdown-timer { font-size: 1.75rem; font-weight: 600; }
        @media (min-width: 640px) { #countdown-timer { font-size: 2.25rem; } }
        @media (min-width: 1024px) { #countdown-timer { font-size: 2.5rem; } }
        .card { 
            background-color: var(--card-bg-color); 
            border: 1px solid var(--border-color); 
            color: var(--text-primary);
            border-radius: 8px; padding: 1rem;
            backdrop-filter: blur(5px);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease-in-out;
        }
        .card-header:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .drag-handle { cursor: grab; }
        .sortable-ghost {
            background: #1f2937;
            opacity: 0.6;
            border: 2px dashed var(--accent-color);
        }
        .sortable-chosen { cursor: grabbing; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 50;
        }
        .todo-item.completed span {
            text-decoration: line-through;
            color: var(--text-secondary);
        }
        .form-input {
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        [data-theme="cyberpunk"] .btn-primary { color: var(--bg-color); }
        .text-secondary { color: var(--text-secondary); }
        select.form-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='var(--text-secondary)' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        select.form-input option {
            background: var(--card-bg-color);
            color: var(--text-primary);
        }
        [data-theme="light"] .form-input {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }
        /* **NEW**: Utility class to hide scrollbars */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
    </style>
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TCK0S6VC58"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TCK0S6VC58');
</script>
<body class="antialiased">
    <div id="bg-overlay"></div>
    <div class="container mx-auto px-2 sm:px-4 py-6">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold">JEE 2026</h1>
            <div>
                 <button id="customize-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm mr-2">Customize</button>
                <button id="add-card-btn" class="btn-primary font-bold py-2 px-4 rounded-md transition-colors text-sm">
                    + Add Card
                </button>
            </div>
        </header>

        <!-- Dashboard Grid -->
        <main id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            <!-- Cards will be dynamically inserted here by JavaScript -->
        </main>
    </div>

    <footer class="text-center py-4 mt-4">
        <p class="text-xs text-secondary">
            Built by <a href="https://github.com/svalordev" target="_blank" rel="noopener noreferrer" class="hover:underline" style="color: var(--accent-color);">SHAURYA PRATAP SINGH</a>
        </p>
    </footer>

    <!-- Templates for cards -->
    <template id="countdown-template">
        <div class="card" data-card-id="countdown">
            <div class="card-header">
                <h2 class="text-lg font-semibold">Countdown</h2>
                <div class="drag-handle text-secondary p-2">☰</div>
            </div>
            <div id="countdown-timer" class="flex justify-center space-x-2 sm:space-x-4 md:space-x-8 text-center py-2">
                <div><div data-value="days" class="font-bold">00</div><div class="text-xs sm:text-sm text-secondary">Days</div></div>
                <div><div data-value="hours" class="font-bold">00</div><div class="text-xs sm:text-sm text-secondary">Hours</div></div>
                <div><div data-value="minutes" class="font-bold">00</div><div class="text-xs sm:text-sm text-secondary">Minutes</div></div>
                <div><div data-value="seconds" class="font-bold">00</div><div class="text-xs sm:text-sm text-secondary">Seconds</div></div>
            </div>
        </div>
    </template>

    <template id="graph-template">
        <div class="card md:col-span-2 xl:col-span-2" data-card-id="graph">
            <div class="card-header">
                <h2 class="text-lg font-semibold">Journey</h2>
                <div class="drag-handle text-secondary p-2">☰</div>
            </div>
            <div class="graph-container no-scrollbar" id="contribution-graph"></div>
            <div class="flex justify-center flex-wrap gap-x-4 gap-y-2 mt-4 text-xs text-secondary">
                <div class="legend-item"><div class="legend-color day-future"></div><span>Future</span></div>
                <div class="legend-item"><div class="legend-color day-today"></div><span>Today</span></div>
                <div class="legend-item"><div class="legend-color day-part-test"></div><span>Test</span></div>
                <div class="legend-item"><div class="legend-color day-exam"></div><span>Exam</span></div>
            </div>
        </div>
    </template>

    <template id="tests-template">
         <div class="card" data-card-id="tests">
            <div class="card-header">
                <h2 class="text-lg font-semibold">Test Planner</h2>
                <div class="drag-handle text-secondary p-2">☰</div>
            </div>
            <form id="add-test-form" class="flex flex-col gap-3 mb-4">
                 <input type="date" name="date" class="form-input rounded-md p-2 w-full text-sm" required>
                 <input type="text" name="name" placeholder="Test Name" class="form-input rounded-md p-2 flex-grow text-sm" required>
                 <button type="submit" class="btn-primary font-bold py-2 px-4 rounded-md transition-colors w-full text-sm">Add Test</button>
            </form>
            <div id="test-list-container">
                 <h3 class="text-md font-semibold mb-2 border-b pb-1" style="border-color: var(--border-color);">Tests</h3>
                 <ul id="test-list" class="space-y-2 max-h-48 overflow-y-auto no-scrollbar"></ul>
            </div>
        </div>
    </template>
    
    <template id="quote-template">
        <div class="card" data-card-id="quote">
            <div class="card-header">
                <h2 class="text-lg font-semibold">Quote</h2>
                <div class="drag-handle text-secondary p-2">☰</div>
            </div>
            <div id="quote-card-content" class="text-center cursor-pointer transition-transform transform hover:scale-105">
                 <p id="quote" class="text-md italic">"The best way to predict the future is to create it."</p>
                 <p id="author" class="text-sm text-secondary mt-2">- Peter Drucker</p>
            </div>
        </div>
    </template>

    <template id="note-card-template">
        <div class="card custom-card" data-card-type="note">
            <div class="card-header">
                <h2 class="text-lg font-semibold card-title">Note</h2>
                <div>
                    <button class="delete-card-btn text-red-500 text-xs mr-2">Delete</button>
                    <span class="drag-handle text-secondary p-2">☰</span>
                </div>
            </div>
            <div class="text-sm card-content whitespace-pre-wrap"></div>
        </div>
    </template>

    <template id="todo-card-template">
        <div class="card custom-card" data-card-type="todo">
            <div class="card-header">
                <h2 class="text-lg font-semibold card-title">To-Do List</h2>
                <div>
                    <button class="delete-card-btn text-red-500 text-xs mr-2">Delete</button>
                    <span class="drag-handle text-secondary p-2">☰</span>
                </div>
            </div>
            <div class="card-content">
                <ul class="todo-list space-y-2 max-h-48 overflow-y-auto mb-3 no-scrollbar"></ul>
                <form class="add-todo-form flex gap-2">
                    <input type="text" placeholder="New task..." class="form-input rounded-md p-2 w-full text-sm" required>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-md text-sm">+</button>
                </form>
            </div>
        </div>
    </template>

    <template id="line-graph-card-template">
        <div class="card custom-card" data-card-type="line-graph">
            <div class="card-header">
                <h2 class="text-lg font-semibold card-title">Graph</h2>
                <div>
                    <button class="toggle-colspan-btn text-secondary text-xs mr-2" title="Toggle size">⤢</button>
                    <button class="delete-card-btn text-red-500 text-xs mr-2">Delete</button>
                    <span class="drag-handle text-secondary p-2">☰</span>
                </div>
            </div>
            <div class="card-content">
                <div class="mb-4 h-64">
                    <canvas class="marks-chart"></canvas>
                </div>
                <form class="add-marks-form flex flex-col sm:flex-row gap-2 mb-3">
                    <input type="text" name="name" placeholder="Paper Name" class="form-input rounded-md p-2 w-full sm:w-auto flex-grow text-sm" required>
                    <input type="number" name="marks" placeholder="Marks" class="form-input rounded-md p-2 w-full sm:w-20 text-sm" required>
                    <input type="number" name="maxMarks" placeholder="Max" class="form-input rounded-md p-2 w-full sm:w-20 text-sm" required>
                    <button type="submit" class="btn-primary font-bold py-2 px-3 rounded-md text-sm">+</button>
                </form>
                <ul class="marks-list space-y-1 max-h-24 overflow-y-auto no-scrollbar"></ul>
            </div>
        </div>
    </template>

    <!-- Modal for adding a new card -->
    <div id="add-card-modal" class="modal-overlay hidden">
        <div class="card w-11/12 max-w-md">
            <h2 class="text-xl font-semibold mb-4">Add New Card</h2>
            <form id="new-card-form">
                <select id="new-card-type" class="form-input rounded-md p-2 w-full mb-3">
                    <option value="note">Note</option>
                    <option value="todo">To-Do List</option>
                    <option value="line-graph">Line Graph</option>
                </select>
                <input type="text" id="new-card-title" placeholder="Card Title" class="form-input rounded-md p-2 w-full mb-3" required>
                <textarea id="new-card-content" placeholder="Card Content (for notes)" rows="4" class="form-input rounded-md p-2 w-full mb-4"></textarea>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-add-card" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                    <button type="submit" class="btn-primary font-bold py-2 px-4 rounded-md">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for customization -->
    <div id="customize-modal" class="modal-overlay hidden">
        <div class="card w-11/12 max-w-md">
            <h2 class="text-xl font-semibold mb-4">Customize Dashboard</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-secondary mb-1">Theme</label>
                    <select id="theme-select" class="form-input rounded-md p-2 w-full">
                        <option value="default">Deep Space</option>
                        <option value="light">Solarized Light</option>
                        <option value="cyberpunk">Cyberpunk</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-secondary mb-1">Font</label>
                    <select id="font-select" class="form-input rounded-md p-2 w-full">
                        <option value="'Inter', sans-serif">Inter (Sans-Serif)</option>
                        <option value="'Roboto Slab', serif">Roboto Slab (Serif)</option>
                        <option value="'Fira Code', monospace">Fira Code (Monospace)</option>
                    </select>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-secondary mb-1">Background Image URL</label>
                    <div class="flex gap-2">
                        <input type="text" id="bg-image-url" placeholder="Paste image URL..." class="form-input rounded-md p-2 w-full">
                        <button id="remove-bg-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md">X</button>
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-customize" class="btn-primary font-bold py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Mobile Alert -->
    <div id="mobile-alert" class="fixed bottom-4 left-4 right-4 bg-yellow-400 text-black p-3 text-center text-sm rounded-lg shadow-lg flex justify-between items-center hidden z-50">
        <span>For the best experience, try this on a desktop.</span>
        <button id="close-alert-btn" class="font-bold text-lg ml-4">&times;</button>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION & STATE ---
        const STORAGE_KEYS = {
            tests: 'jeePartTests_v2',
            layout: 'jeeDashboardLayout_v3',
            customCards: 'jeeCustomCards_v3',
            settings: 'jeeDashboardSettings_v1',
            mobileAlertDismissed: 'jeeMobileAlertDismissed_v1'
        };

        const AppState = {
            tests: JSON.parse(localStorage.getItem(STORAGE_KEYS.tests)) || {},
            customCards: JSON.parse(localStorage.getItem(STORAGE_KEYS.customCards)) || [],
            layout: JSON.parse(localStorage.getItem(STORAGE_KEYS.layout)) || ['countdown', 'graph', 'tests', 'quote'],
            settings: JSON.parse(localStorage.getItem(STORAGE_KEYS.settings)) || { theme: 'default', font: "'Inter', sans-serif", bgUrl: '' },
            chartInstances: {},
            
            save(key) {
                localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(this[key]));
            },
            saveSettings() {
                 localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(this.settings));
            }
        };

        const quotes = [
            { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
            { text: "It’s not whether you get knocked down, it’s whether you get up.", author: "Vince Lombardi" },
            { text: "Success is the sum of small efforts, repeated day in and day out.", author: "Robert Collier" },
            { text: "The expert in anything was once a beginner.", author: "Helen Hayes" },
        ];

        // --- DOM ELEMENTS ---
        const D = {
            body: document.body,
            dashboardGrid: document.getElementById('dashboard-grid'),
            modals: {
                addCard: document.getElementById('add-card-modal'),
                customize: document.getElementById('customize-modal'),
            },
            buttons: {
                addCard: document.getElementById('add-card-btn'),
                cancelAddCard: document.getElementById('cancel-add-card'),
                customize: document.getElementById('customize-btn'),
                closeCustomize: document.getElementById('close-customize'),
                removeBg: document.getElementById('remove-bg-btn'),
                closeAlert: document.getElementById('close-alert-btn'),
            },
            forms: {
                newCard: document.getElementById('new-card-form'),
            },
            inputs: {
                cardType: document.getElementById('new-card-type'),
                cardContent: document.getElementById('new-card-content'),
                theme: document.getElementById('theme-select'),
                font: document.getElementById('font-select'),
                bgUrl: document.getElementById('bg-image-url'),
            },
            mobileAlert: document.getElementById('mobile-alert'),
        };

        // --- CARD TYPE DEFINITIONS ---
        const cardTypes = {
            countdown: {
                templateId: 'countdown-template',
                isDefault: true,
                render: (cardEl) => {
                    const diff = new Date("2026-01-22T00:00:00") - new Date();
                    cardEl.querySelector('[data-value="days"]').innerText = Math.floor(diff / 864e5).toString().padStart(2, '0');
                    cardEl.querySelector('[data-value="hours"]').innerText = Math.floor(diff / 36e5 % 24).toString().padStart(2, '0');
                    cardEl.querySelector('[data-value="minutes"]').innerText = Math.floor(diff / 6e4 % 60).toString().padStart(2, '0');
                    cardEl.querySelector('[data-value="seconds"]').innerText = Math.floor(diff / 1e3 % 60).toString().padStart(2, '0');
                }
            },
            graph: {
                templateId: 'graph-template',
                isDefault: true,
                render: (cardEl) => {
                    const graphContainer = cardEl.querySelector('#contribution-graph');
                    graphContainer.innerHTML = '';
                    const today = new Date(); today.setHours(0, 0, 0, 0);
                    let currentDate = new Date("2025-01-01T00:00:00");
                    const examDay = new Date("2026-01-22T00:00:00"); examDay.setHours(0, 0, 0, 0);
                    
                    while (currentDate <= examDay) {
                        const dayDiv = document.createElement('div');
                        const tooltip = document.createElement('span');
                        const dateString = currentDate.toISOString().slice(0, 10);
                        
                        dayDiv.className = 'day';
                        dayDiv.dataset.date = dateString;
                        tooltip.className = 'tooltip';
                        
                        let typeClass = 'day-future', tooltipText = currentDate.toDateString();
                        if (currentDate < today) typeClass = 'day-past';
                        if (currentDate.getTime() === today.getTime()) { typeClass = 'day-today'; tooltipText += ' - Today'; }
                        if (AppState.tests[dateString]) { typeClass = 'day-part-test'; tooltipText = `${AppState.tests[dateString]} - ${tooltipText}`; }
                        if (currentDate.getTime() === examDay.getTime()) { typeClass = 'day-exam'; tooltipText += ' - Exam!'; }
                        
                        dayDiv.classList.add(typeClass);
                        tooltip.textContent = tooltipText;
                        dayDiv.appendChild(tooltip);
                        graphContainer.appendChild(dayDiv);
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                }
            },
            tests: {
                templateId: 'tests-template',
                isDefault: true,
                render: (cardEl) => {
                    const listEl = cardEl.querySelector('#test-list');
                    listEl.innerHTML = '';
                    const sortedDates = Object.keys(AppState.tests).sort();
                    if (sortedDates.length === 0) {
                        listEl.innerHTML = '<li class="text-secondary px-2 text-sm">No tests scheduled.</li>';
                        return;
                    }
                    sortedDates.forEach(date => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center bg-gray-800 p-2 rounded-md';
                        li.innerHTML = `<div class="flex flex-col"><span class="font-semibold text-sm">${AppState.tests[date]}</span><span class="text-xs text-secondary">${new Date(date + 'T00:00:00').toDateString()}</span></div><button data-date="${date}" class="delete-test-btn text-red-500 hover:text-red-400 font-semibold text-xs">Delete</button>`;
                        listEl.appendChild(li);
                    });
                }
            },
            quote: {
                templateId: 'quote-template',
                isDefault: true,
                render: (cardEl) => {
                    const { text, author } = quotes[Math.floor(Math.random() * quotes.length)];
                    cardEl.querySelector('#quote').textContent = `"${text}"`;
                    cardEl.querySelector('#author').textContent = `- ${author}`;
                }
            },
            note: {
                templateId: 'note-card-template',
                render: (cardEl, cardData) => {
                    cardEl.querySelector('.card-content').textContent = cardData.content;
                }
            },
            todo: {
                templateId: 'todo-card-template',
                render: (cardEl, cardData) => {
                    const listEl = cardEl.querySelector('.todo-list');
                    listEl.innerHTML = '';
                    if (Array.isArray(cardData.content)) {
                        cardData.content.forEach((item, index) => {
                            const li = document.createElement('li');
                            li.className = `flex items-center gap-2 todo-item ${item.completed ? 'completed' : ''}`;
                            li.dataset.index = index;
                            li.innerHTML = `<input type="checkbox" ${item.completed ? 'checked' : ''} class="todo-checkbox bg-gray-900 rounded"><span class="flex-grow text-sm">${item.text}</span><button class="delete-todo-item text-red-500 hover:text-red-400 font-semibold text-xs">×</button>`;
                            listEl.appendChild(li);
                        });
                    }
                }
            },
            'line-graph': {
                templateId: 'line-graph-card-template',
                render: (cardEl, cardData) => {
                    const listEl = cardEl.querySelector('.marks-list');
                    listEl.innerHTML = '';
                    
                    cardData.content.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center text-xs bg-gray-800 p-1 rounded';
                        li.innerHTML = `<span>${item.name}: <strong>${item.marks} / ${item.maxMarks}</strong></span><button data-index="${index}" class="delete-mark-item text-red-500 px-1">×</button>`;
                        listEl.appendChild(li);
                    });

                    const ctx = cardEl.querySelector('.marks-chart').getContext('2d');
                    if (AppState.chartInstances[cardData.id]) {
                        AppState.chartInstances[cardData.id].destroy();
                    }
                    
                    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
                    const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
                    const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                    
                    const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
                    gradient.addColorStop(0, `${accentColor}40`);
                    gradient.addColorStop(1, `${accentColor}00`);

                    const maxMarkValue = cardData.content.length > 0 ? Math.max(...cardData.content.map(d => d.maxMarks || 0)) : 300;

                    AppState.chartInstances[cardData.id] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: cardData.content.map(d => d.name),
                            datasets: [{
                                label: 'Marks',
                                data: cardData.content.map(d => d.marks),
                                borderColor: accentColor,
                                backgroundColor: gradient,
                                fill: true,
                                tension: 0.3,
                                pointBackgroundColor: accentColor,
                                pointBorderColor: 'var(--card-bg-color)',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: accentColor,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, max: maxMarkValue, ticks: { color: textColor }, grid: { color: gridColor } },
                                x: { ticks: { color: textColor }, grid: { color: 'transparent' } }
                            }
                        }
                    });
                }
            }
        };

        // --- CORE FUNCTIONS ---
        function renderDashboard() {
            Object.values(AppState.chartInstances).forEach(chart => chart.destroy());
            AppState.chartInstances = {};
            D.dashboardGrid.innerHTML = '';
            
            const customCardIds = AppState.customCards.map(c => c.id);
            AppState.layout = AppState.layout.filter(id => cardTypes[id]?.isDefault || customCardIds.includes(id));
            AppState.customCards.forEach(card => {
                if (!AppState.layout.includes(card.id)) AppState.layout.push(card.id);
            });
            AppState.save('layout');

            AppState.layout.forEach(cardId => {
                const cardData = AppState.customCards.find(c => c.id === cardId);
                const type = cardData ? cardData.type : cardId;
                const cardDef = cardTypes[type];
                if (cardDef) {
                    const template = document.getElementById(cardDef.templateId);
                    const cardNode = template.content.cloneNode(true);
                    const cardEl = cardNode.querySelector('.card');
                    cardEl.dataset.cardId = cardId;
                    if (cardData) {
                        cardEl.querySelector('.card-title').textContent = cardData.title;
                        if (cardData.colspan === 2) {
                            cardEl.classList.add('md:col-span-2');
                        }
                    }
                    D.dashboardGrid.appendChild(cardNode);
                }
            });

            D.dashboardGrid.querySelectorAll('.card').forEach(cardEl => {
                const cardId = cardEl.dataset.cardId;
                const cardData = AppState.customCards.find(c => c.id === cardId);
                const type = cardData ? cardData.type : cardId;
                const cardDef = cardTypes[type];
                if (cardDef) {
                    cardDef.render(cardEl, cardData);
                }
            });
        }

        function applySettings() {
            document.documentElement.dataset.theme = AppState.settings.theme;
            D.body.style.fontFamily = AppState.settings.font;
            D.body.style.backgroundImage = AppState.settings.bgUrl ? `url(${AppState.settings.bgUrl})` : 'none';
            D.inputs.theme.value = AppState.settings.theme;
            D.inputs.font.value = AppState.settings.font;
            D.inputs.bgUrl.value = AppState.settings.bgUrl;
        }

        // --- EVENT HANDLERS (DELEGATED) ---
        D.dashboardGrid.addEventListener('click', (e) => {
            const cardEl = e.target.closest('.card');
            if (!cardEl) return;
            const cardId = cardEl.dataset.cardId;

            if (cardId === 'quote') cardTypes.quote.render(cardEl);

            if (e.target.classList.contains('delete-test-btn')) {
                delete AppState.tests[e.target.dataset.date];
                AppState.save('tests');
                renderDashboard();
            }
            if (e.target.classList.contains('day')) {
                const dateString = e.target.dataset.date;
                if (AppState.tests[dateString]) {
                    delete AppState.tests[dateString];
                    AppState.save('tests');
                    renderDashboard();
                } else {
                    const testForm = D.dashboardGrid.querySelector('#add-test-form');
                    if(testForm) {
                        testForm.date.value = dateString;
                        testForm.name.focus();
                    }
                }
            }

            const cardData = AppState.customCards.find(c => c.id === cardId);
            if (!cardData) return;

            if (e.target.classList.contains('delete-card-btn')) {
                AppState.customCards = AppState.customCards.filter(c => c.id !== cardId);
                AppState.save('customCards');
                renderDashboard();
            }
            if (e.target.classList.contains('toggle-colspan-btn')) {
                cardData.colspan = cardData.colspan === 2 ? 1 : 2;
                AppState.save('customCards');
                renderDashboard();
            }
            if (cardData.type === 'todo') {
                const itemEl = e.target.closest('.todo-item');
                if (itemEl) {
                    const itemIndex = parseInt(itemEl.dataset.index);
                    if (e.target.classList.contains('delete-todo-item')) {
                        cardData.content.splice(itemIndex, 1);
                    } else if (e.target.classList.contains('todo-checkbox')) {
                        cardData.content[itemIndex].completed = !cardData.content[itemIndex].completed;
                    }
                    AppState.save('customCards');
                    cardTypes.todo.render(cardEl, cardData);
                }
            }
             if (cardData.type === 'line-graph' && e.target.classList.contains('delete-mark-item')) {
                const itemIndex = parseInt(e.target.dataset.index);
                cardData.content.splice(itemIndex, 1);
                AppState.save('customCards');
                cardTypes['line-graph'].render(cardEl, cardData);
            }
        });

        D.dashboardGrid.addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const cardEl = form.closest('.card');
            const cardId = cardEl.dataset.cardId;

            if (form.id === 'add-test-form') {
                const { date, name } = form.elements;
                if (date.value && name.value.trim()) {
                    AppState.tests[date.value] = name.value.trim();
                    AppState.save('tests');
                    renderDashboard();
                    form.reset();
                }
            } else if (form.classList.contains('add-todo-form')) {
                const card = AppState.customCards.find(c => c.id === cardId);
                const input = form.querySelector('input');
                if (card && input.value.trim()) {
                    card.content.push({ text: input.value.trim(), completed: false });
                    AppState.save('customCards');
                    cardTypes.todo.render(cardEl, card);
                    input.value = '';
                }
            } else if (form.classList.contains('add-marks-form')) {
                const card = AppState.customCards.find(c => c.id === cardId);
                const { name, marks, maxMarks } = form.elements;
                if (card && name.value.trim() && marks.value && maxMarks.value) {
                    card.content.push({ 
                        name: name.value.trim(), 
                        marks: parseFloat(marks.value),
                        maxMarks: parseFloat(maxMarks.value)
                    });
                    AppState.save('customCards');
                    cardTypes['line-graph'].render(cardEl, card);
                    form.reset();
                }
            }
        });

        // --- MODAL & SETTINGS LISTENERS ---
        D.buttons.addCard.addEventListener('click', () => D.modals.addCard.classList.remove('hidden'));
        D.buttons.cancelAddCard.addEventListener('click', () => D.modals.addCard.classList.add('hidden'));
        D.inputs.cardType.addEventListener('change', (e) => {
            D.inputs.cardContent.style.display = e.target.value === 'note' ? 'block' : 'none';
        });

        D.forms.newCard.addEventListener('submit', (e) => {
            e.preventDefault();
            const type = D.inputs.cardType.value;
            const title = D.forms.newCard.querySelector('input[type="text"]').value.trim();
            if (!title) return;
            
            AppState.customCards.push({
                id: `custom-${Date.now()}`,
                type,
                title,
                content: type === 'note' ? D.inputs.cardContent.value.trim() : [],
                colspan: type === 'line-graph' ? 2 : 1
            });
            AppState.save('customCards');
            renderDashboard();
            D.modals.addCard.classList.add('hidden');
            D.forms.newCard.reset();
            D.inputs.cardContent.style.display = 'block';
        });

        D.buttons.customize.addEventListener('click', () => D.modals.customize.classList.remove('hidden'));
        D.buttons.closeCustomize.addEventListener('click', () => D.modals.customize.classList.add('hidden'));

        D.inputs.theme.addEventListener('change', () => { AppState.settings.theme = D.inputs.theme.value; AppState.saveSettings(); applySettings(); renderDashboard(); });
        D.inputs.font.addEventListener('change', () => { AppState.settings.font = D.inputs.font.value; AppState.saveSettings(); applySettings(); });
        D.inputs.bgUrl.addEventListener('input', () => { AppState.settings.bgUrl = D.inputs.bgUrl.value; AppState.saveSettings(); applySettings(); });
        D.buttons.removeBg.addEventListener('click', () => { AppState.settings.bgUrl = ''; AppState.saveSettings(); applySettings(); });
        
        // --- MOBILE ALERT ---
        if (window.innerWidth < 768 && localStorage.getItem(STORAGE_KEYS.mobileAlertDismissed) !== 'true') {
            D.mobileAlert.classList.remove('hidden');
        }
        D.buttons.closeAlert.addEventListener('click', () => {
            D.mobileAlert.classList.add('hidden');
            localStorage.setItem(STORAGE_KEYS.mobileAlertDismissed, 'true');
        });

        // --- INITIALIZATION ---
        applySettings();
        renderDashboard();
        new Sortable(D.dashboardGrid, {
            animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen',
            onEnd: () => {
                AppState.layout = [...D.dashboardGrid.children].map(item => item.dataset.cardId);
                AppState.save('layout');
            },
        });
        setInterval(() => {
            const countdownCard = D.dashboardGrid.querySelector('[data-card-id="countdown"]');
            if (countdownCard) cardTypes.countdown.render(countdownCard);
        }, 1000);
    });
    </script>
</body>
</html>
